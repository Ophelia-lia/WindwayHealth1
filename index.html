<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WindWay‚òÉÔ∏è</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-text: #000000;
            --ios-gray: #8E8E93;
            --ios-border: #C6C6C8;
            --ios-segmented-bg: #E9E9EB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--ios-bg);
            color: var(--ios-text);
            line-height: 1.5;
            padding-top: 60px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 16px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: #1C1C1E;
            padding: 12px 0;
            border-bottom: 0.5px solid var(--ios-border);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
        }

        h1 {
            font-size: 17px;
            font-weight: 600;
            color: #1C1C1E;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .nav-tabs { display: none !important; }

        .page {
            display: none;
            background: var(--ios-card);
            border-radius: 12px;
            padding: 16px;
        }

        .page.active { display: block; }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 16px 0;
            background: var(--ios-card);
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 0.5px solid #F2F2F7;
        }

        th {
            background-color: #FAFAFA;
            font-weight: 500;
            font-size: 13px;
            color: var(--ios-gray);
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #FAFAFA; cursor: pointer; }
        tr.selected { background-color: #F5F5F5; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: opacity 0.2s;
        }

        .btn:hover { opacity: 0.8; }
        .btn-primary { background-color: var(--ios-blue); color: white; }
        .btn-secondary { background-color: #E5E5EA; color: #1C1C1E; }
        .btn-success { background-color: var(--ios-green); color: white; }
        .btn-danger { background-color: var(--ios-red); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .add-record-btn { background-color: var(--ios-blue); color: white; font-weight: 500; }

        .form-group { margin-bottom: 16px; }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--ios-gray);
            font-size: 13px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 0.5px solid var(--ios-border);
            border-radius: 10px;
            font-size: 16px;
            background-color: #FAFAFA;
            color: var(--ios-text);
        }
        
        /* Âè™ËØªÊ®°ÂºèÊ†∑Âºè - ÈªëËâ≤ÊñáÂ≠óÊ∏ÖÊô∞ÂèØËØª */
        input[readonly], select[disabled], textarea[readonly] {
            background-color: #FAFAFA;
            color: #1C1C1E;
            cursor: not-allowed;
        }

        input:focus, select:focus, textarea:focus {
            background-color: #FFFFFF;
            outline: none;
            border-color: var(--ios-blue);
        }
        input[type="date"], input[type="number"] { color: var(--ios-blue); }

        .search-filter {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .search-box, .filter-box { flex: 1; min-width: 150px; }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 16px;
            gap: 8px;
        }

        .page-btn {
            padding: 8px 14px;
            border: none;
            background: #E5E5EA;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            color: #1C1C1E;
        }

        .page-btn.active { background-color: var(--ios-blue); color: white; }

        .tab-container { margin-top: 0; }

        .tab-header {
            display: flex;
            background: var(--ios-segmented-bg);
            border-radius: 10px;
            padding: 3px;
            position: sticky;
            top: 60px;
            z-index: 998;
            margin-bottom: 16px;
        }

        .tab {
            flex: 1;
            padding: 10px 16px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #1C1C1E;
            text-align: center;
            min-width: fit-content;
        }

        .tab.active {
            background: var(--ios-card);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-content { padding: 16px 0; display: none; }
        .tab-content.active { display: block; }

        .header-icons {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
            z-index: 1001;
        }

        .header-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--ios-blue);
            cursor: pointer;
            border-radius: 8px;
        }

        .header-icon:hover { background-color: #F5F5F5; }
        .header-icon.save-action:hover { color: var(--ios-green); }
        .header-icon.close-action:hover { color: var(--ios-red); }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        /* ÂàÜÁ±ªÁºñËæëÁ™óÂè£ - ËæÉ‰ΩéÂ±ÇÁ∫ß */
        #categoryEditModal {
            z-index: 1000;
        }

        /* ÂÖ∑‰ΩìÊåáÊ†áÁºñËæëÁ™óÂè£ - Êõ¥È´òÂ±ÇÁ∫ßÔºåÊòæÁ§∫Âú®ÂàÜÁ±ªÁºñËæëÁ™óÂè£‰∏äÈù¢ */
        #indicatorModal,
        #editIndicatorModal {
            z-index: 1100;
        }

        .modal-content {
            background: var(--ios-card);
            border-radius: 14px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 0.5px solid #F2F2F7;
            background: #FAFAFA;
            border-radius: 14px 14px 0 0;
        }

        .modal-header h3 { font-size: 17px; font-weight: 600; }
        .modal-body { padding: 20px; }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--ios-gray);
            line-height: 1;
        }

        .close-modal:hover { color: var(--ios-red); }

        /* ========== ÁºñËæëÁ™óÂè£Ê†∑Âºè ========== */
        .edit-modal-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 16px 0;
        }

        .edit-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #FAFAFA;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: move;
        }

        .edit-list-item:hover {
            background: #F0F0F0;
        }

        .edit-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #C6C6C8;
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
        }

        .edit-checkbox.checked {
            background: var(--ios-blue);
            border-color: var(--ios-blue);
            position: relative;
        }

        .edit-checkbox.checked::after {
            content: '‚úì';
            position: absolute;
            color: white;
            font-size: 14px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .edit-item-content {
            flex: 1;
            font-size: 15px;
            color: #1C1C1E;
            cursor: pointer;
        }

        .edit-drag-handle {
            color: #C6C6C8;
            font-size: 20px;
            cursor: move;
            flex-shrink: 0;
        }

        .edit-item-content .item-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .edit-item-content .item-detail {
            font-size: 13px;
            color: #8E8E93;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            border-top: 0.5px solid #F2F2F7;
            background: #FAFAFA;
        }

        .modal-footer button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-cancel {
            background: #F2F2F7;
            border: none;
            color: #1C1C1E;
        }

        .btn-save {
            background: var(--ios-blue);
            border: none;
            color: white;
        }

        .btn-delete {
            background: var(--ios-red);
            border: none;
            color: white;
            flex: 0.5;
        }

        .edit-icon {
            color: #007AFF;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            margin: 0 8px 0 0;
        }

        .edit-icon:active {
            opacity: 0.7;
        }

        .readonly-table {
            pointer-events: none;
        }

        .readonly-table input,
        .readonly-table select,
        .readonly-table textarea {
            background: transparent;
            border: none;
            cursor: default;
        }

        .save-notification {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1001;
            font-size: 15px;
        }

        .save-notification.show { opacity: 1; }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 0.5px solid #F2F2F7;
        }

        .three-column-form {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .full-width { grid-column: 1 / -1; }

        .collapse-panel {
            margin-bottom: 12px;
            background: var(--ios-card);
            border-radius: 12px;
            overflow: hidden;
            border: 0.5px solid #F2F2F7;
        }

        .collapse-header {
            padding: 14px 16px;
            background-color: #FAFAFA;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 15px;
        }

        .collapse-content { padding: 16px; display: none; border-top: 0.5px solid #F2F2F7; }
        .collapse-content.active { display: block; }
        .collapse-icon { color: var(--ios-gray); transition: transform 0.3s ease; }
        .collapse-panel.active .collapse-icon { transform: rotate(180deg); }
        .history-collapse-content {
            background: rgba(255, 255, 255, 0.4);
        }

        .history-collapse-panel.collapsed .history-collapse-content {
            display: none;
        }

        .history-collapse-panel {
            margin-bottom: 12px;
            background: var(--ios-card);
            border-radius: 12px;
            overflow: hidden;
            border: 0.5px solid #F2F2F7;
        }

        .history-collapse-header {
            padding: 14px 16px;
            background-color: #FAFAFA;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 15px;
        }

        .history-collapse-header:active {
            background-color: #F0F0F0;
        }

        .history-collapse-icon {
            color: var(--ios-gray);
        }

        .history-collapse-panel.collapsed .history-collapse-icon {
            transform: rotate(-90deg);
        }
        
        /* ‰∏™‰∫∫‰ø°ÊÅØÂç°ÁâáÂ∑¶‰æßËâ≤Êù°È¢úËâ≤ */
        .history-collapse-panel.has-data.color-orange {
            border-left: 3px solid #FF9500;
        }
        .history-collapse-panel.has-data.color-red {
            border-left: 3px solid #FF3B30;
        }
        .history-collapse-panel.has-data.color-purple {
            border-left: 3px solid #AF52DE;
        }
        .history-collapse-panel.has-data.color-pink {
            border-left: 3px solid #FF2D55;
        }
        .history-collapse-panel.has-data.color-cyan {
            border-left: 3px solid #5AC8FA;
        }
        .history-collapse-panel.has-data.color-green {
            border-left: 3px solid #34C759;
        }
        .history-collapse-panel.has-data.color-indigo {
            border-left: 3px solid #5856D6;
        }
        .history-collapse-panel.has-data.color-blue {
            border-left: 3px solid #007AFF;
        }
        
        /* ÁÆÄÊ¥ÅÂç°ÁâáÊ†∑Âºè - Á∫ØÁôΩËÉåÊôØ+ÊµÖÁÅ∞ËæπÊ°Ü+ËΩªÂæÆÈò¥ÂΩ± */
        .modern-card {
            background: #FFFFFF;
            border: 1px solid #E5E5EA;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }
        
        .modern-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* modern-cardÊúâÊï∞ÊçÆÊó∂ÔºöÊ∑ªÂä†Â∑¶‰æßËâ≤Êù° */
        .modern-card.has-data {
            border-left: 3px solid #007AFF;
        }
        
        /* modern-card‰∏çÂêåÈ¢úËâ≤ÁöÑÂ∑¶‰æßËâ≤Êù° */
        .modern-card.has-data.color-blue {
            border-left: 3px solid #007AFF;
        }

        /* modern-cardÊúâÊï∞ÊçÆÊó∂ÔºöÊ†áÈ¢ò„ÄÅÂõæÊ†á„ÄÅËÆ°Êï∞Âèò‰∏∫ËìùËâ≤ */
        .modern-card.has-data .modern-card-title {
            color: #007AFF;
        }

        .modern-card.has-data .modern-card-icon {
            color: #007AFF;
        }

        .modern-card.has-data .record-count {
            color: #007AFF;
        }
        
        /* ÂúÜÁÇπÊ†∑Âºè - Áî®‰∫éÂàÜÁ±ªÊ†áËØÜ */
        .category-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        /* Á©∫ÂøÉÂúÜÁÇπÊ†∑Âºè - Áî®‰∫éÂ≠êÂàÜÁ±ª */
        .category-dot-hollow {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid;
            background: transparent;
            margin-right: 8px;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .modern-card-header {
            background: #F8F8F8;
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #E5E5EA;
        }

        .modern-card-header:active {
            background: #F0F0F0;
        }

        .modern-card-title {
            font-size: 15px;
            font-weight: 600;
            color: #1C1C1E;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modern-card-icon {
            color: #007AFF;
            font-size: 18px;
        }

        .modern-card-toggle {
            color: #007AFF;
            font-size: 14px;
        }

        .modern-card.collapsed .modern-card-toggle {
            transform: rotate(-90deg);
        }

        .modern-card-content {
            background: #FFFFFF;
        }

        .modern-card.collapsed .modern-card-content {
            display: none;
        }

        .modern-card-body {
            padding: 16px;
        }

        /* Êõ¥Êñ∞ÂéüÊúâÁöÑhistory-collapse-panelÊ†∑Âºè */
        .history-collapse-panel {
            background: #FAFAFA;
            border: 1px solid #E5E5EA;
            border-left: 3px solid #E5E5EA;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* ÊúâÊï∞ÊçÆÊó∂ÔºöÊ†áÈ¢ò„ÄÅËÆ°Êï∞Âèò‰∏∫ËìùËâ≤ÔºåÂ∑¶ËæπÊ°ÜÂèò‰∏∫ËìùËâ≤ */
        .history-collapse-panel.has-data {
            border-left: 3px solid #007AFF;
        }

        .history-collapse-panel.has-data .history-collapse-header {
            color: #007AFF;
        }

        .history-collapse-panel.has-data .record-count {
            color: #007AFF;
        }

        .history-collapse-header {
            background: #F8F8F8;
            padding: 14px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 15px;
            border-bottom: 1px solid #E5E5EA;
            transition: color 0.3s ease;
        }

        .record-count {
            color: #8E8E93;
            font-size: 14px;
            font-weight: 500;
            margin-left: 6px;
            transition: color 0.3s ease;
        }

        .history-collapse-header:hover {
            background: #F0F0F0;
        }

        .history-collapse-icon {
            color: #007AFF;
            transition: transform 0.2s ease;
        }

        .history-collapse-content {
            background: #FFFFFF;
        }

        .period-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: center;
        }

        .period-selector select { flex: 1; max-width: 300px; }

        .add-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            color: var(--ios-blue);
            font-size: 20px;
            cursor: pointer;
            margin-left: 8px;
            border-radius: 6px;
        }

        .add-icon:hover { background-color: #F5F5F5; }

        .title-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .dropdown { position: relative; display: inline-block; }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 180px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1;
            border-radius: 12px;
            overflow: hidden;
        }

        .dropdown-content button {
            width: 100%;
            padding: 14px 16px;
            text-align: left;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 15px;
            border-bottom: 0.5px solid #F2F2F7;
        }

        .dropdown-content button:last-child { border-bottom: none; }
        .dropdown-content button:hover { background-color: #FAFAFA; }
        .dropdown:hover .dropdown-content { display: block; }

        /* Ê£ÄÊµãÊä•ÂëäTab‰∏ìÁî®Ê†∑Âºè */
        .report-tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
        }

        .report-tab-header h2 {
            font-size: 17px;
            font-weight: 600;
        }

        .edit-btn {
            font-size: 17px;
            color: var(--ios-blue);
            cursor: pointer;
            font-weight: 400;
            padding: 5px 10px;
        }

        .cancel-btn {
            font-size: 17px;
            color: var(--ios-red);
            cursor: pointer;
            font-weight: 400;
            padding: 5px 10px;
        }

        .segmented-control {
            display: flex;
            background: var(--ios-segmented-bg);
            border-radius: 8px;
            padding: 2px;
            margin: 10px 0;
        }

        .segment {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 7px;
        }

        .segment.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .report-card {
            background: var(--ios-card);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: visible;
            border: 1px solid #E5E5EA;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .report-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .report-card.selected { background: #F8F8F8; }
        .report-card.dragging { opacity: 0.5; }
        .report-card.drag-over { border: 2px dashed var(--ios-blue); }

        .report-header {
            padding: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            background: var(--ios-card);
            border-radius: 12px 12px 0 0;
        }

        .selection-circle {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--ios-gray);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selection-circle.selected {
            border-color: var(--ios-red);
            background-color: var(--ios-red);
        }

        .selection-circle.selected::after {
            content: "‚úì";
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .drag-handle-report {
            margin-left: auto;
            padding: 0 8px;
            cursor: move;
            color: var(--ios-gray);
            font-size: 18px;
            opacity: 0.6;
        }

        .report-info { flex: 1; }
        .report-info div:first-child { font-weight: 600; font-size: 16px; margin-bottom: 2px; }
        .report-info div:last-child { font-size: 13px; color: var(--ios-gray); }

        .report-content {
            display: none;
            padding: 10px;
            background: #FAFAFA;
            border-radius: 0 0 12px 12px;
            margin-top: -1px;
        }
        .report-content.active { display: block; }

        .category-group-header {
            background: #F9F9F9;
            padding: 10px 15px;
            font-size: 13px;
            font-weight: 600;
            color: var(--ios-gray);
            display: flex;
            justify-content: space-between;
            border-bottom: 0.5px solid #EEE;
            cursor: pointer;
        }

        .category-group-header .toggle-icon { transition: transform 0.3s ease; }
        .category-group-header.collapsed .toggle-icon { transform: rotate(-90deg); }

        /* Â≠êÂàÜÁ±ªÊ†∑Âºè */
        .subcategory-header {
            background: rgba(0, 0, 0, 0.02);
            padding: 8px 15px;
            font-size: 12px;
            font-weight: 500;
            color: var(--ios-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #F5F5F5;
            border-bottom: 0.5px solid #F5F5F5;
            cursor: pointer;
            padding-left: 24px;
        }

        .subcategory-header:hover {
            background: rgba(0, 0, 0, 0.04);
        }

        .subcategory-toggle {
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .subcategory-header.collapsed .subcategory-toggle {
            transform: rotate(-90deg);
        }

        .subcategory-count {
            font-size: 12px;
            margin-left: 6px;
        }

        .subcategory-count.has-abnormal {
            color: var(--ios-red);
        }

        .subcategory-content {
            display: block;
        }

        .subcategory-header.collapsed + .subcategory-content {
            display: none;
        }

        .report-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .report-table td { padding: 12px 15px; border-bottom: 0.5px solid #F2F2F7; }
        .report-table tr:last-child td { border-bottom: none; }
        .abnormal { color: var(--ios-red); font-weight: 600; }
        
        .icon-btn { opacity: 0.6; padding: 0 5px; cursor: pointer; }
        .edit-icon-btn { color: var(--ios-blue); margin-right: 5px; }

        .add-indicator-btn-container { display: flex; gap: 10px; margin: 15px; }

        .add-indicator-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: 0.5px solid var(--ios-blue);
            border-radius: 8px;
            color: var(--ios-blue);
            font-size: 13px;
            cursor: pointer;
        }

        .import-indicator-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: 0.5px solid var(--ios-gray);
            border-radius: 8px;
            color: var(--ios-gray);
            font-size: 13px;
            cursor: pointer;
        }

        .action-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 10px 20px 20px;
            border-top: 0.5px solid var(--ios-border);
            display: none;
            z-index: 100;
        }

        .action-buttons-container { display: flex; width: 100%; gap: 10px; }

        .action-btn {
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            border: none;
        }

        .add-action { background: var(--ios-green); color: white; }
        .edit-action { background: var(--ios-blue); color: white; }
        .delete-action { background: var(--ios-red); color: white; }

        /* ÊéíÂ∫èÁÆ≠Â§¥Ê†∑Âºè - ÈöêÁßòÊµÖÁÅ∞Ëâ≤ */
        .sort-arrow {
            display: inline-block;
            margin-left: 4px;
            font-size: 10px;
            color: #D1D1D6;
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
            user-select: none;
        }

        th:hover .sort-arrow {
            opacity: 1;
        }

        .sort-arrow.active {
            opacity: 1;
            color: #8E8E93;
        }

        /* Êñ∞Â¢ûÔºöË°®Ê†ºË°åÊãñÊãΩÊ†∑Âºè */

        /* ‰∏ä‰∏ãÁßªÂä®ÊåâÈíÆÊ†∑Âºè */
        /* ÁßªÂä®Á´ØÈÄÇÈÖç (6.7Ëã±ÂØ∏ Á∫¶430px) */
        @media (max-width: 430px) {
            body {
                padding-top: 56px;
            }

            h1 {
                font-size: 15px;
            }

            .header-actions {
                flex-wrap: wrap;
                justify-content: flex-end;
            }

            .btn, .btn-sm {
                font-size: 13px;
                padding: 6px 10px;
            }

            table {
                font-size: 13px;
            }

            th, td {
                padding: 8px 6px;
            }

            .tab {
                font-size: 13px;
                padding: 8px 12px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Èò≤Ê≠¢iOSËá™Âä®Áº©Êîæ */
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
            }

            }

        /* ========== ÁôªÂΩïÁïåÈù¢Ê†∑Âºè (iOS ÂéüÁîüÈ£éÊ†º) ========== */
        #loginPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #F2F2F7;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #loginPage.hidden {
            display: none;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 0;
            width: 90%;
            max-width: 380px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .login-header {
            text-align: center;
            padding: 40px 24px 24px;
            background: white;
        }

        .login-logo {
            font-size: 56px;
            margin-bottom: 16px;
        }

        .login-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1C1C1E;
            margin: 0 0 8px 0;
        }

        .login-header p {
            font-size: 15px;
            color: #8E8E93;
            margin: 0;
        }

        .login-form {
            padding: 0 24px 32px;
        }

        .login-input-group {
            margin-bottom: 16px;
        }

        .login-input-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #8E8E93;
            margin-bottom: 8px;
            padding-left: 4px;
        }

        .login-input-group input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #E5E5EA;
            border-radius: 12px;
            font-size: 17px;
            background: #FAFAFA;
            color: #1C1C1E;
            transition: all 0.2s;
            -webkit-appearance: none;
        }

        .login-input-group input:focus {
            border-color: #007AFF;
            background: white;
            outline: none;
        }

        .login-input-group input::placeholder {
            color: #C6C6C8;
        }

        .login-error {
            color: #FF3B30;
            font-size: 13px;
            text-align: center;
            margin: -8px 0 16px 0;
            display: none;
            padding: 0 4px;
        }

        .login-error.show {
            display: block;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-appearance: none;
        }

        .login-btn:active {
            background: #0051D5;
            transform: scale(0.98);
        }

        /* ÁßªÂä®Á´ØÂìçÂ∫îÂºèÈÄÇÈÖç - iPhone 13 Pro MaxÂèäÂÖ∂‰ªñÁßªÂä®ËÆæÂ§á */
        @media only screen and (max-width: 428px) {

            .container {
                padding: 12px;
            }

            header {
                padding: 8px 0;
            }

            .header-content {
                padding: 0 12px;
            }

            h1 {
                font-size: 16px;
            }

            .header-actions {
                gap: 4px;
            }

            .header-actions .btn {
                padding: 4px 6px;
                font-size: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 2px;
                min-width: 45px;
                line-height: 1.2;
            }

            #exportDataBtn::before { content: "‚¨ÜÔ∏è\A Êï∞ÊçÆ"; font-size: 16px; white-space: pre; text-align: center; }
            #exportWordBtn::before { content: "üìÑ\A Word"; font-size: 16px; white-space: pre; text-align: center; }
            #exportExcelBtn::before { content: "üî¨\A Ê£ÄÊµã"; font-size: 16px; white-space: pre; text-align: center; }
            #exportFullExcelBtn::before { content: "üìä\A Excel"; font-size: 16px; white-space: pre; text-align: center; }
            #importDataBtn::before { content: "üì•\A ÂØºÂÖ•"; font-size: 16px; white-space: pre; text-align: center; }

            #exportDataBtn::before,
            #exportWordBtn::before,
            #exportExcelBtn::before,
            #exportFullExcelBtn::before,
            #importDataBtn::before {
                font-size: 16px;
                line-height: 1.3;
            }

            #exportDataBtn::after { content: ""; font-size: 9px; }
            #exportWordBtn::after { content: ""; font-size: 9px; }
            #exportExcelBtn::after { content: ""; font-size: 9px; }
            #exportFullExcelBtn::after { content: ""; font-size: 9px; }
            #importDataBtn::after { content: ""; font-size: 9px; }

            body {
                padding-top: 85px;
            }

            .btn-sm {
                padding: 4px 10px;
                font-size: 12px;
            }

            table {
                font-size: 13px;
                margin: 12px 0;
            }

            th, td {
                padding: 8px 10px;
                font-size: 12px;
            }

            th {
                font-size: 11px;
            }

            input, select, textarea {
                padding: 10px 12px;
                font-size: 14px;
            }

            label {
                font-size: 12px;
                margin-bottom: 4px;
            }

            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 10% auto;
                border-radius: 12px;
            }

            .modal-header h3 {
                font-size: 16px;
            }

            .modal-body {
                padding: 16px;
            }

            .modal-footer {
                padding: 12px 16px;
            }

            .search-filter {
                flex-direction: column;
                gap: 8px;
            }

            .search-box, .filter-box {
                min-width: 100%;
            }

            .button-group {
                flex-wrap: wrap;
                gap: 8px;
            }

            .button-group button {
                flex: 1;
                min-width: calc(50% - 4px);
            }

            .pagination {
                gap: 6px;
                flex-wrap: wrap;
            }

            .page-btn {
                padding: 6px 10px;
                font-size: 13px;
            }

            .customer-info-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .period-card {
                padding: 12px;
            }

            .record-item {
                padding: 10px;
                font-size: 13px;
            }

            .indicator-card {
                padding: 10px;
            }

            .status-badge {
                padding: 3px 8px;
                font-size: 11px;
            }
        }

        /* Âπ≥ÊùøÂíå‰∏≠Á≠âÂ±èÂπïÈÄÇÈÖç */
        @media only screen and (min-width: 429px) and (max-width: 1024px) {
            .container {
                max-width: 95%;
                padding: 20px;
            }

            .modal-content {
                width: 85%;
                max-width: 700px;
            }

            table {
                font-size: 14px;
            }
        }

        /* Â§ßÂ±èÂπï‰ºòÂåñ */
        @media only screen and (min-width: 1025px) {
            .container {
                max-width: 1400px;
            }

            .modal-content {
                max-width: 800px;
            }
        }

        /* Ëß¶Êë∏ËÆæÂ§á‰ºòÂåñ */
        @media (hover: none) and (pointer: coarse) {
            .btn, button, a, input[type="checkbox"] {
                min-height: 44px;
                min-width: 44px;
            }

            .close-modal {
                min-width: 44px;
                min-height: 44px;
            }

            tr:hover {
                background-color: transparent;
            }

            tr:active {
                background-color: #FAFAFA;
            }
        }

    </style>
</head>
<body>
    <!-- ÁôªÂΩïÈ°µÈù¢ -->
    <div id="loginPage">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">‚òÉÔ∏è</div>
                <h2>WindWay</h2>
                <p>WindWay‚òÉÔ∏è Health</p>
            </div>
            <form class="login-form" onsubmit="Auth.login(event)">
                <div class="login-input-group">
                    <label>Áî®Êà∑Âêç</label>
                    <input type="text" id="loginUsername" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" required autocomplete="username">
                </div>
                <div class="login-input-group">
                    <label>ÂØÜÁ†Å</label>
                    <input type="password" id="loginPassword" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required autocomplete="current-password">
                </div>
                <div class="login-error" id="loginError">Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ</div>
                <button type="submit" class="login-btn">ÁôªÂΩï</button>
            </form>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-content">
                <h1>WindWay‚òÉÔ∏è Health</h1>
                <div class="header-actions">
                    <button id="exportDataBtn" class="btn btn-primary">ÂØºÂá∫Êï∞ÊçÆ</button>
                    <button id="exportWordBtn" class="btn btn-secondary">ÂØºÂá∫Word</button>
                    <button id="exportExcelBtn" class="btn btn-success">ÂØºÂá∫Ê£ÄÊµãËÆ∞ÂΩï</button>
                    <button id="exportFullExcelBtn" class="btn btn-success">ÂØºÂá∫ExcelÂÆåÊï¥‰ø°ÊÅØ</button>
                    <button id="importDataBtn" class="btn btn-secondary">ÂØºÂÖ•Êï∞ÊçÆ</button>
                    <input type="file" id="importDataInput" accept=".json" style="display: none;">
                </div>
            </div>
        </header>

        <div id="customer-list" class="page active">
            <div class="search-filter">
                <div class="search-box">
                    <label for="searchInput">ÊêúÁ¥¢ÂÆ¢Êà∑</label>
                    <input type="text" id="searchInput" placeholder="ËæìÂÖ•ÂÆ¢Êà∑ÂßìÂêçÊêúÁ¥¢...">
                </div>
                <div class="filter-box">
                    <label for="consultantFilter">Á≠õÈÄâÈ°æÈóÆ</label>
                    <select id="consultantFilter">
                        <option value="">ÂÖ®ÈÉ®È°æÈóÆ</option>
                    </select>
                </div>
                <div class="filter-box">
                    <label for="salesFilter">Á≠õÈÄâÈîÄÂîÆ</label>
                    <select id="salesFilter">
                        <option value="">ÂÖ®ÈÉ®ÈîÄÂîÆ</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px; align-items: flex-end;">
                    <button id="addCustomerBtn" class="btn btn-primary">Êñ∞Â¢ûÂÆ¢Êà∑</button>
                    <button id="deleteCustomerBtn" class="btn btn-danger">Âà†Èô§ÂÆ¢Êà∑</button>
                </div>
            </div>

            <table id="customersTable">
                <thead>
                    <tr>
                        <th>ÂÆ¢Êà∑ÂßìÂêç</th>
                        <th>ÊÄßÂà´</th>
                        <th>Âπ¥ÈæÑ</th>
                        <th>ÊúçÂä°ËøõÂ∫¶</th>
                        <th onclick="ViewController.toggleSort('sales')" style="cursor: pointer;">
                            ÈîÄÂîÆ<span class="sort-arrow" id="sortArrow_sales">‚Üï</span>
                        </th>
                        <th onclick="ViewController.toggleSort('advisor')" style="cursor: pointer;">
                            È°æÈóÆ<span class="sort-arrow" id="sortArrow_advisor">‚Üï</span>
                        </th>
                        <th onclick="ViewController.toggleSort('nextDelivery')" style="cursor: pointer;">
                            ‰∏ãÊ¨°‰∫§‰ªòÊó∂Èó¥<span class="sort-arrow" id="sortArrow_nextDelivery">‚Üï</span>
                        </th>
                        <th onclick="ViewController.toggleSort('lastModified')" style="cursor: pointer;">
                            ÊúÄÂêé‰øÆÊîπ<span class="sort-arrow" id="sortArrow_lastModified">‚Üï</span>
                        </th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="pagination" id="pagination"></div>
        </div>

        <div id="customer-detail" class="page">
            <div class="tab-container">
                <div class="tab-header">
                    <div class="tab active" data-tab="personal-info">‰∏™‰∫∫‰ø°ÊÅØ</div>
                    <div class="tab" data-tab="period-info">Ë¥¶Êúü‰ø°ÊÅØ</div>
                    <div class="tab" data-tab="report-info">Ê£ÄÊµãÊä•Âëä</div>

                    <div class="header-icons">
                        <div id="globalSaveBtn" class="header-icon save-action" title="‰øùÂ≠ò">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                        </div>
                        <div id="closeDetailBtn" class="header-icon close-action" title="ËøîÂõûÂàóË°®">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </div>
                    </div>
                </div>

                <div id="personal-info" class="tab-content active">
                    <div id="personalInfoFormContainer"></div>
                </div>

                <div id="period-info" class="tab-content">
                    <div class="period-selector">
                        <select id="periodSelect"></select>
                        <button id="addPeriodBtn" class="btn btn-primary btn-sm">Êñ∞Â¢ûË¥¶Êúü</button>
                        <button id="deletePeriodBtn" class="btn btn-danger btn-sm">Âà†Èô§Ë¥¶Êúü</button>
                    </div>
                    <div id="periodFormContainer"></div>
                </div>

                <div id="report-info" class="tab-content">
                    <div class="report-tab-header">
                        <h2>Ê£ÄÊµãÊä•Âëä</h2>
                        <div class="edit-btn" id="reportEditButton">ÁºñËæë</div>
                    </div>
                    <div class="segmented-control">
                        <div id="seg-abnormal" class="segment active">ÂºÇÂ∏∏</div>
                        <div id="seg-all" class="segment">ÂÖ®ÈÉ®</div>
                    </div>
                    <div id="reportList"></div>
                    <div class="action-toolbar" id="reportActionToolbar">
                        <div class="action-buttons-container" id="reportActionButtonsContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="saveNotification" class="save-notification">‰øùÂ≠òÊàêÂäü</div>

    <div id="addCustomerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Êñ∞Â¢ûÂÆ¢Êà∑</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addCustomerForm">
                    <div class="form-group">
                        <label for="newCustomerName">ÂÆ¢Êà∑ÂßìÂêç *</label>
                        <input type="text" id="newCustomerName" required>
                    </div>
                    <div class="form-group">
                        <label for="newCustomerGender">ÊÄßÂà´</label>
                        <select id="newCustomerGender">
                            <option value="Â•≥">Â•≥</option>
                            <option value="Áî∑">Áî∑</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newCustomerService">È°æÈóÆ</label>
                        <input type="text" id="newCustomerService">
                    </div>
                    <div class="form-group">
                        <label for="newCustomerSales">ÈîÄÂîÆ</label>
                        <input type="text" id="newCustomerSales">
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Ê∑ªÂä†</button>
                        <button type="button" class="btn btn-secondary" id="cancelAddCustomerBtn">ÂèñÊ∂à</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="addPeriodModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Êñ∞Â¢ûË¥¶Êúü</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addPeriodForm">
                    <div class="form-group">
                        <label for="periodNumber">Ë¥¶ÊúüÁºñÂè∑</label>
                        <input type="text" id="periodNumber" placeholder="Â¶ÇÔºö1„ÄÅ2„ÄÅ3">
                    </div>
                    <div class="form-group">
                        <label for="periodDate">Ë¥¶ÊúüÊó•Êúü</label>
                        <input type="date" id="periodDate">
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Ê∑ªÂä†</button>
                        <button type="button" class="btn btn-secondary" id="cancelAddPeriodBtn">ÂèñÊ∂à</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="exportDataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÂØºÂá∫Êï∞ÊçÆ</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ÊêúÁ¥¢ÂÆ¢Êà∑</label>
                    <input type="text" id="customerSearchInput" placeholder="ËæìÂÖ•ÂÆ¢Êà∑ÂßìÂêçÊêúÁ¥¢...">
                </div>
                <div class="form-group">
                    <label>ÈÄâÊã©Ë¶ÅÂØºÂá∫ÁöÑÂÆ¢Êà∑</label>
                    <select id="exportCustomerSelect" size="5" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--ios-border); font-size: 16px; overflow-y: auto;">
                        <option value="">-- ËØ∑ÈÄâÊã©ÂÆ¢Êà∑ --</option>
                    </select>
                </div>
                <div class="button-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <button type="button" class="btn btn-secondary" id="cancelExportBtn">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" id="confirmExportBtn">ÂØºÂá∫</button>
                    <button type="button" class="btn btn-success" id="exportAllBtn">ÂØºÂá∫ÂÖ®ÈÉ®Êï∞ÊçÆ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <h3>Êñ∞Êä•Âëä</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Ê£ÄÊµãÊó•Êúü</label>
                    <input type="date" id="repDate">
                </div>
                <div class="form-group">
                    <label>Êä•ÂëäÂêçÁß∞</label>
                    <input type="text" id="repName" placeholder="Â¶ÇÔºöÂπ¥Â∫¶‰ΩìÊ£Ä">
                </div>
                <div class="form-group">
                    <label>Ê£ÄÊµãÊú∫ÊûÑ</label>
                    <input type="text" id="repOrg" placeholder="Â¶ÇÔºöXXÂåªÈô¢">
                </div>
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="ViewController.hideReportModal('reportModal')">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" onclick="ViewController.createReport()">Ê∑ªÂä†</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editReportModal" class="modal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <h3>ÁºñËæëÊä•Âëä</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Ê£ÄÊµãÊó•Êúü</label>
                    <input type="date" id="editRepDate">
                </div>
                <div class="form-group">
                    <label>Êä•ÂëäÂêçÁß∞</label>
                    <input type="text" id="editRepName">
                </div>
                <div class="form-group">
                    <label>Ê£ÄÊµãÊú∫ÊûÑ</label>
                    <input type="text" id="editRepOrg">
                </div>
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="ViewController.hideReportModal('editReportModal')">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" onclick="ViewController.saveEditReport()">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <div id="indicatorModal" class="modal">
        <div class="modal-content" style="max-width: 500px; border-radius: 12px;">
            <div class="modal-header" style="border-bottom: 1px solid #E5E5EA; padding: 20px 24px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #1C1C1E;">Ê∑ªÂä†ÊåáÊ†á</h3>
                <button class="close-modal" style="font-size: 28px; color: #8E8E93;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">ÊåáÊ†áÂêçÁß∞</label>
                    <input type="text" id="indName" placeholder="Â¶ÇÔºöÁ©∫ËÖπË°ÄÁ≥ñ" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">Êï∞ÂÄº</label>
                        <input type="text" id="indVal" placeholder="Â¶ÇÔºö5.6" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px;">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">Âçï‰Ωç</label>
                        <input type="text" id="indUnit" placeholder="Â¶ÇÔºömmol/L" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px;">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">ÂèÇËÄÉËåÉÂõ¥</label>
                    <input type="text" id="indRef" placeholder="Â¶ÇÔºö3.9-6.1" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px;">
                </div>
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">ÂàÜÁ±ª</label>
                        <select id="indCat" onchange="ViewController.updateSubcategoryOptions('indSubcat')" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px; background: white;">
                            <option value="1">ÈÅó‰º†‰∏éË°®ËßÇÈÅó‰º†Â≠¶</option>
                            <option value="2">‰ª£Ë∞¢‰∏éÁîüÁâ©ËÉΩÈáèÂ≠¶</option>
                            <option value="3">Âô®ÂÆòÂäüËÉΩ‰∏éÁ≥ªÁªüÁîüÁâ©Ê†áÂøóÁâ©</option>
                            <option value="4">ÂÖçÁñ´Á®≥ÊÄÅ‰∏éÁÇéÁóáÂä®ÂäõÂ≠¶</option>
                            <option value="5">Á•ûÁªè-ÂÜÖÂàÜÊ≥åË∞ÉËäÇËΩ¥</option>
                            <option value="6">ÁéØÂ¢ÉÊö¥Èú≤‰∏éÂæÆÁîüÊÄÅÁ≥ªÁªü</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">Áä∂ÊÄÅ</label>
                        <select id="indStatus" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px; background: white;">
                            <option value="normal">Ê≠£Â∏∏</option>
                            <option value="abnormal">ÂºÇÂ∏∏</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">Â≠êÂàÜÁ±ª</label>
                    <select id="indSubcat" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px; background: white;">
                        <option value="1.1">1.1 ÈÅó‰º†ÊòìÊÑüÊÄß</option>
                        <option value="1.2">1.2 Ë°®ËßÇÂä®ÊÄÅÊó∂Èíü</option>
                    </select>
                </div>
                <div class="button-group" style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="ViewController.hideReportModal('indicatorModal')" style="padding: 12px 24px; background: #F2F2F7; border: none; border-radius: 8px; color: #1C1C1E; font-size: 15px; cursor: pointer;">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" onclick="ViewController.confirmAddIndicator()" style="padding: 12px 24px; background: #007AFF; border: none; border-radius: 8px; color: white; font-size: 15px; cursor: pointer;">Á°ÆËÆ§</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editIndicatorModal" class="modal">
        <div class="modal-content" style="max-width: 500px; border-radius: 12px;">
            <div class="modal-header" style="border-bottom: 1px solid #E5E5EA; padding: 20px 24px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #1C1C1E;">‰øÆÊîπÊåáÊ†á</h3>
                <button class="close-modal" style="font-size: 28px; color: #8E8E93;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">ÊåáÊ†áÂêçÁß∞</label>
                    <input type="text" id="editIndName" placeholder="Â¶ÇÔºöÁ©∫ËÖπË°ÄÁ≥ñ" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">Êï∞ÂÄº</label>
                        <input type="text" id="editIndVal" placeholder="Â¶ÇÔºö5.6" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px;">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">Âçï‰Ωç</label>
                        <input type="text" id="editIndUnit" placeholder="Â¶ÇÔºömmol/L" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px;">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">ÂèÇËÄÉËåÉÂõ¥</label>
                    <input type="text" id="editIndRef" placeholder="Â¶ÇÔºö3.9-6.1" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px;">
                </div>
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">ÂàÜÁ±ª</label>
                        <select id="editIndCat" onchange="ViewController.updateSubcategoryOptions('editIndSubcat')" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px; background: white;">
                            <option value="1">ÈÅó‰º†‰∏éË°®ËßÇÈÅó‰º†Â≠¶</option>
                            <option value="2">‰ª£Ë∞¢‰∏éÁîüÁâ©ËÉΩÈáèÂ≠¶</option>
                            <option value="3">Âô®ÂÆòÂäüËÉΩ‰∏éÁ≥ªÁªüÁîüÁâ©Ê†áÂøóÁâ©</option>
                            <option value="4">ÂÖçÁñ´Á®≥ÊÄÅ‰∏éÁÇéÁóáÂä®ÂäõÂ≠¶</option>
                            <option value="5">Á•ûÁªè-ÂÜÖÂàÜÊ≥åË∞ÉËäÇËΩ¥</option>
                            <option value="6">ÁéØÂ¢ÉÊö¥Èú≤‰∏éÂæÆÁîüÊÄÅÁ≥ªÁªü</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">Áä∂ÊÄÅ</label>
                        <select id="editIndStatus" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px; background: white;">
                            <option value="normal">Ê≠£Â∏∏</option>
                            <option value="abnormal">ÂºÇÂ∏∏</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; color: #1C1C1E;">Â≠êÂàÜÁ±ª</label>
                    <select id="editIndSubcat" style="width: 100%; padding: 12px; border: 1px solid #C6C6C8; border-radius: 8px; font-size: 15px; background: white;">
                        <option value="1.1">1.1 ÈÅó‰º†ÊòìÊÑüÊÄß</option>
                        <option value="1.2">1.2 Ë°®ËßÇÂä®ÊÄÅÊó∂Èíü</option>
                    </select>
                </div>
                <div class="button-group" style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="ViewController.hideReportModal('editIndicatorModal')" style="padding: 12px 24px; background: #F2F2F7; border: none; border-radius: 8px; color: #1C1C1E; font-size: 15px; cursor: pointer;">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" onclick="ViewController.confirmEditIndicator()" style="padding: 12px 24px; background: #007AFF; border: none; border-radius: 8px; color: white; font-size: 15px; cursor: pointer;">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÊâπÈáèÂØºÂÖ•ÊåáÊ†á</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ËæìÂÖ•Ê†ºÂºèÔºöÊåáÊ†áÂêç Êï∞ÂÄº Âçï‰Ωç ÂèÇËÄÉËåÉÂõ¥ Á±ªÂà´(1-6) Â≠êÂàÜÁ±ª Áä∂ÊÄÅ(normal/abnormal)</label>
                    <textarea id="importText" rows="8" placeholder="ÊØèË°å‰∏Ä‰∏™ÊåáÊ†áÔºåÁî®Á©∫Ê†ºÂàÜÈöî&#10;‰æãÂ¶ÇÔºö&#10;ÁôΩÁªÜËÉûËÆ°Êï∞ 6.5 10^9/L 4-10 4 4.1 normal&#10;Ë°ÄÁ∫¢ËõãÁôΩ 130 g/L 120-160 3 3.3 normal&#10;Ë°ÄÁ≥ñ 7.2 mmol/L 3.9-6.1 2 2.1 abnormal"></textarea>
                </div>
                <p style="font-size: 12px; color: var(--ios-gray); margin-bottom: 15px;">
                    Á±ªÂà´: 1=ÈÅó‰º†‰∏éË°®ËßÇÈÅó‰º†Â≠¶, 2=‰ª£Ë∞¢‰∏éÁîüÁâ©ËÉΩÈáèÂ≠¶, 3=Âô®ÂÆòÂäüËÉΩ‰∏éÁ≥ªÁªüÁîüÁâ©Ê†áÂøóÁâ©, 4=ÂÖçÁñ´Á®≥ÊÄÅ‰∏éÁÇéÁóáÂä®ÂäõÂ≠¶, 5=Á•ûÁªè-ÂÜÖÂàÜÊ≥åË∞ÉËäÇËΩ¥, 6=ÁéØÂ¢ÉÊö¥Èú≤‰∏éÂæÆÁîüÊÄÅÁ≥ªÁªü<br>
                    Â≠êÂàÜÁ±ª: 1.1=ÈÅó‰º†ÊòìÊÑüÊÄß, 1.2=Ë°®ËßÇÂä®ÊÄÅÊó∂Èíü, 2.1=Á≥ñÂπ≥Ë°°‰∏éËÉ∞Â≤õÁ¥†ÊïèÊÑüÊÄß, 2.2=ËÑÇË¥®‰ª£Ë∞¢‰∏éÂøÉË°ÄÁÆ°È£éÈô©, 2.3=Á∫øÁ≤í‰ΩìËæÖÂõ†Â≠ê‰∏éËÉΩÈáèÂæ™ÁéØ, 3.1=Ê†∏ÂøÉÊª§Ëøá‰∏éÂêàÊàêÁ≥ªÁªü, 3.2=ÂΩ¢ÊÄÅÂ≠¶‰∏éÁªìÊûÑÂÆåÊï¥ÊÄß, 3.3=Âæ™ÁéØÁ≥ªÁªü‰∏éÁªÜËÉûË¥üËç∑, 4.1=ÊÖ¢ÊÄß‰ΩéÂ∫¶ÁÇéÁóáÁõëÊµã, 4.2=ÂÖàÂ§©‰∏éÂêéÂ§©ÂÖçÁñ´Â±èÈöú, 4.3=Ëá™Ë∫´ÂÖçÁñ´ÁâπÂºÇÊÄßÊåáÊ†á, 5.1=‰ª£Ë∞¢Ë∞ÉÊéßÊÄªÂºÄÂÖ≥, 5.2=Â∫îÊøÄ‰∏éÊòºÂ§úËäÇÂæãËΩ¥, 5.3=ÁîüÊÆñ‰∏éÂêàÊàê‰ª£Ë∞¢ËΩ¥, 6.1=Ê∂àÂåñÈÅì‰∏éÁîüÁâ©Â±èÈöú, 6.2=ÊØíÁêÜËΩΩËç∑‰∏éÊéíÊØíÂéãÂäõ
                </p>
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="ViewController.hideReportModal('importModal')">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" onclick="ViewController.confirmImportIndicators()">ÂØºÂÖ•</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= Supabase ÈÖçÁΩÆ =================
        const SUPABASE_URL = 'https://wrxdomvuuolptbleiayd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyeGRvbXZ1dW9scHRibGVpYXlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4OTg0NjYsImV4cCI6MjA4MjQ3NDQ2Nn0.unzRFSvODTCQ1U32VJbW14cyMBAN0Rn_RYT-NrEUoSA';
        
        const sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ================= ËÆ§ËØÅÊ®°Âùó =================
        const Auth = {
            // Áî®Êà∑ÈÖçÁΩÆ
            users: {
                admin: {
                    password: 'windway123',
                    role: 'admin',
                    displayName: 'ÁÆ°ÁêÜÂëò',
                    permissions: {
                        canEdit: true,
                        canDelete: true,
                        canAdd: true
                    }
                },
                guest: {
                    password: 'guest123',
                    role: 'guest',
                    displayName: 'Ê∏∏ÂÆ¢',
                    permissions: {
                        canEdit: false,
                        canDelete: false,
                        canAdd: false
                    }
                }
            },

            async login(event) {
                event.preventDefault();
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;
                const errorEl = document.getElementById('loginError');
                
                // È™åËØÅÁî®Êà∑
                const user = this.users[username];
                if (user && user.password === password) {
                    // ÁôªÂΩïÊàêÂäü
                    const userData = {
                        username: username,
                        displayName: user.displayName,
                        role: user.role,
                        permissions: user.permissions,
                        loginTime: new Date().toISOString()
                    };
                    
                    localStorage.setItem('windway_auth', 'true');
                    localStorage.setItem('windway_user', JSON.stringify(userData));
                    
                    document.getElementById('loginPage').classList.add('hidden');
                    errorEl.classList.remove('show');
                    
                    // ÂàùÂßãÂåñÂ∫îÁî®
                    ViewController.init();
                } else {
                    // ÁôªÂΩïÂ§±Ë¥•
                    errorEl.classList.add('show');
                    document.getElementById('loginPassword').value = '';
                }
            },
            
            checkAuth() {
                const auth = localStorage.getItem('windway_auth');
                if (auth === 'true') {
                    document.getElementById('loginPage').classList.add('hidden');
                    return true;
                }
                return false;
            },
            
            getCurrentUser() {
                const userStr = localStorage.getItem('windway_user');
                return userStr ? JSON.parse(userStr) : null;
            },
            
            hasPermission(action) {
                const user = this.getCurrentUser();
                if (!user || !user.permissions) return false;
                
                switch(action) {
                    case 'edit':
                        return user.permissions.canEdit;
                    case 'delete':
                        return user.permissions.canDelete;
                    case 'add':
                        return user.permissions.canAdd;
                    default:
                        return false;
                }
            },
            
            logout() {
                localStorage.removeItem('windway_auth');
                localStorage.removeItem('windway_user');
                location.reload();
            }
        };

        // ================= Êï∞ÊçÆÊ®°Âûã (SupabaseÁâàÊú¨) =================
        const CustomerModel = {
            async loadData() {
                let result = { customers: [], settings: { consultants: [], sales: [] } };
                try {
                    // 1. Âä†ËΩΩÂÆ¢Êà∑Êï∞ÊçÆ (ÊéíÈô§ id=0 ÁöÑËÆæÁΩÆË°å)
                    const { data: customers, error: customersError } = await sbClient
                        .from('customers')
                        .select('id, updated_at, data')
                        .neq('id', 0) 
                        .order('updated_at', { ascending: false });

                    if (customersError) throw customersError;

                    // 2. Êï∞ÊçÆÂÆπÈîôÂ§ÑÁêÜ
                    result.customers = (customers || []).map(row => {
                        let cData = row.data;
                        // Èò≤Ê≠¢ data ÊòØÂ≠óÁ¨¶‰∏≤
                        if (typeof cData === 'string') {
                            try { cData = JSON.parse(cData); } catch(e) {}
                        }
                        if (!cData) cData = {};
                        if (!cData.personalInfo) cData.personalInfo = {};
                        
                        // Âº∫Âà∂ÂêåÊ≠• ID ÂíåÊó∂Èó¥
                        cData.id = row.id;
                        cData.lastModified = row.updated_at ? new Date(row.updated_at).toLocaleDateString() : '';
                        return cData;
                    });

                    // 3. Áã¨Á´ãÂä†ËΩΩËÆæÁΩÆ (‰ΩøÁî® maybeSingle ÈÅøÂÖç 406 Êä•Èîô)
                    const { data: settingsRow } = await sbClient
                        .from('customers')
                        .select('data')
                        .eq('id', 0)
                        .maybeSingle();

                    if (settingsRow && settingsRow.data) {
                        result.settings = settingsRow.data;
                    }

                } catch (error) {
                    console.error('Êï∞ÊçÆÂä†ËΩΩÂºÇÂ∏∏ (Â∑≤Ëá™Âä®ÊÅ¢Â§ç):', error);
                }
                return result;
            },

            // Ëé∑ÂèñÂçï‰∏™ÂÆ¢Êà∑ÁöÑÂÆåÊï¥Êï∞ÊçÆ
            async getCustomerFullData(customerId) {
                try {
                    const { data, error } = await sbClient
                        .from('customers')
                        .select('id, data, updated_at')
                        .eq('id', customerId)
                        .single();
                    
                    if (error) throw error;
                    
                    // Â∞Ü id Âíå updated_at ÂêàÂπ∂Âà∞ data ‰∏≠ËøîÂõû
                    return {
                        ...data.data,
                        id: data.id,
                        updated_at: data.updated_at
                    };
                } catch (error) {
                    console.error('Ëé∑ÂèñÂÆ¢Êà∑ÂÆåÊï¥Êï∞ÊçÆÂ§±Ë¥•:', error);
                    return null;
                }
            },

            // Èò≤ÊäñËÆ°Êó∂Âô®
            saveTimer: null,

            async saveData(data) {
                try {
                    // 1. ‰øùÂ≠òÂÆ¢Êà∑Êï∞ÊçÆ
                    for (const customer of data.customers) {
                        const payload = {
                            data: customer,
                            updated_at: new Date().toISOString()
                        };
                        
                        // Â¶ÇÊûúÊúâ idÔºåÂàôÊ∑ªÂä†Âà∞ payload ‰ª•Êõ¥Êñ∞Áé∞ÊúâËÆ∞ÂΩï
                        if (customer.id) {
                            payload.id = customer.id;
                        }
                        
                        const { error } = await sbClient
                            .from('customers')
                            .upsert(payload);
                        
                        if (error) throw error;
                    }
                    
                    // 2. ‰øùÂ≠òËÆæÁΩÆÂà∞ id=0 ÁöÑÁâπÊÆäËÆ∞ÂΩï
                    const { error: settingsError } = await sbClient
                        .from('customers')
                        .upsert({
                            id: 0,
                            data: data.settings,
                            updated_at: new Date().toISOString()
                        });
                    
                    if (settingsError) throw settingsError;
                    
                } catch (error) {
                    console.error('‰øùÂ≠òÊï∞ÊçÆÂ§±Ë¥•:', error);
                    throw error;
                }
            },

            // Âà†Èô§ÂÆ¢Êà∑
            async deleteCustomer(customerId) {
                try {
                    const { error } = await sbClient
                        .from('customers')
                        .delete()
                        .eq('id', customerId);
                    
                    if (error) throw error;
                } catch (error) {
                    console.error('Âà†Èô§ÂÆ¢Êà∑Â§±Ë¥•:', error);
                    throw error;
                }
            },

            // Èò≤Êäñ‰øùÂ≠òÔºà500msÂª∂ËøüÔºâ
            debounceSave(data, showNotification = true) {
                if (this.saveTimer) {
                    clearTimeout(this.saveTimer);
                }
                return new Promise((resolve) => {
                    this.saveTimer = setTimeout(async () => {
                        await this.saveData(data);
                        if (showNotification) {
                            this.showSaveNotification('Â∑≤‰øùÂ≠ò');
                        }
                        resolve();
                    }, 500);
                });
            },

            // ÊòæÁ§∫‰øùÂ≠òÊèêÁ§∫
            showSaveNotification(message) {
                const notification = document.querySelector('.save-notification');
                if (notification) {
                    notification.textContent = message;
                    notification.classList.add('show');
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 2000);
                }
            },

            calculateAge(birthDate) {
                if (!birthDate) return '';
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            },

            getLatestPeriod(customer) {
                if (!customer.periods || customer.periods.length === 0) return null;
                return [...customer.periods].sort((a, b) => b.periodName.localeCompare(a.periodName))[0];
            },

            getNextDeliveryDate(customer) {
                const latestPeriod = this.getLatestPeriod(customer);
                return latestPeriod ? (latestPeriod.nextDeliveryDate || '') : '';
            }
        };

        // ================= ËßÜÂõæÊéßÂà∂Âô® =================
        const ViewController = {
            // ================= UIÈÖçÁΩÆÂ∏∏Èáè =================
            uiConfig: {
                // È¢úËâ≤Á≥ªÁªü
                colors: {
                    primary: '#007AFF',        // ‰∏ªËâ≤-ËìùËâ≤
                    text: '#1C1C1E',          // ‰∏ªÊñáÊú¨Ëâ≤
                    textSecondary: '#8E8E93',  // Ê¨°Ë¶ÅÊñáÊú¨Ëâ≤
                    border: '#C6C6C8',        // ËæπÊ°ÜËâ≤
                    borderLight: '#E5E5EA',   // ÊµÖËæπÊ°ÜËâ≤
                    background: '#FAFAFA',    // ËÉåÊôØËâ≤
                    bgLight: '#F2F2F7',       // ÊµÖËÉåÊôØËâ≤
                    bgWhite: '#FFFFFF',       // ÁôΩËâ≤ËÉåÊôØ
                    danger: '#FF3B30'         // Âç±Èô©Ëâ≤-Á∫¢Ëâ≤
                },
                
                // Èó¥Ë∑ùÁ≥ªÁªü
                spacing: {
                    xs: '6px',
                    sm: '8px',
                    md: '12px',
                    lg: '16px',
                    xl: '20px',
                    xxl: '24px',
                    xxxl: '40px'
                },
                
                // Â≠ó‰ΩìÁ≥ªÁªü
                fontSize: {
                    xs: '12px',
                    sm: '13px',
                    base: '15px',
                    md: '14px',
                    lg: '17px',
                    xl: '18px',
                    xxl: '20px',
                    xxxl: '28px'
                },
                
                // ÂúÜËßíÁ≥ªÁªü
                borderRadius: {
                    sm: '6px',
                    base: '8px',
                    md: '10px',
                    lg: '12px',
                    xl: '14px'
                },
                
                // ÊåâÈíÆÊ†∑Âºè
                button: {
                    primary: 'padding: 12px; background: #007AFF; border: none; border-radius: 8px; color: white; font-size: 15px; cursor: pointer;',
                    secondary: 'padding: 12px; background: #F2F2F7; border: none; border-radius: 8px; color: #1C1C1E; font-size: 15px; cursor: pointer;',
                    danger: 'padding: 12px; background: #FF3B30; border: none; border-radius: 8px; color: white; font-size: 15px; cursor: pointer;'
                },
                
                // ÊñáÊú¨Â∏∏Èáè
                messages: {
                    empty: 'ÊöÇÊó†Êï∞ÊçÆ',
                    emptyRecords: 'ÊöÇÊó†ËÆ∞ÂΩï',
                    emptyAddPrompt: 'ÊöÇÊó†ËÆ∞ÂΩïÔºåÁÇπÂáª‰∏ãÊñπÊ∑ªÂä†',
                    saveSuccess: '‰øùÂ≠òÊàêÂäü',
                    deleteConfirm: 'Á°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü',
                    deleteMultipleConfirm: (count) => `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${count} Êù°ËÆ∞ÂΩïÂêóÔºü`,
                    deleteSuccess: 'Âà†Èô§ÊàêÂäü',
                    unnamed: 'Êú™ÂëΩÂêç',
                    defaultRecord: 'ËÆ∞ÂΩï'
                }
            },
            
            // ================= Êï∞ÊçÆÁÆ°ÁêÜ =================
            currentCustomer: null,
            currentPeriod: null,
            currentPageIndex: 0,
            selectedCustomerId: null,

            // ‰∏™‰∫∫‰ø°ÊÅØÁºñËæëÊ®°Âºè
            isPersonalInfoEditMode: false,
            personalInfoBackup: null,

            // ÊéíÂ∫èÁä∂ÊÄÅ
            sortField: null,
            sortOrder: 'asc', // 'asc' Êàñ 'desc'
            
            // ================= ÊÄßËÉΩ‰ºòÂåñÁºìÂ≠ò =================
            _cache: {
                dom: new Map(),           // DOMÂÖÉÁ¥†ÁºìÂ≠ò
                computed: new Map(),      // ËÆ°ÁÆóÁªìÊûúÁºìÂ≠ò
                debounceTimers: new Map() // Èò≤ÊäñÂÆöÊó∂Âô®ÁºìÂ≠ò
            },

            // Ê£ÄÊµãÊä•ÂëäÁõ∏ÂÖ≥Áä∂ÊÄÅ
            reportFilterMode: 'abnormal',
            isReportEditMode: false,
            selectedReports: new Set(),
            currentReportId: null,
            editingReportId: null,
            draggedItem: null,
            draggedReport: null,

            // Êñ∞Â¢ûÔºöÊåáÊ†áÁºñËæëÁõ∏ÂÖ≥Áä∂ÊÄÅ
            editingIndicatorId: null,
            editingIndicatorReportId: null,

            categories: {
                "1": "ÈÅó‰º†‰∏éË°®ËßÇÈÅó‰º†Â≠¶",
                "2": "‰ª£Ë∞¢‰∏éÁîüÁâ©ËÉΩÈáèÂ≠¶",
                "3": "Âô®ÂÆòÂäüËÉΩ‰∏éÁ≥ªÁªüÁîüÁâ©Ê†áÂøóÁâ©",
                "4": "ÂÖçÁñ´Á®≥ÊÄÅ‰∏éÁÇéÁóáÂä®ÂäõÂ≠¶",
                "5": "Á•ûÁªè-ÂÜÖÂàÜÊ≥åË∞ÉËäÇËΩ¥",
                "6": "ÁéØÂ¢ÉÊö¥Èú≤‰∏éÂæÆÁîüÊÄÅÁ≥ªÁªü"
            },

            subcategories: {
                "1": {
                    "1.1": "1.1 ÈÅó‰º†ÊòìÊÑüÊÄß",
                    "1.2": "1.2 Ë°®ËßÇÂä®ÊÄÅÊó∂Èíü"
                },
                "2": {
                    "2.1": "2.1 Á≥ñÂπ≥Ë°°‰∏éËÉ∞Â≤õÁ¥†ÊïèÊÑüÊÄß",
                    "2.2": "2.2 ËÑÇË¥®‰ª£Ë∞¢‰∏éÂøÉË°ÄÁÆ°È£éÈô©",
                    "2.3": "2.3 Á∫øÁ≤í‰ΩìËæÖÂõ†Â≠ê‰∏éËÉΩÈáèÂæ™ÁéØ"
                },
                "3": {
                    "3.1": "3.1 Ê†∏ÂøÉÊª§Ëøá‰∏éÂêàÊàêÁ≥ªÁªü",
                    "3.2": "3.2 ÂΩ¢ÊÄÅÂ≠¶‰∏éÁªìÊûÑÂÆåÊï¥ÊÄß",
                    "3.3": "3.3 Âæ™ÁéØÁ≥ªÁªü‰∏éÁªÜËÉûË¥üËç∑"
                },
                "4": {
                    "4.1": "4.1 ÊÖ¢ÊÄß‰ΩéÂ∫¶ÁÇéÁóáÁõëÊµã",
                    "4.2": "4.2 ÂÖàÂ§©‰∏éÂêéÂ§©ÂÖçÁñ´Â±èÈöú",
                    "4.3": "4.3 Ëá™Ë∫´ÂÖçÁñ´ÁâπÂºÇÊÄßÊåáÊ†á"
                },
                "5": {
                    "5.1": "5.1 ‰ª£Ë∞¢Ë∞ÉÊéßÊÄªÂºÄÂÖ≥",
                    "5.2": "5.2 Â∫îÊøÄ‰∏éÊòºÂ§úËäÇÂæãËΩ¥",
                    "5.3": "5.3 ÁîüÊÆñ‰∏éÂêàÊàê‰ª£Ë∞¢ËΩ¥"
                },
                "6": {
                    "6.1": "6.1 Ê∂àÂåñÈÅì‰∏éÁîüÁâ©Â±èÈöú",
                    "6.2": "6.2 ÊØíÁêÜËΩΩËç∑‰∏éÊéíÊØíÂéãÂäõ"
                }
            },

            categoryColors: {
                "1": "#FF6B6B",  // ÈÅó‰º†‰∏éË°®ËßÇÈÅó‰º†Â≠¶ - Á∫¢Ëâ≤
                "2": "#4ECDC4",  // ‰ª£Ë∞¢‰∏éÁîüÁâ©ËÉΩÈáèÂ≠¶ - ÈùíËâ≤
                "3": "#45B7D1",  // Âô®ÂÆòÂäüËÉΩ‰∏éÁ≥ªÁªüÁîüÁâ©Ê†áÂøóÁâ© - ËìùËâ≤
                "4": "#FFA07A",  // ÂÖçÁñ´Á®≥ÊÄÅ‰∏éÁÇéÁóáÂä®ÂäõÂ≠¶ - Ê©ôËâ≤
                "5": "#98D8C8",  // Á•ûÁªè-ÂÜÖÂàÜÊ≥åË∞ÉËäÇËΩ¥ - ÁªøËâ≤
                "6": "#C7A4FF"   // ÁéØÂ¢ÉÊö¥Èú≤‰∏éÂæÆÁîüÊÄÅÁ≥ªÁªü - Á¥´Ëâ≤
            },

            async init() {
                this.applyPermissions();
                this.bindEvents();
                await this.renderCustomerList();
                await this.loadFilterOptions();
            },

            // Â∫îÁî®ÊùÉÈôêÊéßÂà∂
            applyPermissions() {
                const user = Auth.getCurrentUser();
                if (!user) return;

                // Â¶ÇÊûúÊòØÊ∏∏ÂÆ¢ÔºåÁ¶ÅÁî®ÁºñËæë„ÄÅÂà†Èô§„ÄÅÊñ∞Â¢ûÂäüËÉΩ
                if (user.role === 'guest') {
                    // Á¶ÅÁî®Êñ∞Â¢ûÂÆ¢Êà∑ÊåâÈíÆ
                    const addBtn = document.getElementById('addCustomerBtn');
                    if (addBtn) {
                        addBtn.style.display = 'none';
                    }

                    // Á¶ÅÁî®Âà†Èô§ÊåâÈíÆ
                    const deleteBtn = document.getElementById('deleteCustomerBtn');
                    if (deleteBtn) {
                        deleteBtn.style.display = 'none';
                    }

                    // Á¶ÅÁî®ÂÖ®Â±Ä‰øùÂ≠òÊåâÈíÆ
                    const saveBtn = document.getElementById('globalSaveBtn');
                    if (saveBtn) {
                        saveBtn.style.display = 'none';
                    }
                }

                // Âú®Ê†áÈ¢òÊóÅÊòæÁ§∫ÂΩìÂâçÁî®Êà∑
                const headerContent = document.querySelector('.header-content h1');
                if (headerContent && user.displayName) {
                    const userBadge = document.createElement('span');
                    userBadge.style.cssText = 'font-size: 12px; color: #8E8E93; font-weight: normal; margin-left: 8px;';
                    userBadge.textContent = `(${user.displayName})`;
                    headerContent.appendChild(userBadge);
                }
            },

            bindEvents() {
                // ÊêúÁ¥¢ÂíåÁ≠õÈÄâ
                document.getElementById('searchInput').addEventListener('input', () => this.renderCustomerList());
                document.getElementById('consultantFilter').addEventListener('change', () => this.renderCustomerList());
                document.getElementById('salesFilter').addEventListener('change', () => this.renderCustomerList());

                // Êñ∞Â¢ûÂÆ¢Êà∑
                document.getElementById('addCustomerBtn').addEventListener('click', () => {
                    document.getElementById('addCustomerModal').classList.add('active');
                });

                document.getElementById('addCustomerForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.addCustomer();
                });

                document.getElementById('cancelAddCustomerBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('addCustomerModal'));
                });

                // Âà†Èô§ÂÆ¢Êà∑
                document.getElementById('deleteCustomerBtn').addEventListener('click', () => this.deleteSelectedCustomer());

                // TabÂàáÊç¢
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        e.target.classList.add('active');
                        document.getElementById(e.target.dataset.tab).classList.add('active');
                    });
                });

                // ‰øùÂ≠òÂíåÂÖ≥Èó≠
                document.getElementById('globalSaveBtn').addEventListener('click', () => this.saveAll());
                document.getElementById('closeDetailBtn').addEventListener('click', () => this.closeDetail());

                // Ë¥¶ÊúüÊìç‰Ωú
                document.getElementById('addPeriodBtn').addEventListener('click', () => {
                    document.getElementById('addPeriodModal').classList.add('active');
                });

                document.getElementById('addPeriodForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.addPeriod();
                });

                document.getElementById('cancelAddPeriodBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('addPeriodModal'));
                });

                document.getElementById('deletePeriodBtn').addEventListener('click', () => this.deletePeriod());

                document.getElementById('periodSelect').addEventListener('change', (e) => {
                    const periodId = e.target.value;
                    this.currentPeriod = this.currentCustomer.periods.find(p => p.periodId === periodId);
                    if (this.currentPeriod) this.renderPeriodForm(this.currentPeriod);
                });

                // ÂØºÂá∫ÂØºÂÖ•
                document.getElementById('exportDataBtn').addEventListener('click', () => this.showExportDataModal());
                document.getElementById('confirmExportBtn').addEventListener('click', () => this.exportData());
                document.getElementById('cancelExportBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('exportDataModal'));
                });
                document.getElementById('exportAllBtn').addEventListener('click', () => this.exportAllCustomersData());
                document.getElementById('customerSearchInput').addEventListener('input', (e) => {
                    this.filterCustomerSelect(e.target.value);
                });

                document.getElementById('importDataBtn').addEventListener('click', () => {
                    document.getElementById('importDataInput').click();
                });

                document.getElementById('importDataInput').addEventListener('change', (e) => {
                    this.importData(e.target.files[0]);
                });

                document.getElementById('exportWordBtn').addEventListener('click', () => this.exportWord());
                document.getElementById('exportExcelBtn').addEventListener('click', () => this.exportTestRecordsExcel());
                document.getElementById('exportFullExcelBtn').addEventListener('click', () => this.exportFullExcel());

                // Ê£ÄÊµãÊä•ÂëäTab‰∫ã‰ª∂
                document.getElementById('reportEditButton').addEventListener('click', () => this.toggleReportEditMode());
                document.getElementById('seg-all').addEventListener('click', () => this.setReportFilter('all'));
                document.getElementById('seg-abnormal').addEventListener('click', () => this.setReportFilter('abnormal'));

                // Ê®°ÊÄÅÊ°ÜÂÖ≥Èó≠
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.closeModal(e.target.closest('.modal'));
                    });
                });

            },

            closeModal(modal) {
                modal.classList.remove('active');
            },

            // ================= ÂÆ¢Êà∑ÂàóË°®Áõ∏ÂÖ≥ =================
            toggleSort(field) {
                // Â¶ÇÊûúÁÇπÂáªÂêå‰∏ÄÂ≠óÊÆµÔºåÂàáÊç¢ÊéíÂ∫èÊñπÂêëÔºõÂê¶ÂàôËÆæÁΩÆÊñ∞Â≠óÊÆµ‰∏∫ÂçáÂ∫è
                if (this.sortField === field) {
                    this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortField = field;
                    this.sortOrder = 'asc';
                }

                // Êõ¥Êñ∞ÊâÄÊúâÁÆ≠Â§¥Ê†∑Âºè
                ['sales', 'advisor', 'nextDelivery', 'lastModified'].forEach(f => {
                    const arrow = document.getElementById(`sortArrow_${f}`);
                    if (arrow) {
                        if (f === field) {
                            arrow.classList.add('active');
                            arrow.textContent = this.sortOrder === 'asc' ? '‚Üë' : '‚Üì';
                        } else {
                            arrow.classList.remove('active');
                            arrow.textContent = '‚Üï';
                        }
                    }
                });

                // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
                this.renderCustomerList();
            },

            async renderCustomerList() {
                const data = await CustomerModel.loadData();
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const consultantFilter = document.getElementById('consultantFilter').value;
                const salesFilter = document.getElementById('salesFilter').value;

                let filteredCustomers = data.customers.filter(customer => {
                    const nameMatch = customer.personalInfo?.name?.toLowerCase().includes(searchTerm);
                    const consultantMatch = !consultantFilter || customer.personalInfo?.customerService === consultantFilter;
                    const salesMatch = !salesFilter || customer.personalInfo?.sales === salesFilter;
                    return nameMatch && consultantMatch && salesMatch;
                });

                // ÊéíÂ∫è
                if (this.sortField) {
                    filteredCustomers.sort((a, b) => {
                        let valA, valB;
                        
                        switch(this.sortField) {
                            case 'sales':
                                valA = a.personalInfo?.sales || '';
                                valB = b.personalInfo?.sales || '';
                                break;
                            case 'advisor':
                                valA = a.personalInfo?.customerService || '';
                                valB = b.personalInfo?.customerService || '';
                                break;
                            case 'nextDelivery':
                                valA = CustomerModel.getNextDeliveryDate(a) || '';
                                valB = CustomerModel.getNextDeliveryDate(b) || '';
                                break;
                            case 'lastModified':
                                valA = a.lastModified || '';
                                valB = b.lastModified || '';
                                break;
                            default:
                                return 0;
                        }
                        
                        // Â≠óÁ¨¶‰∏≤ÊØîËæÉ
                        const comparison = valA.localeCompare(valB, 'zh-CN');
                        return this.sortOrder === 'asc' ? comparison : -comparison;
                    });
                }

                const pageSize = 10;
                const startIndex = this.currentPageIndex * pageSize;
                const paginatedCustomers = filteredCustomers.slice(startIndex, startIndex + pageSize);

                const tbody = document.querySelector('#customersTable tbody');
                tbody.innerHTML = '';

                paginatedCustomers.forEach(customer => {
                    const latestPeriod = CustomerModel.getLatestPeriod(customer);
                    const serviceProgress = latestPeriod ? latestPeriod.periodName : '';
                    const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                    const lastModified = customer.lastModified || '';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.personalInfo?.name || ''}</td>
                        <td>${customer.personalInfo?.gender || ''}</td>
                        <td>${customer.personalInfo?.age || ''}</td>
                        <td>${serviceProgress}</td>
                        <td>${customer.personalInfo?.sales || ''}</td>
                        <td>${customer.personalInfo?.customerService || ''}</td>
                        <td>${nextDeliveryDate}</td>
                        <td>${lastModified}</td>
                    `;

                    row.addEventListener('click', () => {
                        document.querySelectorAll('#customersTable tbody tr').forEach(r => r.classList.remove('selected'));
                        row.classList.add('selected');
                        this.selectedCustomerId = customer.id;
                    });

                    row.addEventListener('dblclick', () => this.showCustomerDetail(customer.id));
                    tbody.appendChild(row);
                });

                this.renderPagination(filteredCustomers.length, pageSize);
            },

            renderPagination(totalCustomers, pageSize) {
                const totalPages = Math.ceil(totalCustomers / pageSize);
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';

                for (let i = 0; i < totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `page-btn ${i === this.currentPageIndex ? 'active' : ''}`;
                    pageBtn.textContent = i + 1;
                    pageBtn.addEventListener('click', () => {
                        this.currentPageIndex = i;
                        this.renderCustomerList();
                    });
                    pagination.appendChild(pageBtn);
                }
            },

            async loadFilterOptions() {
                const data = await CustomerModel.loadData();
                const consultants = new Set();
                const sales = new Set();

                data.customers.forEach(c => {
                    if (c.personalInfo?.customerService) consultants.add(c.personalInfo.customerService);
                    if (c.personalInfo?.sales) sales.add(c.personalInfo.sales);
                });

                const consultantSelect = document.getElementById('consultantFilter');
                consultantSelect.innerHTML = '<option value="">ÂÖ®ÈÉ®È°æÈóÆ</option>';
                [...consultants].sort().forEach(c => {
                    consultantSelect.innerHTML += `<option value="${c}">${c}</option>`;
                });

                const salesSelect = document.getElementById('salesFilter');
                salesSelect.innerHTML = '<option value="">ÂÖ®ÈÉ®ÈîÄÂîÆ</option>';
                [...sales].sort().forEach(s => {
                    salesSelect.innerHTML += `<option value="${s}">${s}</option>`;
                });
            },

            async addCustomer() {
                // ÊùÉÈôêÊ£ÄÊü•
                if (!Auth.hasPermission('add')) {
                    alert('ÊÇ®Ê≤°ÊúâÊñ∞Â¢ûÂÆ¢Êà∑ÁöÑÊùÉÈôê');
                    return;
                }

                const name = document.getElementById('newCustomerName').value.trim();
                if (!name) {
                    alert('ËØ∑ËæìÂÖ•ÂÆ¢Êà∑ÂßìÂêç');
                    return;
                }

                const data = await CustomerModel.loadData();
                const newCustomer = {
                    id: Date.now(),
                    personalInfo: {
                        name: name,
                        gender: document.getElementById('newCustomerGender').value,
                        customerService: document.getElementById('newCustomerService').value,
                        sales: document.getElementById('newCustomerSales').value
                    },
                    periods: [],
                    reports: [],
                    lastModified: new Date().toISOString().split('T')[0]
                };

                data.customers.push(newCustomer);
                await CustomerModel.debounceSave(data);

                this.closeModal(document.getElementById('addCustomerModal'));
                document.getElementById('addCustomerForm').reset();
                await this.renderCustomerList();
                await this.loadFilterOptions();
            },

            // Á°ÆËÆ§Âà†Èô§Áõ∏ÂÖ≥
            deleteCallback: null,

            showConfirmDelete(title, message, callback) {
                document.getElementById('confirmDeleteTitle').textContent = title;
                document.getElementById('confirmDeleteMessage').textContent = message;
                this.deleteCallback = callback;
                document.getElementById('confirmDeleteModal').classList.add('active');
            },

            closeConfirmDeleteModal() {
                document.getElementById('confirmDeleteModal').classList.remove('active');
                this.deleteCallback = null;
            },

            executeDelete() {
                if (this.deleteCallback) {
                    this.deleteCallback();
                }
                this.closeConfirmDeleteModal();
            },

            async deleteSelectedCustomer() {
                // ÊùÉÈôêÊ£ÄÊü•
                if (!Auth.hasPermission('delete')) {
                    alert('ÊÇ®Ê≤°ÊúâÂà†Èô§ÂÆ¢Êà∑ÁöÑÊùÉÈôê');
                    return;
                }

                if (!this.selectedCustomerId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÂÆ¢Êà∑');
                    return;
                }

                this.showConfirmDelete(
                    'Âà†Èô§ÂÆ¢Êà∑',
                    'Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑÂÆ¢Êà∑ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ',
                    async () => {
                        // ‰ΩøÁî® Supabase Âà†Èô§
                        await CustomerModel.deleteCustomer(this.selectedCustomerId);

                        this.selectedCustomerId = null;
                        await this.renderCustomerList();
                        await this.loadFilterOptions();
                    }
                );
            },

            async showCustomerDetail(customerId) {
                // ‰ªé Supabase Ëé∑ÂèñÂÆåÊï¥ÁöÑÂÆ¢Êà∑Êï∞ÊçÆ
                this.currentCustomer = await CustomerModel.getCustomerFullData(customerId);
                if (!this.currentCustomer) return;

                document.getElementById('customer-list').classList.remove('active');
                document.getElementById('customer-detail').classList.add('active');

                this.renderPersonalInfoForm(this.currentCustomer);
                this.renderPeriodSelector(this.currentCustomer);
                this.renderReportList();
            },

            closeDetail() {
                document.getElementById('customer-detail').classList.remove('active');
                document.getElementById('customer-list').classList.add('active');
                this.renderCustomerList();
            },

            async saveAll() {
                // ÊùÉÈôêÊ£ÄÊü•
                if (!Auth.hasPermission('edit')) {
                    alert('ÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôê');
                    return;
                }

                await this.savePersonalInfo(false);
                await this.savePeriodInfo(false);
                await this.saveCustomerData();
                this.showSaveNotification();
            },

            // ================= ‰∏™‰∫∫‰ø°ÊÅØÁõ∏ÂÖ≥ =================
            renderPersonalInfoForm(customer) {
                // ‰øùÂ≠òÂΩìÂâçÊâÄÊúâÂç°ÁâáÁöÑÂ±ïÂºÄ/ÊäòÂè†Áä∂ÊÄÅ
                const cardStates = {};
                const cardIds = [
                    'allergyHistoryPanel', 'medicationHistoryPanel', 'pastMedicalHistoryPanel',
                    'surgeryHistoryPanel', 'physicalExamPanel', 'vaccinationHistoryPanel',
                    'familyHistoryPanel', 'customerPortraitCard', 'dietaryCard',
                    'activityCard', 'sleepCard', 'healthHabitsCard'
                ];
                cardIds.forEach(id => {
                    const panel = document.getElementById(id);
                    if (panel) {
                        cardStates[id] = !panel.classList.contains('collapsed');
                    }
                });

                const personalInfo = customer.personalInfo || {};
                const container = document.getElementById('personalInfoFormContainer');
                const isEditMode = this.isPersonalInfoEditMode || false;
                const readonlyAttr = isEditMode ? '' : 'readonly';
                const disabledAttr = isEditMode ? '' : 'disabled';

                container.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #E5E5EA;">
                        <h3 style="font-size: 17px; font-weight: 600; color: #1C1C1E; margin: 0;">Âü∫Á°Ä‰ø°ÊÅØ</h3>
                        <div id="personalInfoEditButtons" style="display: flex; gap: 12px;">
                            ${isEditMode ? `
                                <button onclick="ViewController.cancelPersonalInfoEdit()" style="padding: 8px 16px; background: #F2F2F7; border: none; border-radius: 8px; color: #1C1C1E; font-size: 15px; font-weight: 500; cursor: pointer;">ÂèñÊ∂à</button>
                                <button onclick="ViewController.savePersonalInfoEdit()" style="padding: 8px 16px; background: #007AFF; border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 500; cursor: pointer;">‰øùÂ≠ò</button>
                            ` : (Auth.hasPermission('edit') ? `
                                <button onclick="ViewController.togglePersonalInfoEdit()" style="padding: 8px 16px; background: #007AFF; border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 500; cursor: pointer;">ÁºñËæë</button>
                            ` : '')}
                        </div>
                    </div>
                    <div class="three-column-form">
                        <div class="form-group">
                            <label for="customerName">ÂÆ¢Êà∑ÂßìÂêç</label>
                            <input type="text" id="customerName" value="${personalInfo.name || ''}" ${readonlyAttr}>
                        </div>
                        <div class="form-group">
                            <label for="gender">ÊÄßÂà´</label>
                            <select id="gender" ${disabledAttr}>
                                <option value="Â•≥" ${personalInfo.gender === 'Â•≥' ? 'selected' : ''}>Â•≥</option>
                                <option value="Áî∑" ${personalInfo.gender === 'Áî∑' ? 'selected' : ''}>Áî∑</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="birthDate">Âá∫ÁîüÊó•Êúü</label>
                            <input type="date" id="birthDate" value="${personalInfo.birthDate || ''}" ${readonlyAttr}>
                        </div>
                        <div class="form-group">
                            <label for="age">Âπ¥ÈæÑ</label>
                            <input type="number" id="age" value="${personalInfo.age || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label for="height">Ë∫´È´ò(cm)</label>
                            <input type="number" id="height" value="${personalInfo.height || ''}" ${readonlyAttr}>
                        </div>
                        <div class="form-group">
                            <label for="weight">‰ΩìÈáç(kg)</label>
                            <input type="number" id="weight" value="${personalInfo.weight || ''}" ${readonlyAttr}>
                        </div>
                        <div class="form-group">
                            <label for="bmi">BMI</label>
                            <input type="text" id="bmi" value="${personalInfo.bmi || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label for="waistCircumference">ËÖ∞Âõ¥(cm)</label>
                            <input type="number" id="waistCircumference" value="${personalInfo.waistCircumference || ''}" ${readonlyAttr}>
                        </div>
                        <div class="form-group">
                            <label for="customerService">È°æÈóÆ</label>
                            <input type="text" id="customerService" value="${personalInfo.customerService || ''}" ${readonlyAttr}>
                        </div>
                        <div class="form-group">
                            <label for="sales">ÈîÄÂîÆ</label>
                            <input type="text" id="sales" value="${personalInfo.sales || ''}" ${readonlyAttr}>
                        </div>
                        <div class="form-group">
                            <label for="smokingDrinking">Âê∏ÁÉüÈ•ÆÈÖí</label>
                            <input type="text" id="smokingDrinking" value="${personalInfo.smokingDrinking || ''}" ${readonlyAttr}>
                        </div>
                        <div class="form-group">
                            <label for="residence">Â∏∏Â±ÖÂú∞</label>
                            <input type="text" id="residence" value="${personalInfo.residence || ''}" ${readonlyAttr}>
                        </div>
                        <div class="form-group">
                            <label for="maritalStatus">Â©öÂßªÁä∂ÂÜµ</label>
                            <input type="text" id="maritalStatus" value="${personalInfo.maritalStatus || ''}" ${readonlyAttr}>
                        </div>
                        <div class="form-group full-width">
                            <div class="history-collapse-panel collapsed ${customer.allergyHistory?.length > 0 ? 'has-data color-orange' : ''}" id="allergyHistoryPanel">
                                <div class="history-collapse-header" onclick="ViewController.toggleHistoryPanel('allergyHistoryPanel')">
                                    <span>ËøáÊïèÂè≤<span class="record-count">(${customer.allergyHistory?.length || 0})</span></span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="edit-icon" onclick="event.stopPropagation(); ViewController.openEditModal('allergyHistory', false);" title="ÁºñËæë">‚úèÔ∏è</span>
                                        <span class="add-icon" onclick="event.stopPropagation(); ViewController.openAddModal('allergyHistory', false);" style="margin: 0;">Ôºã</span>
                                        <span class="history-collapse-icon">‚ñº</span>
                                    </div>
                                </div>
                                <div class="history-collapse-content">
                                    <div id="allergyHistoryContainer" style="padding: 10px;">
                                        ${this.renderAllergyHistoryTable(customer.allergyHistory || [])}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="history-collapse-panel collapsed ${customer.medicationHistory?.length > 0 ? 'has-data color-red' : ''}" id="medicationHistoryPanel">
                                <div class="history-collapse-header" onclick="ViewController.toggleHistoryPanel('medicationHistoryPanel')">
                                    <span>Áî®ËçØÂè≤<span class="record-count">(${customer.medicationHistory?.length || 0})</span></span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="edit-icon" onclick="event.stopPropagation(); ViewController.openEditModal('medicationHistory', false);" title="ÁºñËæë">‚úèÔ∏è</span>
                                        <span class="add-icon" onclick="event.stopPropagation(); ViewController.openAddModal('medicationHistory', false);" style="margin: 0;">Ôºã</span>
                                        <span class="history-collapse-icon">‚ñº</span>
                                    </div>
                                </div>
                                <div class="history-collapse-content">
                                    <div id="medicationHistoryContainer" style="padding: 10px;">
                                        ${this.renderMedicationHistoryTable(customer.medicationHistory || [])}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="history-collapse-panel collapsed ${customer.pastMedicalHistory?.length > 0 ? 'has-data color-purple' : ''}" id="pastMedicalHistoryPanel">
                                <div class="history-collapse-header" onclick="ViewController.toggleHistoryPanel('pastMedicalHistoryPanel')">
                                    <span>Êó¢ÂæÄÁóÖÂè≤<span class="record-count">(${customer.pastMedicalHistory?.length || 0})</span></span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="edit-icon" onclick="event.stopPropagation(); ViewController.openEditModal('pastMedicalHistory', false);" title="ÁºñËæë">‚úèÔ∏è</span>
                                        <span class="add-icon" onclick="event.stopPropagation(); ViewController.openAddModal('pastMedicalHistory', false);" style="margin: 0;">Ôºã</span>
                                        <span class="history-collapse-icon">‚ñº</span>
                                    </div>
                                </div>
                                <div class="history-collapse-content">
                                    <div id="pastMedicalHistoryContainer" style="padding: 10px;">
                                        ${this.renderPastMedicalHistoryTable(customer.pastMedicalHistory || [])}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="history-collapse-panel collapsed ${customer.surgeryHospitalizationHistory?.length > 0 ? 'has-data color-pink' : ''}" id="surgeryHistoryPanel">
                                <div class="history-collapse-header" onclick="ViewController.toggleHistoryPanel('surgeryHistoryPanel')">
                                    <span>ÊâãÊúØ‰∏é‰ΩèÈô¢Âè≤<span class="record-count">(${customer.surgeryHospitalizationHistory?.length || 0})</span></span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="edit-icon" onclick="event.stopPropagation(); ViewController.openEditModal('surgeryHospitalizationHistory', false);" title="ÁºñËæë">‚úèÔ∏è</span>
                                        <span class="add-icon" onclick="event.stopPropagation(); ViewController.openAddModal('surgeryHospitalizationHistory', false);" style="margin: 0;">Ôºã</span>
                                        <span class="history-collapse-icon">‚ñº</span>
                                    </div>
                                </div>
                                <div class="history-collapse-content">
                                    <div id="surgeryHospitalizationHistoryContainer" style="padding: 10px;">
                                        ${this.renderSurgeryHospitalizationHistoryTable(customer.surgeryHospitalizationHistory || [])}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="history-collapse-panel collapsed ${customer.physicalExamSummary?.length > 0 ? 'has-data color-cyan' : ''}" id="physicalExamPanel">
                                <div class="history-collapse-header" onclick="ViewController.toggleHistoryPanel('physicalExamPanel')">
                                    <span>‰ΩìÊ£ÄÂ∞èÁªì<span class="record-count">(${customer.physicalExamSummary?.length || 0})</span></span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="edit-icon" onclick="event.stopPropagation(); ViewController.openEditModal('physicalExamSummary', false);" title="ÁºñËæë">‚úèÔ∏è</span>
                                        <span class="add-icon" onclick="event.stopPropagation(); ViewController.openAddModal('physicalExamSummary', false);" style="margin: 0;">Ôºã</span>
                                        <span class="history-collapse-icon">‚ñº</span>
                                    </div>
                                </div>
                                <div class="history-collapse-content">
                                    <div id="physicalExamSummaryContainer" style="padding: 10px;">
                                        ${this.renderPhysicalExamSummaryTable(customer.physicalExamSummary || [])}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="history-collapse-panel collapsed ${customer.vaccinationHistory?.length > 0 ? 'has-data color-green' : ''}" id="vaccinationHistoryPanel">
                                <div class="history-collapse-header" onclick="ViewController.toggleHistoryPanel('vaccinationHistoryPanel')">
                                    <span>Áñ´ËãóÊé•ÁßçÂè≤<span class="record-count">(${customer.vaccinationHistory?.length || 0})</span></span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="edit-icon" onclick="event.stopPropagation(); ViewController.openEditModal('vaccinationHistory', false);" title="ÁºñËæë">‚úèÔ∏è</span>
                                        <span class="add-icon" onclick="event.stopPropagation(); ViewController.openAddModal('vaccinationHistory', false);" style="margin: 0;">Ôºã</span>
                                        <span class="history-collapse-icon">‚ñº</span>
                                    </div>
                                </div>
                                <div class="history-collapse-content">
                                    <div id="vaccinationHistoryContainer" style="padding: 10px;">
                                        ${this.renderVaccinationHistoryTable(customer.vaccinationHistory || [])}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="history-collapse-panel collapsed ${customer.familyHistory?.length > 0 ? 'has-data color-indigo' : ''}" id="familyHistoryPanel">
                                <div class="history-collapse-header" onclick="ViewController.toggleHistoryPanel('familyHistoryPanel')">
                                    <span>ÂÆ∂ÊóèÁóÖÂè≤<span class="record-count">(${customer.familyHistory?.length || 0})</span></span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="edit-icon" onclick="event.stopPropagation(); ViewController.openEditModal('familyHistory', false);" title="ÁºñËæë">‚úèÔ∏è</span>
                                        <span class="add-icon" onclick="event.stopPropagation(); ViewController.openAddModal('familyHistory', false);" style="margin: 0;">Ôºã</span>
                                        <span class="history-collapse-icon">‚ñº</span>
                                    </div>
                                </div>
                                <div class="history-collapse-content">
                                    <div id="familyHistoryContainer" style="padding: 10px;">
                                        ${this.renderFamilyHistoryTable(customer.familyHistory || [])}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="modern-card collapsed" id="customerPortraitCard">
                                <div class="modern-card-header" onclick="ViewController.toggleModernCard('customerPortraitCard')">
                                    <div class="modern-card-title">
                                        <span class="modern-card-icon">üë§</span>
                                        <span>ÂÆ¢Êà∑ÁîªÂÉè</span>
                                    </div>
                                    <span class="modern-card-toggle">‚ñº</span>
                                </div>
                                <div class="modern-card-content">
                                    <div class="modern-card-body">
                                        <textarea id="customerPortrait" rows="4" style="width: 100%; border: 1px solid rgba(200, 215, 235, 0.4); border-radius: 8px; padding: 12px; background: rgba(255, 255, 255, 0.6);">${personalInfo.customerPortrait || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="modern-card collapsed" id="dietaryCard">
                                <div class="modern-card-header" onclick="ViewController.toggleModernCard('dietaryCard')">
                                    <div class="modern-card-title">
                                        <span class="modern-card-icon">üçé</span>
                                        <span>ËÜ≥È£ü</span>
                                    </div>
                                    <span class="modern-card-toggle">‚ñº</span>
                                </div>
                                <div class="modern-card-content">
                                    <div class="modern-card-body">
                                        <textarea id="dietaryHabitsInfo" rows="4" style="width: 100%; border: 1px solid rgba(200, 215, 235, 0.4); border-radius: 8px; padding: 12px; background: rgba(255, 255, 255, 0.6);">${personalInfo.dietaryHabitsInfo || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="modern-card collapsed" id="activityCard">
                                <div class="modern-card-header" onclick="ViewController.toggleModernCard('activityCard')">
                                    <div class="modern-card-title">
                                        <span class="modern-card-icon">üèÉ</span>
                                        <span>Ê¥ªÂä®‰∏éËøêÂä®</span>
                                    </div>
                                    <span class="modern-card-toggle">‚ñº</span>
                                </div>
                                <div class="modern-card-content">
                                    <div class="modern-card-body">
                                        <textarea id="activityExercise" rows="4" style="width: 100%; border: 1px solid rgba(200, 215, 235, 0.4); border-radius: 8px; padding: 12px; background: rgba(255, 255, 255, 0.6);">${personalInfo.activityExercise || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="modern-card collapsed" id="sleepCard">
                                <div class="modern-card-header" onclick="ViewController.toggleModernCard('sleepCard')">
                                    <div class="modern-card-title">
                                        <span class="modern-card-icon">üò¥</span>
                                        <span>Áù°Áú†‰∏éÂéãÂäõ</span>
                                    </div>
                                    <span class="modern-card-toggle">‚ñº</span>
                                </div>
                                <div class="modern-card-content">
                                    <div class="modern-card-body">
                                        <textarea id="sleepStress" rows="4" style="width: 100%; border: 1px solid rgba(200, 215, 235, 0.4); border-radius: 8px; padding: 12px; background: rgba(255, 255, 255, 0.6);">${personalInfo.sleepStress || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="modern-card collapsed" id="healthHabitsCard">
                                <div class="modern-card-header" onclick="ViewController.toggleModernCard('healthHabitsCard')">
                                    <div class="modern-card-title">
                                        <span class="modern-card-icon">üí™</span>
                                        <span>ÂÖ∂‰ªñÂÅ•Â∫∑‰π†ÊÉØ</span>
                                    </div>
                                    <span class="modern-card-toggle">‚ñº</span>
                                </div>
                                <div class="modern-card-content">
                                    <div class="modern-card-body">
                                        <textarea id="otherHealthHabits" rows="4" style="width: 100%; border: 1px solid rgba(200, 215, 235, 0.4); border-radius: 8px; padding: 12px; background: rgba(255, 255, 255, 0.6);">${personalInfo.otherHealthHabits || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // ÁªëÂÆö‰∫ã‰ª∂
                document.getElementById('birthDate').addEventListener('change', () => {
                    const age = CustomerModel.calculateAge(document.getElementById('birthDate').value);
                    document.getElementById('age').value = age;
                });

                document.getElementById('height').addEventListener('input', () => this.calculateBMI());
                document.getElementById('weight').addEventListener('input', () => this.calculateBMI());

                // Ê∑ªÂä†ËÆ∞ÂΩï‰∫ã‰ª∂
                // document.querySelector('.add-allergy-icon').addEventListener('click', () => this.addAllergyHistoryRecord()); // Â∑≤Êîπ‰∏∫inline onclick
                // document.querySelector('.add-medication-icon').addEventListener('click', () => this.addMedicationHistoryRecord()); // Â∑≤Êîπ‰∏∫inline onclick
                // document.querySelector('.add-past-medical-icon').addEventListener('click', () => this.addPastMedicalHistoryRecord()); // Â∑≤Êîπ‰∏∫inline onclick
                // document.querySelector('.add-surgery-icon').addEventListener('click', () => this.addSurgeryHospitalizationHistoryRecord()); // Â∑≤Êîπ‰∏∫inline onclick
                // document.querySelector('.add-physical-exam-icon').addEventListener('click', () => this.addPhysicalExamSummaryRecord()); // Â∑≤Êîπ‰∏∫inline onclick
                // document.querySelector('.add-vaccination-icon').addEventListener('click', () => this.addVaccinationHistoryRecord()); // Â∑≤Êîπ‰∏∫inline onclick
                // document.querySelector('.add-family-icon').addEventListener('click', () => this.addFamilyHistoryRecord()); // Â∑≤Êîπ‰∏∫inline onclick

                // ÊÅ¢Â§çÂç°ÁâáÁä∂ÊÄÅ
                setTimeout(() => {
                    Object.keys(cardStates).forEach(id => {
                        const panel = document.getElementById(id);
                        if (panel) {
                            if (cardStates[id]) {
                                panel.classList.remove('collapsed');
                            } else {
                                panel.classList.add('collapsed');
                            }
                        }
                    });
                }, 10);
            },

            calculateBMI() {
                const height = parseFloat(document.getElementById('height').value) / 100;
                const weight = parseFloat(document.getElementById('weight').value);
                if (height && weight) {
                    const bmi = (weight / (height * height)).toFixed(1);
                    document.getElementById('bmi').value = bmi;
                }
            },

            // ‰∏™‰∫∫‰ø°ÊÅØÁºñËæëÊ®°ÂºèÂàáÊç¢
            togglePersonalInfoEdit() {
                // ÊùÉÈôêÊ£ÄÊü•
                if (!Auth.hasPermission('edit')) {
                    alert('ÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôê');
                    return;
                }

                this.isPersonalInfoEditMode = true;
                // Â§á‰ªΩÂΩìÂâçÊï∞ÊçÆ
                this.personalInfoBackup = JSON.parse(JSON.stringify(this.currentCustomer.personalInfo || {}));
                this.renderPersonalInfoForm(this.currentCustomer);
            },

            savePersonalInfoEdit() {
                const personalInfo = this.currentCustomer.personalInfo || {};

                // ÊäìÂèñÂ∏∏ËßÑÂ≠óÊÆµ
                personalInfo.name = document.getElementById('customerName').value;
                personalInfo.gender = document.getElementById('gender').value;
                personalInfo.birthDate = document.getElementById('birthDate').value;
                
                // „ÄêÊºèÊéâÁöÑË°•‰∏ä‰∫Ü„ÄëÊòæÂºèÊäìÂèñÂπ¥ÈæÑÂíå BMI
                personalInfo.age = document.getElementById('age').value;
                personalInfo.bmi = document.getElementById('bmi').value;

                personalInfo.height = document.getElementById('height').value;
                personalInfo.weight = document.getElementById('weight').value;
                personalInfo.waistCircumference = document.getElementById('waistCircumference').value;
                personalInfo.customerService = document.getElementById('customerService').value;
                personalInfo.sales = document.getElementById('sales').value;
                personalInfo.smokingDrinking = document.getElementById('smokingDrinking').value;
                personalInfo.residence = document.getElementById('residence').value;
                personalInfo.maritalStatus = document.getElementById('maritalStatus').value;

                this.currentCustomer.personalInfo = personalInfo;
                this.saveCustomerData();
                
                this.isPersonalInfoEditMode = false;
                this.personalInfoBackup = null;
                this.renderPersonalInfoForm(this.currentCustomer);
                this.showSaveNotification();
            },

            cancelPersonalInfoEdit() {
                // ÊÅ¢Â§çÂ§á‰ªΩÊï∞ÊçÆ
                if (this.personalInfoBackup) {
                    this.currentCustomer.personalInfo = this.personalInfoBackup;
                }
                
                // ÈÄÄÂá∫ÁºñËæëÊ®°Âºè
                this.isPersonalInfoEditMode = false;
                this.personalInfoBackup = null;
                this.renderPersonalInfoForm(this.currentCustomer);
            },

            // ÂàáÊç¢ÁóÖÂè≤ÊäòÂè†Èù¢Êùø
            toggleHistoryPanel(panelId) {
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.classList.toggle('collapsed');
                }
            },

            // ÂàáÊç¢Áé∞‰ª£Âç°Áâá
            toggleModernCard(cardId) {
                const card = document.getElementById(cardId);
                if (card) {
                    card.classList.toggle('collapsed');
                }
            },

            // ÁßªÂä®‰∏™‰∫∫‰ø°ÊÅØË°®Ê†ºË°å
            movePersonalRow(fieldName, index, direction) {
                const array = this.currentCustomer[fieldName];
                if (!array) return;

                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= array.length) return;

                // ‰∫§Êç¢‰ΩçÁΩÆ
                [array[index], array[newIndex]] = [array[newIndex], array[index]];

                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            async savePersonalInfo(showNotification = true) {
                if (!this.currentCustomer) return;

                this.currentCustomer.personalInfo = {
                    name: document.getElementById('customerName').value,
                    gender: document.getElementById('gender').value,
                    birthDate: document.getElementById('birthDate').value,
                    age: document.getElementById('age').value,
                    height: document.getElementById('height').value,
                    weight: document.getElementById('weight').value,
                    bmi: document.getElementById('bmi').value,
                    waistCircumference: document.getElementById('waistCircumference').value,
                    customerService: document.getElementById('customerService').value,
                    sales: document.getElementById('sales').value,
                    smokingDrinking: document.getElementById('smokingDrinking').value,
                    residence: document.getElementById('residence').value,
                    maritalStatus: document.getElementById('maritalStatus').value,
                    customerPortrait: document.getElementById('customerPortrait').value,
                    dietaryHabitsInfo: document.getElementById('dietaryHabitsInfo').value,
                    activityExercise: document.getElementById('activityExercise').value,
                    sleepStress: document.getElementById('sleepStress').value,
                    otherHealthHabits: document.getElementById('otherHealthHabits').value
                };

                await this.saveCustomerData();
                if (showNotification) this.showSaveNotification();
            },

            // ================= ÂéÜÂè≤ËÆ∞ÂΩïË°®Ê†ºÊ∏≤Êüì =================
            
            // Ë°®Ê†ºÈÖçÁΩÆÂØπË±°
            tableConfigs: {
                allergyHistory: {
                    title: 'ËøáÊïèÂè≤',
                    headers: ['ËøáÊïèÂéüÁ±ªÂà´', 'ÂÖ∑‰ΩìËøáÊïèÂéü', 'ÂèçÂ∫î‰∏•ÈáçÁ®ãÂ∫¶', 'ËøáÊïèÂèçÂ∫îÊèèËø∞'],
                    fields: [
                        { key: 'allergenType' },
                        { key: 'allergen' },
                        { key: 'severity' },
                        { key: 'description', nl2br: true }
                    ],
                    formFields: [
                        { key: 'allergenType', label: 'ËøáÊïèÂéüÁ±ªÂà´', type: 'select', options: ['ËçØÁâ©', 'È£üÁâ©', 'ÁéØÂ¢É', 'ÂÖ∂‰ªñ'] },
                        { key: 'allergen', label: 'ÂÖ∑‰ΩìËøáÊïèÂéü', type: 'text', placeholder: 'ËØ∑ËæìÂÖ•ËøáÊïèÂéüÂêçÁß∞' },
                        { key: 'severity', label: 'ÂèçÂ∫î‰∏•ÈáçÁ®ãÂ∫¶', type: 'select', options: ['ËΩªÂ∫¶', '‰∏≠Â∫¶', 'ÈáçÂ∫¶'] },
                        { key: 'description', label: 'ËøáÊïèÂèçÂ∫îÊèèËø∞', type: 'textarea', rows: 3, placeholder: 'ÊèèËø∞ËøáÊïèÂèçÂ∫î' }
                    ]
                },
                medicationHistory: {
                    title: 'Áî®ËçØÂè≤',
                    headers: ['ËçØÁâ©ÂêçÁß∞', 'ËçØÁâ©Á±ªÂûã', 'Áî®ËçØÂéüÂõ†', 'ÂâÇÈáèÂèäÈ¢ëÁéá'],
                    fields: [
                        { key: 'medicationName' },
                        { key: 'medicationType' },
                        { key: 'reason', nl2br: true },
                        { key: 'dosageFrequency', nl2br: true }
                    ],
                    formFields: [
                        { key: 'medicationName', label: 'ËçØÁâ©ÂêçÁß∞', type: 'text', placeholder: 'ËØ∑ËæìÂÖ•ËçØÁâ©ÂêçÁß∞' },
                        { key: 'medicationType', label: 'ËçØÁâ©Á±ªÂûã', type: 'select', options: ['Â§ÑÊñπËçØ', 'ÈùûÂ§ÑÊñπËçØ', '‰∏≠ËçØ', '‰øùÂÅ•ÂìÅ'] },
                        { key: 'reason', label: 'Áî®ËçØÂéüÂõ†', type: 'textarea', rows: 3, placeholder: 'ËØ∑ËæìÂÖ•Áî®ËçØÂéüÂõ†' },
                        { key: 'dosageFrequency', label: 'ÂâÇÈáèÂèäÈ¢ëÁéá', type: 'textarea', rows: 2, placeholder: 'Â¶ÇÔºöÊØèÊó•2Ê¨°ÔºåÊØèÊ¨°1Áâá' }
                    ]
                },
                pastMedicalHistory: {
                    title: 'Êó¢ÂæÄÁóÖÂè≤',
                    headers: ['ÁñæÁóÖ/Áä∂ÂÜµÂêçÁß∞', 'ËÆ∞ÂΩïÁ±ªÂûã', 'ËØ¶ÊÉÖ'],
                    fields: [
                        { key: 'conditionName' },
                        { key: 'recordType' },
                        { key: 'currentStatus', nl2br: true }
                    ],
                    formFields: [
                        { key: 'conditionName', label: 'ÁñæÁóÖ/Áä∂ÂÜµ', type: 'text', placeholder: 'ËØ∑ËæìÂÖ•ÁñæÁóÖÊàñÁä∂ÂÜµÂêçÁß∞' },
                        { key: 'recordType', label: 'Á±ªÂûã', type: 'select', options: ['ÊÖ¢ÊÄßÁóÖ', 'ÊÄ•ÊÄßÁóÖ', '‰º†ÊüìÁóÖ', 'ÂÖ∂‰ªñ'] },
                        { key: 'currentStatus', label: 'ËØ¶ÊÉÖ', type: 'textarea', rows: 3, placeholder: 'ËØ∑ËæìÂÖ•ËØ¶ÁªÜÊÉÖÂÜµ' }
                    ]
                },
                surgeryHospitalizationHistory: {
                    title: 'ÊâãÊúØ‰∏é‰ΩèÈô¢Âè≤',
                    headers: ['‰∫ã‰ª∂ÂêçÁß∞', '‰∫ã‰ª∂Á±ªÂûã', 'ÁªìÊûú‰∏éÂΩ±Âìç'],
                    fields: [
                        { key: 'eventName' },
                        { key: 'eventType' },
                        { key: 'result', nl2br: true }
                    ],
                    formFields: [
                        { key: 'eventName', label: '‰∫ã‰ª∂ÂêçÁß∞', type: 'text', placeholder: 'Â¶ÇÔºöÈòëÂ∞æÁÇéÊâãÊúØ' },
                        { key: 'eventType', label: '‰∫ã‰ª∂Á±ªÂûã', type: 'select', options: ['ÊâãÊúØ', '‰ΩèÈô¢'] },
                        { key: 'result', label: 'ÁªìÊûú‰∏éÂΩ±Âìç', type: 'textarea', rows: 3, placeholder: 'ËØ∑ËæìÂÖ•ÁªìÊûúÂèäÂΩ±Âìç' }
                    ]
                },
                physicalExamSummary: {
                    title: '‰ΩìÊ£ÄÂ∞èÁªì',
                    headers: ['ÂêçÁß∞', 'ËØ¶ÁªÜÂÜÖÂÆπ'],
                    fields: [
                        { key: 'name' },
                        { key: 'detail', nl2br: true }
                    ],
                    formFields: [
                        { key: 'name', label: 'ÂêçÁß∞', type: 'text', placeholder: '‰ΩìÊ£ÄÈ°πÁõÆÂêçÁß∞' },
                        { key: 'detail', label: 'ËØ¶ÁªÜÂÜÖÂÆπ', type: 'textarea', rows: 4, placeholder: 'ËØ∑ËæìÂÖ•ËØ¶ÁªÜÂÜÖÂÆπ' }
                    ]
                },
                vaccinationHistory: {
                    title: 'Áñ´ËãóÊé•ÁßçÂè≤',
                    headers: ['Áñ´ËãóÂêçÁß∞', 'Â§áÊ≥®'],
                    fields: [
                        { key: 'vaccineName' },
                        { key: 'notes', nl2br: true }
                    ],
                    formFields: [
                        { key: 'vaccineName', label: 'Áñ´ËãóÂêçÁß∞', type: 'text', placeholder: 'Â¶ÇÔºöÊñ∞ÂÜ†Áñ´Ëãó' },
                        { key: 'notes', label: 'Â§áÊ≥®', type: 'textarea', rows: 2, placeholder: 'Êé•ÁßçÊó•Êúü„ÄÅÊâπÊ¨°Á≠â' }
                    ]
                },
                familyHistory: {
                    title: 'ÂÆ∂ÊóèÁóÖÂè≤',
                    headers: ['‰∫≤Â±ûÂÖ≥Á≥ª', 'ÁñæÁóÖ/Áä∂ÂÜµÂêçÁß∞', 'Â§áÊ≥®'],
                    fields: [
                        { key: 'relationship' },
                        { key: 'condition' },
                        { key: 'notes', nl2br: true }
                    ],
                    formFields: [
                        { key: 'relationship', label: '‰∫≤Â±ûÂÖ≥Á≥ª', type: 'select', options: ['Áà∂ÊØç', 'Á•ñÁà∂ÊØç', 'Â§ñÁ•ñÁà∂ÊØç', 'ÂÖÑÂºüÂßêÂ¶π', 'ÂÖ∂‰ªñ'] },
                        { key: 'condition', label: 'ÁñæÁóÖ/Áä∂ÂÜµ', type: 'text', placeholder: 'Â¶ÇÔºöÈ´òË°ÄÂéã' },
                        { key: 'notes', label: 'Â§áÊ≥®', type: 'textarea', rows: 2, placeholder: 'ÂèëÁóÖÂπ¥ÈæÑ„ÄÅÁóÖÊÉÖÁ≠â' }
                    ]
                },
                supplementIntervention: {
                    title: 'Ë°•ÂâÇÂèäÂπ≤È¢ÑÊñπÂêë',
                    headers: ['Âπ≤È¢ÑÊñπÂêë', 'Ë°•ÂâÇÂÜÖÂÆπ', 'Â§áÊ≥®'],
                    fields: [
                        { key: 'direction' },
                        { key: 'content', nl2br: true },
                        { key: 'notes', nl2br: true }
                    ],
                    formFields: [
                        { key: 'direction', label: 'Âπ≤È¢ÑÊñπÂêë', type: 'text', placeholder: 'Â¶ÇÔºöÂøÉË°ÄÁÆ°ÂÅ•Â∫∑' },
                        { key: 'content', label: 'Ë°•ÂâÇÂÜÖÂÆπ', type: 'textarea', rows: 3, placeholder: 'Ë°•ÂâÇÂêçÁß∞„ÄÅÁî®ÈáèÁ≠â' },
                        { key: 'notes', label: 'Â§áÊ≥®', type: 'textarea', rows: 2, placeholder: 'Ê≥®ÊÑè‰∫ãÈ°πÁ≠â' }
                    ]
                },
                communicationRecords: {
                    title: '‰ºÅÂæÆÊ≤üÈÄöËÆ∞ÂΩï',
                    headers: ['Êó•Êúü', 'ÂÖ≥ÈîÆËØç', 'ÂÜÖÂÆπ'],
                    fields: [
                        { key: 'date' },
                        { key: 'keyword' },
                        { key: 'content', nl2br: true }
                    ],
                    formFields: [
                        { key: 'date', label: 'Êó•Êúü', type: 'date' },
                        { key: 'keyword', label: 'ÂÖ≥ÈîÆËØç', type: 'text', placeholder: 'Ê≤üÈÄö‰∏ªÈ¢ò' },
                        { key: 'content', label: 'ÂÜÖÂÆπ', type: 'textarea', rows: 4, placeholder: 'Ê≤üÈÄöÂÜÖÂÆπ' }
                    ]
                },
                followUpRecords: {
                    title: 'ÂõûËÆøËÆ∞ÂΩï',
                    headers: ['Êó•Êúü', 'ÂÖ≥ÈîÆËØç', 'ÂÜÖÂÆπ'],
                    fields: [
                        { key: 'date' },
                        { key: 'keyword' },
                        { key: 'content', nl2br: true }
                    ],
                    formFields: [
                        { key: 'date', label: 'Êó•Êúü', type: 'date' },
                        { key: 'keyword', label: 'ÂÖ≥ÈîÆËØç', type: 'text', placeholder: 'ÂõûËÆø‰∏ªÈ¢ò' },
                        { key: 'content', label: 'ÂÜÖÂÆπ', type: 'textarea', rows: 4, placeholder: 'ÂõûËÆøÂÜÖÂÆπ' }
                    ]
                }
            },

            // ÈÄöÁî®Ë°®Ê†ºÊ∏≤ÊüìÂáΩÊï∞
            renderHistoryTable(records, configKey) {
                if (records.length === 0) {
                    return this.createEmptyState(this.uiConfig.messages.emptyRecords);
                }
                
                const config = this.tableConfigs[configKey];
                if (!config) {
                    console.error(`ÈÖçÁΩÆ ${configKey} ‰∏çÂ≠òÂú®`);
                    return '';
                }
                
                // Ë°®Â§¥
                let html = '<table class="readonly-table"><thead><tr>';
                config.headers.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                // Êï∞ÊçÆË°å
                records.forEach((record) => {
                    html += '<tr>';
                    config.fields.forEach(field => {
                        const value = record[field.key] || '';
                        // Â¶ÇÊûúÈúÄË¶ÅÊç¢Ë°åÂ§ÑÁêÜ
                        const displayValue = field.nl2br ? value.replace(/\n/g, '<br>') : value;
                        html += `<td>${displayValue}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                return html;
            },

            renderAllergyHistoryTable(records) {
                return this.renderHistoryTable(records, 'allergyHistory');
            },

            renderMedicationHistoryTable(records) {
                return this.renderHistoryTable(records, 'medicationHistory');
            },

            renderPastMedicalHistoryTable(records) {
                return this.renderHistoryTable(records, 'pastMedicalHistory');
            },

            renderSurgeryHospitalizationHistoryTable(records) {
                return this.renderHistoryTable(records, 'surgeryHospitalizationHistory');
            },

            renderPhysicalExamSummaryTable(records) {
                return this.renderHistoryTable(records, 'physicalExamSummary');
            },

            renderVaccinationHistoryTable(records) {
                return this.renderHistoryTable(records, 'vaccinationHistory');
            },

            renderFamilyHistoryTable(records) {
                return this.renderHistoryTable(records, 'familyHistory');
            },

            bindHistoryTableEvents(containerId, fieldName) {
                const container = this.getEl(containerId);
                if (!container) return;
                container.querySelectorAll('input, select, textarea').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const field = e.target.dataset.field;
                        this.ensureArray(this.currentCustomer, fieldName);
                        if (this.currentCustomer[fieldName][index]) {
                            this.currentCustomer[fieldName][index][field] = e.target.value;
                            this.autoSavePersonalInfo();
                        }
                    });
                });
            },

            // ================= Êñ∞Â¢ûÔºöË°®Ê†ºÊãñÊãΩÂäüËÉΩ =================
            addAllergyHistoryRecord() {
                if (!this.currentCustomer.allergyHistory) this.currentCustomer.allergyHistory = [];
                this.currentCustomer.allergyHistory.push({ allergenType: 'ËçØÁâ©', allergen: '', severity: 'ËΩªÂ∫¶', description: '' });
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
                // Ëá™Âä®Â±ïÂºÄÂç°Áâá
                setTimeout(() => {
                    const panel = document.getElementById('allergyHistoryPanel');
                    if (panel && panel.classList.contains('collapsed')) {
                        panel.classList.remove('collapsed');
                    }
                }, 50);
            },
            removeAllergyHistoryRecord(index) {
                this.currentCustomer.allergyHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            addMedicationHistoryRecord() {
                if (!this.currentCustomer.medicationHistory) this.currentCustomer.medicationHistory = [];
                this.currentCustomer.medicationHistory.push({ medicationName: '', medicationType: 'Â§ÑÊñπËçØ', reason: '', dosageFrequency: '' });
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
                // Ëá™Âä®Â±ïÂºÄÂç°Áâá
                setTimeout(() => {
                    const panel = document.getElementById('medicationHistoryPanel');
                    if (panel && panel.classList.contains('collapsed')) {
                        panel.classList.remove('collapsed');
                    }
                }, 50);
            },
            removeMedicationHistoryRecord(index) {
                this.currentCustomer.medicationHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            addPastMedicalHistoryRecord() {
                if (!this.currentCustomer.pastMedicalHistory) this.currentCustomer.pastMedicalHistory = [];
                this.currentCustomer.pastMedicalHistory.push({ conditionName: '', recordType: 'ÊÖ¢ÊÄßÁóÖ', currentStatus: '' });
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
                // Ëá™Âä®Â±ïÂºÄÂç°Áâá
                setTimeout(() => {
                    const panel = document.getElementById('pastMedicalHistoryPanel');
                    if (panel && panel.classList.contains('collapsed')) {
                        panel.classList.remove('collapsed');
                    }
                }, 50);
            },
            removePastMedicalHistoryRecord(index) {
                this.currentCustomer.pastMedicalHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            addSurgeryHospitalizationHistoryRecord() {
                if (!this.currentCustomer.surgeryHospitalizationHistory) this.currentCustomer.surgeryHospitalizationHistory = [];
                this.currentCustomer.surgeryHospitalizationHistory.push({ eventName: '', eventType: 'ÊâãÊúØ', result: '' });
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
                // Ëá™Âä®Â±ïÂºÄÂç°Áâá
                setTimeout(() => {
                    const panel = document.getElementById('surgeryHistoryPanel');
                    if (panel && panel.classList.contains('collapsed')) {
                        panel.classList.remove('collapsed');
                    }
                }, 50);
            },
            removeSurgeryHospitalizationHistoryRecord(index) {
                this.currentCustomer.surgeryHospitalizationHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            addPhysicalExamSummaryRecord() {
                if (!this.currentCustomer.physicalExamSummary) this.currentCustomer.physicalExamSummary = [];
                this.currentCustomer.physicalExamSummary.push({ name: '', detail: '' });
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
                // Ëá™Âä®Â±ïÂºÄÂç°Áâá
                setTimeout(() => {
                    const panel = document.getElementById('physicalExamPanel');
                    if (panel && panel.classList.contains('collapsed')) {
                        panel.classList.remove('collapsed');
                    }
                }, 50);
            },
            removePhysicalExamSummaryRecord(index) {
                this.currentCustomer.physicalExamSummary.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            addVaccinationHistoryRecord() {
                if (!this.currentCustomer.vaccinationHistory) this.currentCustomer.vaccinationHistory = [];
                this.currentCustomer.vaccinationHistory.push({ vaccineName: '', notes: '' });
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
                // Ëá™Âä®Â±ïÂºÄÂç°Áâá
                setTimeout(() => {
                    const panel = document.getElementById('vaccinationHistoryPanel');
                    if (panel && panel.classList.contains('collapsed')) {
                        panel.classList.remove('collapsed');
                    }
                }, 50);
            },
            removeVaccinationHistoryRecord(index) {
                this.currentCustomer.vaccinationHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            addFamilyHistoryRecord() {
                if (!this.currentCustomer.familyHistory) this.currentCustomer.familyHistory = [];
                this.currentCustomer.familyHistory.push({ relationship: 'Áà∂ÊØç', condition: '', notes: '' });
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
                // Ëá™Âä®Â±ïÂºÄÂç°Áâá
                setTimeout(() => {
                    const panel = document.getElementById('familyHistoryPanel');
                    if (panel && panel.classList.contains('collapsed')) {
                        panel.classList.remove('collapsed');
                    }
                }, 50);
            },
            removeFamilyHistoryRecord(index) {
                this.currentCustomer.familyHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            async autoSavePersonalInfo() {
                await this.savePersonalInfo(false);
            },

            // ================= Ë¥¶Êúü‰ø°ÊÅØÁõ∏ÂÖ≥ =================
            renderPeriodSelector(customer) {
                const periodSelect = document.getElementById('periodSelect');
                periodSelect.innerHTML = '';

                if (customer.periods && customer.periods.length > 0) {
                    const sortedPeriods = [...customer.periods].sort((a, b) => b.periodName.localeCompare(a.periodName));
                    sortedPeriods.forEach(period => {
                        const option = document.createElement('option');
                        option.value = period.periodId;
                        option.textContent = period.periodName;
                        periodSelect.appendChild(option);
                    });
                    this.currentPeriod = sortedPeriods[0];
                    periodSelect.value = this.currentPeriod.periodId;
                    this.renderPeriodForm(this.currentPeriod);
                } else {
                    this.currentPeriod = null;
                    document.getElementById('periodFormContainer').innerHTML = '<p style="color: var(--ios-gray); text-align: center;">ÊöÇÊó†Ë¥¶Êúü‰ø°ÊÅØ</p>';
                }
            },

            renderPeriodForm(period) {
                // ‰øùÂ≠òË¥¶ÊúüÂç°ÁâáÁä∂ÊÄÅ
                const cardStates = {};
                const cardIds = ['supplementCard', 'communicationCard', 'followUpCard'];
                cardIds.forEach(id => {
                    const card = document.getElementById(id);
                    if (card) {
                        cardStates[id] = !card.classList.contains('collapsed');
                    }
                });

                const container = document.getElementById('periodFormContainer');
                container.innerHTML = `
                    <form id="periodForm" class="three-column-form">
                        <div class="form-group">
                            <label for="periodName">Ë¥¶ÊúüÂêçÁß∞</label>
                            <input type="text" id="periodName" value="${period.periodName || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label for="deliveryDate">‰∫§‰ªòÊó∂Èó¥</label>
                            <input type="date" id="deliveryDate" value="${period.deliveryDate || ''}">
                        </div>
                        <div class="form-group">
                            <label for="nextDeliveryDate">‰∏ãÊ¨°‰∫§‰ªòÊó∂Èó¥</label>
                            <input type="date" id="nextDeliveryDate" value="${period.nextDeliveryDate || ''}">
                        </div>
                        <div class="form-group full-width">
                            <div class="modern-card collapsed ${period.supplementIntervention?.length > 0 ? 'has-data color-blue' : ''}" id="supplementCard">
                                <div class="modern-card-header" onclick="ViewController.toggleModernCard('supplementCard')">
                                    <div class="modern-card-title">
                                        <span class="modern-card-icon">üíä</span>
                                        <span>Ë°•ÂâÇÂèäÂπ≤È¢ÑÊñπÂêë<span class="record-count">(${period.supplementIntervention?.length || 0})</span></span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="edit-icon" onclick="event.stopPropagation(); ViewController.openEditModal('supplementIntervention', true);" title="ÁºñËæë">‚úèÔ∏è</span>
                                        <span class="add-icon add-supplement-icon" onclick="event.stopPropagation(); ViewController.openAddModal('supplementIntervention', true);" style="margin: 0;">Ôºã</span>
                                        <span class="modern-card-toggle">‚ñº</span>
                                    </div>
                                </div>
                                <div class="modern-card-content">
                                    <div class="modern-card-body">
                                        <div id="supplementInterventionContainer">
                                            ${this.renderSupplementInterventionTable(period.supplementIntervention || [])}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="modern-card collapsed ${period.communicationRecords?.length > 0 ? 'has-data color-blue' : ''}" id="communicationCard">
                                <div class="modern-card-header" onclick="ViewController.toggleModernCard('communicationCard')">
                                    <div class="modern-card-title">
                                        <span class="modern-card-icon">üí¨</span>
                                        <span>‰ºÅÂæÆÊ≤üÈÄöËÆ∞ÂΩï<span class="record-count">(${period.communicationRecords?.length || 0})</span></span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="edit-icon" onclick="event.stopPropagation(); ViewController.openEditModal('communicationRecords', true);" title="ÁºñËæë">‚úèÔ∏è</span>
                                        <span class="add-icon add-communication-icon" onclick="event.stopPropagation(); ViewController.openAddModal('communicationRecords', true);" style="margin: 0;">Ôºã</span>
                                        <span class="modern-card-toggle">‚ñº</span>
                                    </div>
                                </div>
                                <div class="modern-card-content">
                                    <div class="modern-card-body">
                                        <div id="communicationRecordsContainer">
                                            ${this.renderCommunicationRecords(period.communicationRecords || [])}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <div class="modern-card collapsed ${period.followUpRecords?.length > 0 ? 'has-data color-blue' : ''}" id="followUpCard">
                                <div class="modern-card-header" onclick="ViewController.toggleModernCard('followUpCard')">
                                    <div class="modern-card-title">
                                        <span class="modern-card-icon">üìû</span>
                                        <span>ÂõûËÆøËÆ∞ÂΩï<span class="record-count">(${period.followUpRecords?.length || 0})</span></span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="edit-icon" onclick="event.stopPropagation(); ViewController.openEditModal('followUpRecords', true);" title="ÁºñËæë">‚úèÔ∏è</span>
                                        <span class="add-icon add-followup-icon" onclick="event.stopPropagation(); ViewController.openAddModal('followUpRecords', true);" style="margin: 0;">Ôºã</span>
                                        <span class="modern-card-toggle">‚ñº</span>
                                    </div>
                                </div>
                                <div class="modern-card-content">
                                    <div class="modern-card-body">
                                        <div id="followUpRecordsContainer">
                                            ${this.renderFollowUpRecords(period.followUpRecords || [])}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                `;

                // ‰∫ã‰ª∂ÁªëÂÆöÂ∑≤Êîπ‰∏∫inline onclick
                // document.querySelector('.add-supplement-icon').addEventListener('click', () => this.addSupplementInterventionRecord());
                // document.querySelector('.add-communication-icon').addEventListener('click', () => this.addCommunicationRecord());
                // document.querySelector('.add-followup-icon').addEventListener('click', () => this.addFollowUpRecord());

                this.bindPeriodAutoSaveEvents();

                // ÊÅ¢Â§çË¥¶ÊúüÂç°ÁâáÁä∂ÊÄÅ
                setTimeout(() => {
                    Object.keys(cardStates).forEach(id => {
                        const card = document.getElementById(id);
                        if (card) {
                            if (cardStates[id]) {
                                card.classList.remove('collapsed');
                            } else {
                                card.classList.add('collapsed');
                            }
                        }
                    });
                }, 10);
            },

            renderSupplementInterventionTable(records) {
                return this.renderHistoryTable(records, 'supplementIntervention');
            },

            renderCommunicationRecords(records) {
                return this.renderHistoryTable(records, 'communicationRecords');
            },

            renderFollowUpRecords(records) {
                return this.renderHistoryTable(records, 'followUpRecords');
            },

            bindPeriodAutoSaveEvents() {
                document.querySelectorAll('#periodForm input, #periodForm select, #periodForm textarea').forEach(el => {
                    el.addEventListener('change', () => this.autoSavePeriodInfo());
                });

                document.querySelectorAll('.supplement-field, .communication-field, .followup-field').forEach(el => {
                    el.addEventListener('change', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const field = e.target.dataset.field;
                        const value = e.target.value;

                        if (e.target.classList.contains('supplement-field')) {
                            if (!this.currentPeriod.supplementIntervention) this.currentPeriod.supplementIntervention = [];
                            if (this.currentPeriod.supplementIntervention[index]) {
                                this.currentPeriod.supplementIntervention[index][field] = value;
                            }
                        } else if (e.target.classList.contains('communication-field')) {
                            if (!this.currentPeriod.communicationRecords) this.currentPeriod.communicationRecords = [];
                            if (this.currentPeriod.communicationRecords[index]) {
                                this.currentPeriod.communicationRecords[index][field] = value;
                            }
                        } else if (e.target.classList.contains('followup-field')) {
                            if (!this.currentPeriod.followUpRecords) this.currentPeriod.followUpRecords = [];
                            if (this.currentPeriod.followUpRecords[index]) {
                                this.currentPeriod.followUpRecords[index][field] = value;
                            }
                        }
                        this.autoSavePeriodInfo();
                    });
                });
            },

            // ================= Êñ∞Â¢ûÔºöË¥¶ÊúüË°®Ê†ºÊãñÊãΩÂäüËÉΩ =================
            addSupplementInterventionRecord() {
                if (!this.currentPeriod.supplementIntervention) this.currentPeriod.supplementIntervention = [];
                this.currentPeriod.supplementIntervention.push({ direction: '', content: '', notes: '' });
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
                // Ëá™Âä®Â±ïÂºÄÂç°Áâá
                setTimeout(() => {
                    const card = document.getElementById('supplementCard');
                    if (card && card.classList.contains('collapsed')) {
                        card.classList.remove('collapsed');
                    }
                }, 50);
            },
            removeSupplementInterventionRecord(index) {
                this.currentPeriod.supplementIntervention.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            addCommunicationRecord() {
                if (!this.currentPeriod.communicationRecords) this.currentPeriod.communicationRecords = [];
                this.currentPeriod.communicationRecords.push({ date: new Date().toISOString().split('T')[0], keyword: '', content: '' });
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
                // Ëá™Âä®Â±ïÂºÄÂç°Áâá
                setTimeout(() => {
                    const card = document.getElementById('communicationCard');
                    if (card && card.classList.contains('collapsed')) {
                        card.classList.remove('collapsed');
                    }
                }, 50);
            },
            removeCommunicationRecord(index) {
                this.currentPeriod.communicationRecords.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            addFollowUpRecord() {
                if (!this.currentPeriod.followUpRecords) this.currentPeriod.followUpRecords = [];
                this.currentPeriod.followUpRecords.push({ date: new Date().toISOString().split('T')[0], keyword: '', content: '' });
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
                // Ëá™Âä®Â±ïÂºÄÂç°Áâá
                setTimeout(() => {
                    const card = document.getElementById('followUpCard');
                    if (card && card.classList.contains('collapsed')) {
                        card.classList.remove('collapsed');
                    }
                }, 50);
            },
            removeFollowUpRecord(index) {
                this.currentPeriod.followUpRecords.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // ÁßªÂä®Ë¥¶ÊúüË°®Ê†ºË°å

            // ================= ÁºñËæëÁ™óÂè£Áõ∏ÂÖ≥ÂáΩÊï∞ =================
            editModalData: {
                fieldName: '',
                isPeriod: false,
                records: [],
                selectedIndexes: new Set(),
                draggedIndex: null
            },

            openEditModal(fieldName, isPeriod = false) {
                this.editModalData.fieldName = fieldName;
                this.editModalData.isPeriod = isPeriod;
                this.editModalData.selectedIndexes.clear();

                const source = this.getCurrentSource(isPeriod);
                this.editModalData.records = this.deepClone(source[fieldName] || []);

                const title = this.tableConfigs[fieldName]?.title || fieldName;
                this.getEl('editModalTitle').textContent = `ÁºñËæë - ${title}`;

                this.renderEditModalList();
                this.showModal('editRecordModal');
            },

            closeEditModal() {
                this.hideModal('editRecordModal');
                this.editModalData = {
                    fieldName: '',
                    isPeriod: false,
                    records: [],
                    selectedIndexes: new Set(),
                    draggedIndex: null
                };
            },

            renderEditModalList() {
                const container = this.getEl('editModalList');
                const { records } = this.editModalData;

                if (records.length === 0) {
                    container.innerHTML = this.createEmptyState(this.uiConfig.messages.emptyAddPrompt);
                    this.getEl('deleteSelectedBtn').style.display = 'none';
                    return;
                }

                let html = '';
                records.forEach((record, index) => {
                    const displayText = this.getRecordDisplayText(this.editModalData.fieldName, record);
                    const isSelected = this.editModalData.selectedIndexes.has(index);

                    html += `
                        <div class="edit-list-item" draggable="true"
                             data-index="${index}"
                             ondragstart="ViewController.handleDragStart(event, ${index})"
                             ondragover="ViewController.handleDragOver(event)"
                             ondrop="ViewController.handleDrop(event, ${index})"
                             ondragend="ViewController.handleDragEnd(event)">
                            <div class="edit-checkbox ${isSelected ? 'checked' : ''}"
                                 onclick="ViewController.toggleSelectRecord(${index})"></div>
                            <div class="edit-item-content" onclick="ViewController.editRecord(${index})">
                                ${displayText}
                            </div>
                            <div class="edit-drag-handle">‚ãÆ</div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                this.getEl('deleteSelectedBtn').style.display =
                    this.editModalData.selectedIndexes.size > 0 ? 'block' : 'none';
            },

            getRecordDisplayText(fieldName, record) {
                const unnamed = this.uiConfig.messages.unnamed;
                const templates = {
                    'allergyHistory': `<div class="item-title">${record.allergen || unnamed}</div><div class="item-detail">${record.allergenType || ''} - ${record.severity || ''}</div>`,
                    'medicationHistory': `<div class="item-title">${record.medicationName || unnamed}</div><div class="item-detail">${record.medicationType || ''}</div>`,
                    'pastMedicalHistory': `<div class="item-title">${record.conditionName || unnamed}</div><div class="item-detail">${record.recordType || ''}</div>`,
                    'surgeryHospitalizationHistory': `<div class="item-title">${record.eventName || unnamed}</div><div class="item-detail">${record.eventType || ''}</div>`,
                    'physicalExamSummary': `<div class="item-title">${record.name || unnamed}</div>`,
                    'vaccinationHistory': `<div class="item-title">${record.vaccineName || unnamed}</div>`,
                    'familyHistory': `<div class="item-title">${record.relationship || ''} - ${record.condition || unnamed}</div>`,
                    'supplementIntervention': `<div class="item-title">${record.direction || unnamed}</div>`,
                    'communicationRecords': `<div class="item-title">${record.date || ''} - ${record.keyword || unnamed}</div>`,
                    'followUpRecords': `<div class="item-title">${record.date || ''} - ${record.keyword || unnamed}</div>`
                };
                return templates[fieldName] || `<div class="item-title">${this.uiConfig.messages.defaultRecord}</div>`;
            },

            toggleSelectRecord(index) {
                if (this.editModalData.selectedIndexes.has(index)) {
                    this.editModalData.selectedIndexes.delete(index);
                } else {
                    this.editModalData.selectedIndexes.add(index);
                }
                this.renderEditModalList();
            },

            handleDragStart(event, index) {
                this.editModalData.draggedIndex = index;
                event.target.style.opacity = '0.5';
            },

            handleDragOver(event) {
                event.preventDefault();
            },

            handleDrop(event, dropIndex) {
                event.preventDefault();
                const dragIndex = this.editModalData.draggedIndex;

                if (dragIndex !== null && dragIndex !== dropIndex) {
                    const records = this.editModalData.records;
                    const draggedItem = records[dragIndex];
                    records.splice(dragIndex, 1);
                    records.splice(dropIndex, 0, draggedItem);

                    const newSelected = new Set();
                    this.editModalData.selectedIndexes.forEach(idx => {
                        if (idx === dragIndex) {
                            newSelected.add(dropIndex);
                        } else if (idx < dragIndex && idx >= dropIndex) {
                            newSelected.add(idx + 1);
                        } else if (idx > dragIndex && idx <= dropIndex) {
                            newSelected.add(idx - 1);
                        } else {
                            newSelected.add(idx);
                        }
                    });
                    this.editModalData.selectedIndexes = newSelected;

                    this.renderEditModalList();
                    
                    // ÊãñÊãΩÂêéËá™Âä®‰øùÂ≠ò
                    this.autoSaveEditModal();
                }
            },

            handleDragEnd(event) {
                event.target.style.opacity = '1';
                this.editModalData.draggedIndex = null;
            },

            deleteSelectedRecords() {
                if (this.editModalData.selectedIndexes.size === 0) return;

                if (!this.confirmDelete(this.editModalData.selectedIndexes.size)) return;

                const indexes = Array.from(this.editModalData.selectedIndexes).sort((a, b) => b - a);
                indexes.forEach(index => {
                    this.editModalData.records.splice(index, 1);
                });

                this.editModalData.selectedIndexes.clear();
                this.renderEditModalList();
                
                // Âà†Èô§ÂêéËá™Âä®‰øùÂ≠ò
                this.autoSaveEditModal();
            },

            async autoSaveEditModal() {
                const { fieldName, isPeriod, records } = this.editModalData;

                const source = this.getCurrentSource(isPeriod);
                source[fieldName] = records;

                await this.saveCustomerData();

                if (isPeriod) {
                    this.renderPeriodForm(this.currentPeriod);
                } else {
                    this.renderPersonalInfoForm(this.currentCustomer);
                }
            },

            // ================= Ê∑ªÂä†ËÆ∞ÂΩïÊ®°ÊÄÅÁ™óÂè£Áõ∏ÂÖ≥ =================
            addModalData: {
                fieldName: '',
                isPeriod: false
            },

            openAddModal(fieldName, isPeriod = false) {
                this.addModalData.fieldName = fieldName;
                this.addModalData.isPeriod = isPeriod;

                const title = this.tableConfigs[fieldName]?.title || fieldName;
                this.getEl('addModalTitle').textContent = `Ê∑ªÂä† - ${title}`;

                const formFields = this.getAddFormFields(fieldName);
                this.getEl('addModalFormContainer').innerHTML = formFields;

                this.showModal('addRecordModal');
            },

            closeAddModal() {
                this.hideModal('addRecordModal');
                this.addModalData = { fieldName: '', isPeriod: false };
            },

            // Ë°®ÂçïÊ†∑ÂºèÂ∏∏ÈáèÔºàÂü∫‰∫éuiConfigÔºâ
            get formStyles() {
                const c = this.uiConfig.colors;
                const s = this.uiConfig.spacing;
                const f = this.uiConfig.fontSize;
                const r = this.uiConfig.borderRadius;
                
                return {
                    field: `width: 100%; padding: ${s.md}; border: 1px solid ${c.border}; border-radius: ${r.base}; font-size: ${f.base}; background: ${c.bgWhite};`,
                    label: `display: block; margin-bottom: ${s.sm}; font-weight: 500; font-size: ${f.base}; color: ${c.text};`,
                    group: `margin-bottom: ${s.xl};`
                };
            },
            
            // UIËæÖÂä©ÊñπÊ≥ïÔºöÁîüÊàêÊåâÈíÆHTML
            createButton(text, type = 'primary', onClick = '', extraStyle = '') {
                const btnStyle = this.uiConfig.button[type] || this.uiConfig.button.primary;
                const onclickAttr = onClick ? `onclick="${onClick}"` : '';
                return `<button ${onclickAttr} style="${btnStyle} ${extraStyle}">${text}</button>`;
            },
            
            // UIËæÖÂä©ÊñπÊ≥ïÔºöÁîüÊàêÁ©∫Áä∂ÊÄÅÊèêÁ§∫
            createEmptyState(message) {
                const msg = message || this.uiConfig.messages.empty;
                const { colors, spacing } = this.uiConfig;
                return `<p style="color: ${colors.textSecondary}; text-align: center; padding: ${spacing.xxxl};">${msg}</p>`;
            },
            
            // Êï∞ÊçÆËæÖÂä©ÊñπÊ≥ïÔºöÂÆâÂÖ®Ëé∑ÂèñÊàñÂàùÂßãÂåñÊï∞ÁªÑ
            ensureArray(obj, key) {
                if (!obj[key]) obj[key] = [];
                return obj[key];
            },
            
            // Êï∞ÊçÆËæÖÂä©ÊñπÊ≥ïÔºöËé∑ÂèñÂΩìÂâçÊï∞ÊçÆÊ∫êÔºàÂÆ¢Êà∑ÊàñÂë®ÊúüÔºâ
            getCurrentSource(isPeriod) {
                return isPeriod ? this.currentPeriod : this.currentCustomer;
            },
            
            // Êï∞ÊçÆËæÖÂä©ÊñπÊ≥ïÔºöÁ°ÆËÆ§Âà†Èô§Êìç‰Ωú
            confirmDelete(count = 1) {
                const msg = count === 1 
                    ? this.uiConfig.messages.deleteConfirm 
                    : this.uiConfig.messages.deleteMultipleConfirm(count);
                return confirm(msg);
            },
            
            // DOMËæÖÂä©ÊñπÊ≥ïÔºöÂø´ÈÄüËé∑ÂèñÂÖÉÁ¥†ÔºàÂ∏¶ÁºìÂ≠òÔºâ
            getEl(id, useCache = true) {
                if (useCache) {
                    if (!this._cache.dom.has(id)) {
                        this._cache.dom.set(id, document.getElementById(id));
                    }
                    return this._cache.dom.get(id);
                }
                return document.getElementById(id);
            },
            
            // DOMËæÖÂä©ÊñπÊ≥ïÔºöÊ∏ÖÈô§DOMÁºìÂ≠ò
            clearDOMCache() {
                this._cache.dom.clear();
            },
            
            // DOMËæÖÂä©ÊñπÊ≥ïÔºöÂø´ÈÄüÊü•ËØ¢ÂÖÉÁ¥†
            queryEl(selector) {
                return document.querySelector(selector);
            },
            
            // DOMËæÖÂä©ÊñπÊ≥ïÔºöÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            showModal(modalId) {
                this.getEl(modalId)?.classList.add('active');
            },
            
            // DOMËæÖÂä©ÊñπÊ≥ïÔºöÈöêËóèÊ®°ÊÄÅÊ°Ü
            hideModal(modalId) {
                this.getEl(modalId)?.classList.remove('active');
            },
            
            // ÊÄßËÉΩ‰ºòÂåñÔºöÈÄöÁî®Èò≤ÊäñÂáΩÊï∞
            debounce(key, callback, delay = 300) {
                if (this._cache.debounceTimers.has(key)) {
                    clearTimeout(this._cache.debounceTimers.get(key));
                }
                
                const timer = setTimeout(() => {
                    callback();
                    this._cache.debounceTimers.delete(key);
                }, delay);
                
                this._cache.debounceTimers.set(key, timer);
            },
            
            // ÊÄßËÉΩ‰ºòÂåñÔºöËäÇÊµÅÂáΩÊï∞
            throttle(key, callback, delay = 300) {
                if (this._cache.debounceTimers.has(key)) {
                    return; // Ê≠£Âú®ÊâßË°åÔºåË∑≥Ëøá
                }
                
                callback();
                const timer = setTimeout(() => {
                    this._cache.debounceTimers.delete(key);
                }, delay);
                
                this._cache.debounceTimers.set(key, timer);
            },
            
            // ÊÄßËÉΩ‰ºòÂåñÔºöÈ´òÊïàÊ∑±Êã∑Ë¥ùÔºà‰ΩøÁî®structuredCloneÊàñJSONÔºâ
            deepClone(obj) {
                // ‰ºòÂÖà‰ΩøÁî®Áé∞‰ª£ÊµèËßàÂô®ÁöÑstructuredClone
                if (typeof structuredClone !== 'undefined') {
                    return structuredClone(obj);
                }
                // ÈôçÁ∫ßÂà∞JSONÊñπÊ≥ï
                return JSON.parse(JSON.stringify(obj));
            },
            
            // ÊÄßËÉΩ‰ºòÂåñÔºöÊâπÈáèDOMÊõ¥Êñ∞Ôºà‰ΩøÁî®DocumentFragmentÔºâ
            batchDOMUpdate(container, htmlArray) {
                const fragment = document.createDocumentFragment();
                const temp = document.createElement('div');
                temp.innerHTML = htmlArray.join('');
                while (temp.firstChild) {
                    fragment.appendChild(temp.firstChild);
                }
                container.innerHTML = '';
                container.appendChild(fragment);
            },
            
            // ÊÄßËÉΩ‰ºòÂåñÔºörequestAnimationFrameÂ∞ÅË£Ö
            scheduleUpdate(callback) {
                if (typeof requestAnimationFrame !== 'undefined') {
                    requestAnimationFrame(callback);
                } else {
                    setTimeout(callback, 16); // ~60fps
                }
            },
            
            // ÊÄßËÉΩ‰ºòÂåñÔºöÂàÜÊâπÊ∏≤ÊüìÂ§ßÂàóË°®
            renderLargeList(items, renderItem, batchSize = 50) {
                const container = document.createDocumentFragment();
                let currentBatch = 0;
                
                const renderBatch = () => {
                    const start = currentBatch * batchSize;
                    const end = Math.min(start + batchSize, items.length);
                    
                    for (let i = start; i < end; i++) {
                        const element = renderItem(items[i], i);
                        if (typeof element === 'string') {
                            const temp = document.createElement('div');
                            temp.innerHTML = element;
                            container.appendChild(temp.firstChild);
                        } else {
                            container.appendChild(element);
                        }
                    }
                    
                    currentBatch++;
                    
                    if (end < items.length) {
                        this.scheduleUpdate(renderBatch);
                    } else {
                        return container;
                    }
                };
                
                renderBatch();
                return container;
            },

            // ÈÄöÁî®Ë°®ÂçïÂ≠óÊÆµÁîüÊàêÂáΩÊï∞
            generateFormField(fieldConfig) {
                const { key, label, type, options, rows, placeholder } = fieldConfig;
                const { field: fieldStyle, label: labelStyle, group: groupStyle } = this.formStyles;
                const fieldId = `addField_${key}`;
                
                let inputHtml = '';
                
                if (type === 'select') {
                    inputHtml = `<select id="${fieldId}" style="${fieldStyle}">`;
                    options.forEach(opt => {
                        inputHtml += `<option value="${opt}">${opt}</option>`;
                    });
                    inputHtml += `</select>`;
                } else if (type === 'textarea') {
                    inputHtml = `<textarea id="${fieldId}" rows="${rows || 3}" placeholder="${placeholder || ''}" style="${fieldStyle} resize: vertical;"></textarea>`;
                } else if (type === 'date') {
                    inputHtml = `<input type="date" id="${fieldId}" style="${fieldStyle}">`;
                } else {
                    inputHtml = `<input type="text" id="${fieldId}" placeholder="${placeholder || ''}" style="${fieldStyle}">`;
                }
                
                return `
                    <div style="${groupStyle}">
                        <label style="${labelStyle}">${label}</label>
                        ${inputHtml}
                    </div>
                `;
            },

            getAddFormFields(fieldName) {
                const config = this.tableConfigs[fieldName];
                if (!config || !config.formFields) return '';
                
                return config.formFields.map(field => this.generateFormField(field)).join('');
            },

            async confirmAddRecord() {
                const { fieldName, isPeriod } = this.addModalData;
                const source = this.getCurrentSource(isPeriod);

                this.ensureArray(source, fieldName);

                const newRecord = {};
                const fields = document.querySelectorAll('[id^="addField_"]');
                
                fields.forEach(field => {
                    const fieldKey = field.id.replace('addField_', '');
                    newRecord[fieldKey] = field.value;
                });

                source[fieldName].push(newRecord);

                await this.saveCustomerData();

                if (isPeriod) {
                    this.renderPeriodForm(this.currentPeriod);
                } else {
                    this.renderPersonalInfoForm(this.currentCustomer);
                }

                this.closeAddModal();
            },

            editRecord(index, isNew = false) {
                const { fieldName, records } = this.editModalData;
                const record = records[index];

                // Ê†πÊçÆÊòØÂê¶‰∏∫Êñ∞Á∫™ÂΩï‰øÆÊîπÊ†áÈ¢ò
                const title = this.tableConfigs[fieldName]?.title || fieldName;
                const titlePrefix = isNew ? 'Ê∑ªÂä†Êñ∞Á∫™ÂΩï' : 'ÁºñËæëËÆ∞ÂΩï';
                this.getEl('editModalTitle').textContent = `${titlePrefix} - ${title}`;

                const formFields = this.getEditFormFields(fieldName, record);
                const { spacing } = this.uiConfig;
                
                const cancelBtn = this.createButton('ÂèñÊ∂à', 'secondary', `ViewController.cancelEditRecord(${isNew})`, 'flex: 1;');
                const saveBtn = this.createButton('‰øùÂ≠ò', 'primary', `ViewController.saveEditRecord(${index}, ${isNew})`, 'flex: 1;');
                
                const formHtml = `
                    <div style="padding: ${spacing.xl};">
                        ${formFields}
                        <div style="display: flex; gap: ${spacing.md}; margin-top: ${spacing.xl};">
                            ${cancelBtn}
                            ${saveBtn}
                        </div>
                    </div>
                `;

                this.getEl('editModalList').innerHTML = formHtml;
            },

            // ÈÄöÁî®ÁºñËæëË°®ÂçïÂ≠óÊÆµÁîüÊàêÂáΩÊï∞
            generateEditFormField(fieldConfig, record) {
                const { key, label, type, options, rows, placeholder } = fieldConfig;
                const { field: fieldStyle, label: labelStyle, group: groupStyle } = this.formStyles;
                const fieldId = `editField_${key}`;
                const value = record[key] || '';
                
                let inputHtml = '';
                
                if (type === 'select') {
                    inputHtml = `<select id="${fieldId}" style="${fieldStyle}">`;
                    options.forEach(opt => {
                        const selected = value === opt ? 'selected' : '';
                        inputHtml += `<option value="${opt}" ${selected}>${opt}</option>`;
                    });
                    inputHtml += `</select>`;
                } else if (type === 'textarea') {
                    inputHtml = `<textarea id="${fieldId}" rows="${rows || 3}" placeholder="${placeholder || ''}" style="${fieldStyle} resize: vertical;">${value}</textarea>`;
                } else if (type === 'date') {
                    inputHtml = `<input type="date" id="${fieldId}" value="${value}" style="${fieldStyle}">`;
                } else {
                    inputHtml = `<input type="text" id="${fieldId}" value="${value}" placeholder="${placeholder || ''}" style="${fieldStyle}">`;
                }
                
                return `
                    <div style="${groupStyle}">
                        <label style="${labelStyle}">${label}</label>
                        ${inputHtml}
                    </div>
                `;
            },

            getEditFormFields(fieldName, record) {
                const config = this.tableConfigs[fieldName];
                if (!config || !config.formFields) return '';
                
                return config.formFields.map(field => this.generateEditFormField(field, record)).join('');
            },
            cancelEditRecord(isNew = false) {
                if (isNew) {
                    // Â¶ÇÊûúÊòØÊñ∞Á∫™ÂΩïË¢´ÂèñÊ∂àÔºåÂà†Èô§ÊúÄÂêéÊ∑ªÂä†ÁöÑÁ©∫ËÆ∞ÂΩï
                    this.editModalData.records.pop();
                }
                // ÊÅ¢Â§çÊ†áÈ¢ò
                const title = this.tableConfigs[this.editModalData.fieldName]?.title || this.editModalData.fieldName;
                this.getEl('editModalTitle').textContent = `ÁºñËæë - ${title}`;
                // ÊÅ¢Â§çÂ∫ïÈÉ®ÊåâÈíÆÊòæÁ§∫
                this.getEl('editModalActions').style.display = 'flex';
                this.renderEditModalList();
            },

            saveEditRecord(index, isNew = false) {
                const { records } = this.editModalData;
                const fields = document.querySelectorAll('[id^="editField_"]');

                fields.forEach(field => {
                    const fieldName = field.id.replace('editField_', '');
                    records[index][fieldName] = field.value;
                });

                // ÊÅ¢Â§çÊ†áÈ¢ò
                const title = this.tableConfigs[this.editModalData.fieldName]?.title || this.editModalData.fieldName;
                this.getEl('editModalTitle').textContent = `ÁºñËæë - ${title}`;
                // ÊÅ¢Â§çÂ∫ïÈÉ®ÊåâÈíÆÊòæÁ§∫
                this.getEl('editModalActions').style.display = 'flex';
                this.renderEditModalList();
            },

            addRecordInModal() {
                const { fieldName, records } = this.editModalData;

                const defaults = {
                    'allergyHistory': { allergenType: 'ËçØÁâ©', allergen: '', severity: 'ËΩªÂ∫¶', description: '' },
                    'medicationHistory': { medicationName: '', medicationType: 'Â§ÑÊñπËçØ', reason: '', dosageFrequency: '' },
                    'pastMedicalHistory': { conditionName: '', recordType: 'ÊÖ¢ÊÄßÁóÖ', currentStatus: '' },
                    'surgeryHospitalizationHistory': { eventName: '', eventType: 'ÊâãÊúØ', result: '' },
                    'physicalExamSummary': { name: '', detail: '' },
                    'vaccinationHistory': { vaccineName: '', notes: '' },
                    'familyHistory': { relationship: 'Áà∂ÊØç', condition: '', notes: '' },
                    'supplementIntervention': { direction: '', content: '', notes: '' },
                    'communicationRecords': { date: new Date().toISOString().split('T')[0], keyword: '', content: '' },
                    'followUpRecords': { date: new Date().toISOString().split('T')[0], keyword: '', content: '' }
                };

                records.push(defaults[fieldName] || {});
                const newIndex = records.length - 1;

                // ÈöêËóèÁºñËæëÁ™óÂè£Â∫ïÈÉ®ÁöÑ"Ê∑ªÂä†Êñ∞ËÆ∞ÂΩï"„ÄÅ"ÂèñÊ∂à"„ÄÅ"‰øùÂ≠ò"ÊåâÈíÆ
                document.getElementById('editModalActions').style.display = 'none';

                setTimeout(() => {
                    this.editRecord(newIndex, true);  // ‰º†ÈÄítrueË°®Á§∫ÊòØÊñ∞Á∫™ÂΩï
                }, 50);
            },

            async saveEditModal() {
                const { fieldName, isPeriod, records } = this.editModalData;

                const source = isPeriod ? this.currentPeriod : this.currentCustomer;
                source[fieldName] = records;

                await this.saveCustomerData();

                if (isPeriod) {
                    this.renderPeriodForm(this.currentPeriod);
                } else {
                    this.renderPersonalInfoForm(this.currentCustomer);
                }

                this.closeEditModal();
            },

            // ================= ÂàÜÁ±ªÁºñËæëÊ®°ÊÄÅÁ™óÂè£Áõ∏ÂÖ≥ =================
            categoryEditData: {
                reportId: null,
                categoryKey: '',
                indicators: [],
                selectedIndexes: new Set(),
                draggedIndex: null,
                allIndicators: [] // ÂéüÂßãÂÆåÊï¥ÂàóË°®
            },

            openCategoryEditModal(reportId, categoryKey) {
                const report = (this.currentCustomer.reports || []).find(r => r.id === reportId);
                if (!report) return;

                // Ëé∑ÂèñËØ•ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâÊåáÊ†á
                const indicators = (report.indicators || []).filter(i => i.cat === categoryKey);

                // Ê∑±Êã∑Ë¥ù
                this.categoryEditData = {
                    reportId,
                    categoryKey,
                    indicators: JSON.parse(JSON.stringify(indicators)),
                    selectedIndexes: new Set(),
                    draggedIndex: null,
                    allIndicators: JSON.parse(JSON.stringify(indicators))
                };

                document.getElementById('categoryEditTitle').textContent = `ÁºñËæëÂàÜÁ±ªÔºö${this.categories[categoryKey]}`;
                document.getElementById('categoryEditModal').classList.add('active');
                document.getElementById('categorySearchInput').value = '';
                this.renderCategoryIndicatorsList();
            },

            closeCategoryEditModal() {
                document.getElementById('categoryEditModal').classList.remove('active');
                this.categoryEditData = {
                    reportId: null,
                    categoryKey: '',
                    indicators: [],
                    selectedIndexes: new Set(),
                    draggedIndex: null,
                    allIndicators: []
                };
            },

            filterCategoryIndicators() {
                const searchText = document.getElementById('categorySearchInput').value.toLowerCase();
                if (!searchText) {
                    this.categoryEditData.indicators = JSON.parse(JSON.stringify(this.categoryEditData.allIndicators));
                } else {
                    this.categoryEditData.indicators = this.categoryEditData.allIndicators.filter(ind =>
                        (ind.name || '').toLowerCase().includes(searchText)
                    );
                }
                this.renderCategoryIndicatorsList();
            },

            renderCategoryIndicatorsList() {
                const container = document.getElementById('categoryIndicatorsList');
                const { indicators } = this.categoryEditData;

                if (indicators.length === 0) {
                    container.innerHTML = '<p style="color: #8E8E93; text-align: center; padding: 40px;">ÊöÇÊó†ÊåáÊ†á</p>';
                    document.getElementById('categoryDeleteBtn').style.display = 'none';
                    return;
                }

                let html = '';
                indicators.forEach((indicator, index) => {
                    const isSelected = this.categoryEditData.selectedIndexes.has(index);

                    html += `
                        <div class="edit-list-item" draggable="true"
                             data-index="${index}"
                             ondragstart="ViewController.handleCategoryDragStart(event, ${index})"
                             ondragover="ViewController.handleDragOver(event)"
                             ondrop="ViewController.handleCategoryDrop(event, ${index})"
                             ondragend="ViewController.handleDragEnd(event)">
                            <div class="edit-checkbox ${isSelected ? 'checked' : ''}"
                                 onclick="ViewController.toggleCategorySelectIndicator(${index})"></div>
                            <div class="edit-item-content" onclick="ViewController.editCategoryIndicator(${index})">
                                <div class="item-title">${indicator.name || 'Êú™ÂëΩÂêçÊåáÊ†á'}</div>
                                <div class="item-detail">${indicator.val || ''} ${indicator.unit || ''} | ${indicator.ref || ''}</div>
                            </div>
                            <div class="edit-drag-handle">‚ãÆ</div>
                        </div>
                    `;
                });

                container.innerHTML = html;

                // ÊòæÁ§∫/ÈöêËóèÂà†Èô§ÊåâÈíÆ
                document.getElementById('categoryDeleteBtn').style.display =
                    this.categoryEditData.selectedIndexes.size > 0 ? 'block' : 'none';
            },

            toggleCategorySelectIndicator(index) {
                if (this.categoryEditData.selectedIndexes.has(index)) {
                    this.categoryEditData.selectedIndexes.delete(index);
                } else {
                    this.categoryEditData.selectedIndexes.add(index);
                }
                this.renderCategoryIndicatorsList();
            },

            handleCategoryDragStart(event, index) {
                this.categoryEditData.draggedIndex = index;
                event.target.style.opacity = '0.5';
            },

            handleCategoryDrop(event, dropIndex) {
                event.preventDefault();
                const dragIndex = this.categoryEditData.draggedIndex;
                if (dragIndex === null || dragIndex === dropIndex) return;

                // ÁßªÂä®ÂÖÉÁ¥†
                const { indicators } = this.categoryEditData;
                const [removed] = indicators.splice(dragIndex, 1);
                indicators.splice(dropIndex, 0, removed);

                // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
                const newSelected = new Set();
                this.categoryEditData.selectedIndexes.forEach(idx => {
                    if (idx === dragIndex) {
                        newSelected.add(dropIndex);
                    } else if (idx < dragIndex && idx >= dropIndex) {
                        newSelected.add(idx + 1);
                    } else if (idx > dragIndex && idx <= dropIndex) {
                        newSelected.add(idx - 1);
                    } else {
                        newSelected.add(idx);
                    }
                });
                this.categoryEditData.selectedIndexes = newSelected;

                this.renderCategoryIndicatorsList();
            },

            editCategoryIndicator(index) {
                const indicator = this.categoryEditData.indicators[index];

                // Áõ¥Êé•ÊâìÂºÄÊåáÊ†áÁºñËæëÁ™óÂè£Ôºå‰∏çÂÖ≥Èó≠ÂàÜÁ±ªÁºñËæëÁ™óÂè£
                // ÊåáÊ†áÁºñËæëÁ™óÂè£ÊúâÊõ¥È´òÁöÑz-index (1100)Ôºå‰ºöÊòæÁ§∫Âú®ÂàÜÁ±ªÁºñËæëÁ™óÂè£(1000)‰∏äÈù¢
                this.showEditIndicatorModal(this.categoryEditData.reportId, indicator.id);
            },

            deleteCategorySelectedIndicators() {
                if (this.categoryEditData.selectedIndexes.size === 0) return;
                if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${this.categoryEditData.selectedIndexes.size} ‰∏™ÊåáÊ†áÂêóÔºü`)) return;

                const sortedIndexes = Array.from(this.categoryEditData.selectedIndexes).sort((a, b) => b - a);
                sortedIndexes.forEach(index => {
                    this.categoryEditData.indicators.splice(index, 1);
                    this.categoryEditData.allIndicators.splice(index, 1);
                });

                this.categoryEditData.selectedIndexes.clear();
                this.renderCategoryIndicatorsList();
            },

            async saveCategoryEditModal() {
                const { reportId, categoryKey, indicators } = this.categoryEditData;

                const report = (this.currentCustomer.reports || []).find(r => r.id === reportId);
                if (!report) return;

                // Êõ¥Êñ∞Êä•Âëä‰∏≠ÁöÑÊåáÊ†á
                // ÂÖàÂà†Èô§ËØ•ÂàÜÁ±ªÁöÑÊâÄÊúâÊåáÊ†á
                report.indicators = (report.indicators || []).filter(i => i.cat !== categoryKey);
                // ÂÜçÊ∑ªÂä†Êñ∞ÁöÑÊåáÊ†áÔºà‰øùÊåÅÁºñËæëÂêéÁöÑÈ°∫Â∫èÔºâ
                report.indicators.push(...indicators);

                await this.saveCustomerData();
                this.renderReportList();
                this.closeCategoryEditModal();
            },

            async addPeriod() {
                const periodNumber = document.getElementById('periodNumber').value || (this.currentCustomer.periods?.length + 1 || 1);
                const periodDate = document.getElementById('periodDate').value || new Date().toISOString().split('T')[0];
                const periodName = `${periodNumber}-${periodDate.replace(/-/g, '')}`;

                if (!this.currentCustomer.periods) this.currentCustomer.periods = [];

                this.currentCustomer.periods.push({
                    periodId: Date.now().toString(),
                    periodName: periodName,
                    deliveryDate: periodDate,
                    supplementIntervention: [],
                    communicationRecords: [],
                    followUpRecords: []
                });

                await this.saveCustomerData();
                this.closeModal(document.getElementById('addPeriodModal'));
                document.getElementById('addPeriodForm').reset();
                this.renderPeriodSelector(this.currentCustomer);
            },

            async deletePeriod() {
                if (!this.currentPeriod) {
                    alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑË¥¶Êúü');
                    return;
                }
                if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ÂΩìÂâçË¥¶ÊúüÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) return;

                this.currentCustomer.periods = this.currentCustomer.periods.filter(p => p.periodId !== this.currentPeriod.periodId);
                await this.saveCustomerData();
                this.renderPeriodSelector(this.currentCustomer);
            },

            async savePeriodInfo(showNotification = true) {
                if (!this.currentPeriod) return;

                this.currentPeriod.deliveryDate = document.getElementById('deliveryDate')?.value || '';
                this.currentPeriod.nextDeliveryDate = document.getElementById('nextDeliveryDate')?.value || '';

                await this.saveCustomerData();
                if (showNotification) this.showSaveNotification();
            },

            async autoSavePeriodInfo() {
                await this.savePeriodInfo(false);
            },

            // ================= Ê£ÄÊµãÊä•ÂëäTabÁõ∏ÂÖ≥ =================
            renderReportList() {
                const list = document.getElementById('reportList');
                list.innerHTML = '';

                const reports = this.currentCustomer.reports || [];

                if (reports.length === 0) {
                    list.innerHTML = '<p style="color: var(--ios-gray); text-align: center; padding: 40px;">ÊöÇÊó†Ê£ÄÊµãÊä•Âëä</p>';
                    return;
                }

                reports.forEach(rep => {
                    let indicatorsHtml = '';
                    let hasContent = false;

                    if (!rep.collapsedCategories) rep.collapsedCategories = {};

                    for (let catKey in this.categories) {
                        const filtered = (rep.indicators || []).filter(i => {
                            const matchCat = i.cat === catKey;
                            const matchFilter = (this.reportFilterMode === 'all') || (this.reportFilterMode === 'abnormal' && i.status === 'abnormal');
                            return matchCat && matchFilter;
                        });

                        if (filtered.length > 0) {
                            hasContent = true;
                            const isCollapsed = rep.collapsedCategories[catKey] || false;
                            const categoryColor = this.categoryColors[catKey] || '#007AFF';
                            
                            // ËÆ°ÁÆóËØ•Â§ßÂàÜÁ±ªÁöÑÊÄªÊï∞
                            const categoryTotal = filtered.length;

                            // ÊåâÂ≠êÂàÜÁ±ªÁªÑÁªáÊåáÊ†á
                            let subcategoryHtml = '';
                            if (this.subcategories[catKey]) {
                                for (let subcatKey in this.subcategories[catKey]) {
                                    const subcatFiltered = filtered.filter(i => i.subcat === subcatKey);
                                    if (subcatFiltered.length > 0 || this.reportFilterMode === 'all') {
                                        const subcatCount = subcatFiltered.length;
                                        const hasAbnormal = subcatFiltered.some(i => i.status === 'abnormal');
                                        const subcatCountClass = hasAbnormal ? 'has-abnormal' : '';
                                        
                                        // ÂàùÂßãÂåñÂ≠êÂàÜÁ±ªÊäòÂè†Áä∂ÊÄÅ
                                        if (!rep.collapsedSubcategories) rep.collapsedSubcategories = {};
                                        if (!rep.collapsedSubcategories[catKey]) rep.collapsedSubcategories[catKey] = {};
                                        
                                        // ÂºÇÂ∏∏ËßÜÂõæ‰∏ãÔºöÂÖ®ÈÉ®Â±ïÂºÄ
                                        // ÂÖ®ÈÉ®ËßÜÂõæ‰∏ãÔºöÊúâÂºÇÂ∏∏ÂàôÂ±ïÂºÄÔºåÊó†ÂºÇÂ∏∏ÂàôÊäòÂè†
                                        if (rep.collapsedSubcategories[catKey][subcatKey] === undefined) {
                                            if (this.reportFilterMode === 'abnormal') {
                                                rep.collapsedSubcategories[catKey][subcatKey] = false; // ÂºÇÂ∏∏ËßÜÂõæÂÖ®ÈÉ®Â±ïÂºÄ
                                            } else {
                                                rep.collapsedSubcategories[catKey][subcatKey] = !hasAbnormal; // ÂÖ®ÈÉ®ËßÜÂõæÊ†πÊçÆÊòØÂê¶ÊúâÂºÇÂ∏∏ÂÜ≥ÂÆö
                                            }
                                        }
                                        
                                        const isSubcatCollapsed = rep.collapsedSubcategories[catKey][subcatKey];
                                        
                                        if (subcatCount > 0) {
                                            subcategoryHtml += `
                                                <div class="subcategory-header ${isSubcatCollapsed ? 'collapsed' : ''}" onclick="ViewController.toggleSubcategory(${rep.id}, '${catKey}', '${subcatKey}')">
                                                    <span><span class="category-dot-hollow" style="border-color: ${categoryColor};"></span>${this.subcategories[catKey][subcatKey]} <span class="subcategory-count ${subcatCountClass}">(${subcatCount})</span></span>
                                                    <span class="subcategory-toggle">‚ñº</span>
                                                </div>
                                                <div class="subcategory-content">
                                                    <table class="report-table">
                                                        ${subcatFiltered.map(i => `
                                                            <tr data-indicator-id="${i.id}" data-report-id="${rep.id}" class="${i.status === 'abnormal' ? 'abnormal' : ''}" ondblclick="ViewController.showEditIndicatorModal(${rep.id}, ${i.id})" style="cursor: pointer;">
                                                                <td width="32%">${i.name || ''}</td>
                                                                <td width="20%">${i.val || ''}</td>
                                                                <td width="16%">${i.unit || ''}</td>
                                                                <td width="24%">${i.ref || ''}</td>
                                                                <td width="8%" style="text-align:right">
                                                                    <span class="icon-btn" onclick="event.stopPropagation(); ViewController.deleteIndicator(${rep.id}, ${i.id})" title="Âà†Èô§">‚úï</span>
                                                                </td>
                                                            </tr>
                                                        `).join('')}
                                                    </table>
                                                </div>
                                            `;
                                        }
                                    }
                                }
                            }

                            indicatorsHtml += `
                                <div id="category-card-${rep.id}-${catKey}" class="modern-card ${isCollapsed ? 'collapsed' : ''}" style="margin-bottom: 12px;">
                                    <div class="modern-card-header" onclick="ViewController.toggleCategory(${rep.id}, '${catKey}')">
                                        <div class="modern-card-title">
                                            <span class="category-dot" style="background-color: ${categoryColor};"></span>
                                            <span>${this.categories[catKey]} <span class="record-count">(${categoryTotal})</span></span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span class="add-icon" onclick="event.stopPropagation(); ViewController.showAddIndicatorModal(${rep.id}, '${catKey}');" title="Ê∑ªÂä†ÊåáÊ†á" style="cursor: pointer; font-size: 18px; margin: 0;">Ôºã</span>
                                            <span class="edit-icon" onclick="event.stopPropagation(); ViewController.openCategoryEditModal(${rep.id}, '${catKey}');" title="ÁºñËæëÂàÜÁ±ª" style="cursor: pointer; font-size: 16px;">‚úèÔ∏è</span>
                                            <span class="modern-card-toggle">‚ñº</span>
                                        </div>
                                    </div>
                                    <div class="modern-card-content">
                                        <div class="modern-card-body" style="padding: 0;">
                                            ${subcategoryHtml}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }

                    if (this.reportFilterMode === 'abnormal' && !hasContent) return;

                    const isSelected = this.selectedReports.has(rep.id);
                    const card = document.createElement('div');
                    card.className = `report-card ${isSelected ? 'selected' : ''}`;
                    card.setAttribute('data-report-id', rep.id);
                    card.setAttribute('draggable', this.isReportEditMode);

                    const contentActive = !this.isReportEditMode;

                    card.innerHTML = `
                        <div class="report-header" onclick="ViewController.toggleReportSelection(${rep.id}, event)">
                            ${this.isReportEditMode ? `<div class="selection-circle ${isSelected ? 'selected' : ''}"></div>` : ''}
                            <div class="report-info">
                                <div>${rep.name || 'Êú™ÂëΩÂêçÊä•Âëä'} - ${rep.org || ''}</div>
                                <div>${rep.date || ''}</div>
                            </div>
                            ${this.isReportEditMode ? `<div class="drag-handle-report">‚ãÆ‚ãÆ</div>` : ''}
                        </div>
                        <div class="report-content ${contentActive ? 'active' : ''}">
                            ${indicatorsHtml}
                            <div class="add-indicator-btn-container">
                                <div class="add-indicator-btn" onclick="event.stopPropagation(); ViewController.showIndicatorModal(${rep.id});">+ Ê∑ªÂä†</div>
                                <div class="import-indicator-btn" onclick="event.stopPropagation(); ViewController.showImportModal(${rep.id});">ÊâπÈáèÂØºÂÖ•</div>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });

                setTimeout(() => {                    this.addReportDragListeners();
                }, 0);
            },

            setReportFilter(mode) {
                this.reportFilterMode = mode;
                document.getElementById('seg-all').classList.toggle('active', mode === 'all');
                document.getElementById('seg-abnormal').classList.toggle('active', mode === 'abnormal');
                this.renderReportList();
            },

            toggleReportEditMode() {
                this.isReportEditMode = !this.isReportEditMode;

                if (this.isReportEditMode) {
                    document.getElementById('reportEditButton').textContent = 'ÂèñÊ∂à';
                    document.getElementById('reportEditButton').className = 'cancel-btn';
                    document.getElementById('reportActionToolbar').style.display = 'flex';
                    this.updateReportActionToolbar();
                } else {
                    document.getElementById('reportEditButton').textContent = 'ÁºñËæë';
                    document.getElementById('reportEditButton').className = 'edit-btn';
                    document.getElementById('reportActionToolbar').style.display = 'none';
                    this.selectedReports.clear();
                }

                this.renderReportList();
            },

            toggleReportSelection(repId, event) {
                if (!this.isReportEditMode) {
                    const content = event.currentTarget.nextElementSibling;
                    if (content) content.classList.toggle('active');
                    return;
                }

                if (this.selectedReports.has(repId)) {
                    this.selectedReports.delete(repId);
                } else {
                    this.selectedReports.add(repId);
                }

                this.updateReportActionToolbar();
                this.renderReportList();
            },

            updateReportActionToolbar() {
                const selectedCount = this.selectedReports.size;
                const container = document.getElementById('reportActionButtonsContainer');

                if (selectedCount === 0) {
                    container.innerHTML = `
                        <button class="action-btn add-action" onclick="ViewController.showReportModal('reportModal')">Ê∑ªÂä†</button>
                        <button class="action-btn delete-action" disabled>Âà†Èô§</button>
                    `;
                } else if (selectedCount === 1) {
                    container.innerHTML = `
                        <button class="action-btn edit-action" onclick="ViewController.editSelectedReport()">ÁºñËæë</button>
                        <button class="action-btn delete-action" onclick="ViewController.deleteSelectedReports()">Âà†Èô§</button>
                    `;
                } else {
                    container.innerHTML = `
                        <button class="action-btn delete-action" onclick="ViewController.deleteSelectedReports()">Âà†Èô§(${selectedCount})</button>
                    `;
                }
            },

            toggleCategory(reportId, catKey) {
                const report = (this.currentCustomer.reports || []).find(r => r.id === reportId);
                if (!report) return;

                if (!report.collapsedCategories) report.collapsedCategories = {};
                report.collapsedCategories[catKey] = !report.collapsedCategories[catKey];

                // Áõ¥Êé•Êìç‰ΩúDOMÔºå‰∏çÈáçÊñ∞Ê∏≤ÊüìÔºå‰∏ç‰øùÂ≠ò
                const cardId = `category-card-${reportId}-${catKey}`;
                const card = document.getElementById(cardId);
                if (card) {
                    card.classList.toggle('collapsed');
                }

                // ‰∏çÂÜç‰øùÂ≠òÊï∞ÊçÆÂ∫ìÔºåÊäòÂè†Áä∂ÊÄÅÂè™Âú®ÂΩìÂâç‰ºöËØùÊúâÊïà
            },

            toggleSubcategory(reportId, catKey, subcatKey) {
                const report = (this.currentCustomer.reports || []).find(r => r.id === reportId);
                if (!report) return;

                if (!report.collapsedSubcategories) report.collapsedSubcategories = {};
                if (!report.collapsedSubcategories[catKey]) report.collapsedSubcategories[catKey] = {};
                
                report.collapsedSubcategories[catKey][subcatKey] = !report.collapsedSubcategories[catKey][subcatKey];

                // Áõ¥Êé•Êìç‰ΩúDOM
                const allSubcatHeaders = document.querySelectorAll('.subcategory-header');
                allSubcatHeaders.forEach(header => {
                    const headerText = header.querySelector('span').textContent;
                    if (headerText.includes(this.subcategories[catKey][subcatKey])) {
                        header.classList.toggle('collapsed');
                        const content = header.nextElementSibling;
                        if (content && content.classList.contains('subcategory-content')) {
                            content.style.display = header.classList.contains('collapsed') ? 'none' : 'block';
                        }
                    }
                });
            },

            updateSubcategoryOptions(selectId) {
                const catSelect = selectId.includes('edit') ? document.getElementById('editIndCat') : document.getElementById('indCat');
                const subcatSelect = document.getElementById(selectId);
                const catValue = catSelect.value;
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
                subcatSelect.innerHTML = '';
                
                // Ê∑ªÂä†ÂØπÂ∫îÁöÑÂ≠êÂàÜÁ±ªÈÄâÈ°π
                if (this.subcategories[catValue]) {
                    for (let subcatKey in this.subcategories[catValue]) {
                        const option = document.createElement('option');
                        option.value = subcatKey;
                        option.textContent = this.subcategories[catValue][subcatKey];
                        subcatSelect.appendChild(option);
                    }
                }
            },

            getDefaultSubcategory(catValue) {
                if (this.subcategories[catValue]) {
                    const keys = Object.keys(this.subcategories[catValue]);
                    return keys.length > 0 ? keys[0] : '';
                }
                return '';
            },

            showReportModal(modalId) {
                if (modalId === 'reportModal') {
                    document.getElementById('repDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('repName').value = '';
                    document.getElementById('repOrg').value = '';
                }
                document.getElementById(modalId).classList.add('active');
            },

            hideReportModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            },

            createReport() {
                const date = document.getElementById('repDate').value || new Date().toISOString().split('T')[0];
                const name = document.getElementById('repName').value || 'Êú™ÂëΩÂêçÊä•Âëä';
                const org = document.getElementById('repOrg').value || '';

                if (!this.currentCustomer.reports) this.currentCustomer.reports = [];

                this.currentCustomer.reports.push({
                    id: Date.now(),
                    date,
                    name,
                    org,
                    indicators: [],
                    collapsedCategories: {}
                });

                this.saveAndRenderReports();
                this.hideReportModal('reportModal');
            },

            editSelectedReport() {
                if (this.selectedReports.size !== 1) return;

                const repId = Array.from(this.selectedReports)[0];
                const report = (this.currentCustomer.reports || []).find(r => r.id === repId);
                if (!report) return;

                this.editingReportId = repId;
                document.getElementById('editRepDate').value = report.date || '';
                document.getElementById('editRepName').value = report.name || '';
                document.getElementById('editRepOrg').value = report.org || '';
                this.showReportModal('editReportModal');
            },

            saveEditReport() {
                if (!this.editingReportId) return;

                const report = (this.currentCustomer.reports || []).find(r => r.id === this.editingReportId);
                if (!report) return;

                report.date = document.getElementById('editRepDate').value;
                report.name = document.getElementById('editRepName').value;
                report.org = document.getElementById('editRepOrg').value;

                this.saveAndRenderReports();
                this.hideReportModal('editReportModal');
                this.editingReportId = null;
            },

            deleteSelectedReports() {
                if (this.selectedReports.size === 0) return;

                const title = 'Âà†Èô§Êä•Âëä';
                const message = this.selectedReports.size === 1
                    ? 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êä•ÂëäÂêóÔºü'
                    : `Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô${this.selectedReports.size}‰∏™Êä•ÂëäÂêóÔºü`;

                this.showConfirmDelete(title, message, () => {
                    this.currentCustomer.reports = (this.currentCustomer.reports || []).filter(r => !this.selectedReports.has(r.id));
                    this.selectedReports.clear();
                    this.saveAndRenderReports();

                    if ((this.currentCustomer.reports || []).length === 0) {
                        this.toggleReportEditMode();
                    } else {
                        this.updateReportActionToolbar();
                    }
                });
            },

            showIndicatorModal(repId) {
                this.currentReportId = repId;
                document.getElementById('indName').value = '';
                document.getElementById('indVal').value = '';
                document.getElementById('indUnit').value = '';
                document.getElementById('indRef').value = '';
                document.getElementById('indCat').value = '1';
                document.getElementById('indStatus').value = 'normal';
                this.updateSubcategoryOptions('indSubcat');
                this.showReportModal('indicatorModal');
            },

            showAddIndicatorModal(reportId, categoryKey = null) {
                this.currentReportId = reportId;
                
                // Â¶ÇÊûúÊåáÂÆö‰∫ÜÂàÜÁ±ªÔºåÂàôÈ¢ÑÈÄâËØ•ÂàÜÁ±ª
                if (categoryKey) {
                    document.getElementById('indCat').value = categoryKey;
                    this.updateSubcategoryOptions('indSubcat');
                }
                
                // Ê∏ÖÁ©∫Ë°®Âçï
                document.getElementById('indName').value = '';
                document.getElementById('indVal').value = '';
                document.getElementById('indUnit').value = '';
                document.getElementById('indRef').value = '';
                document.getElementById('indStatus').value = 'normal';
                
                this.showReportModal('indicatorModal');
            },

            confirmAddIndicator() {
                const report = (this.currentCustomer.reports || []).find(r => r.id === this.currentReportId);
                if (!report) return;

                report.indicators.push({
                    id: Date.now(),
                    name: document.getElementById('indName').value,
                    val: document.getElementById('indVal').value,
                    unit: document.getElementById('indUnit').value,
                    ref: document.getElementById('indRef').value,
                    cat: document.getElementById('indCat').value,
                    subcat: document.getElementById('indSubcat').value,
                    status: document.getElementById('indStatus').value
                });

                this.saveAndRenderReports();
                this.hideReportModal('indicatorModal');
            },

            // Êñ∞Â¢ûÔºöÊòæÁ§∫‰øÆÊîπÊåáÊ†áÊ®°ÊÄÅÊ°Ü
            showEditIndicatorModal(repId, indId) {
                const report = (this.currentCustomer.reports || []).find(r => r.id === repId);
                if (!report) return;

                const indicator = (report.indicators || []).find(i => i.id === indId);
                if (!indicator) return;

                // ‰øùÂ≠òÂΩìÂâçÁºñËæëÁöÑÊåáÊ†á‰ø°ÊÅØ
                this.editingIndicatorId = indId;
                this.editingIndicatorReportId = repId;

                // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
                document.getElementById('editIndName').value = indicator.name || '';
                document.getElementById('editIndVal').value = indicator.val || '';
                document.getElementById('editIndUnit').value = indicator.unit || '';
                document.getElementById('editIndRef').value = indicator.ref || '';
                document.getElementById('editIndCat').value = indicator.cat || '1';
                document.getElementById('editIndStatus').value = indicator.status || 'normal';
                
                // Êõ¥Êñ∞Â≠êÂàÜÁ±ªÈÄâÈ°πÂπ∂ËÆæÁΩÆÂÄº
                this.updateSubcategoryOptions('editIndSubcat');
                document.getElementById('editIndSubcat').value = indicator.subcat || this.getDefaultSubcategory(indicator.cat);

                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                document.getElementById('editIndicatorModal').classList.add('active');
            },

            // Êñ∞Â¢ûÔºöÁ°ÆËÆ§‰øÆÊîπÊåáÊ†á
            confirmEditIndicator() {
                if (!this.editingIndicatorId || !this.editingIndicatorReportId) return;

                const report = (this.currentCustomer.reports || []).find(r => r.id === this.editingIndicatorReportId);
                if (!report) return;

                const indicator = (report.indicators || []).find(i => i.id === this.editingIndicatorId);
                if (!indicator) return;

                // Êõ¥Êñ∞ÊåáÊ†áÊï∞ÊçÆ
                indicator.name = document.getElementById('editIndName').value;
                indicator.val = document.getElementById('editIndVal').value;
                indicator.unit = document.getElementById('editIndUnit').value;
                indicator.ref = document.getElementById('editIndRef').value;
                indicator.cat = document.getElementById('editIndCat').value;
                indicator.subcat = document.getElementById('editIndSubcat').value;
                indicator.status = document.getElementById('editIndStatus').value;

                // ‰øùÂ≠òÂπ∂ÈáçÊñ∞Ê∏≤Êüì
                this.saveAndRenderReports();
                this.hideReportModal('editIndicatorModal');

                // Â¶ÇÊûúÂàÜÁ±ªÁºñËæëÁ™óÂè£ÊâìÂºÄÁùÄÔºåÂà∑Êñ∞ÂÖ∂ÂàóË°®
                if (document.getElementById('categoryEditModal').classList.contains('active')) {
                    // Êõ¥Êñ∞ÂàÜÁ±ªÁºñËæëÁ™óÂè£ÁöÑÊï∞ÊçÆ
                    const categoryReport = (this.currentCustomer.reports || []).find(r => r.id === this.categoryEditData.reportId);
                    if (categoryReport) {
                        const updatedIndicators = (categoryReport.indicators || []).filter(i => i.cat === this.categoryEditData.categoryKey);
                        this.categoryEditData.indicators = JSON.parse(JSON.stringify(updatedIndicators));
                        this.categoryEditData.allIndicators = JSON.parse(JSON.stringify(updatedIndicators));
                        this.renderCategoryIndicatorsList();
                    }
                }

                // Ê∏ÖÁ©∫ÁºñËæëÁä∂ÊÄÅ
                this.editingIndicatorId = null;
                this.editingIndicatorReportId = null;
            },

            deleteIndicator(repId, indId) {
                const rep = (this.currentCustomer.reports || []).find(r => r.id === repId);
                if (!rep) return;
                rep.indicators = rep.indicators.filter(i => i.id !== indId);
                this.saveAndRenderReports();
            },

            showImportModal(repId) {
                this.currentReportId = repId;
                document.getElementById('importText').value = '';
                this.showReportModal('importModal');
            },

            confirmImportIndicators() {
                const report = (this.currentCustomer.reports || []).find(r => r.id === this.currentReportId);
                if (!report) return;

                const importText = document.getElementById('importText').value;
                const lines = importText.split('\n').filter(line => line.trim());
                
                if (lines.length === 0) {
                    alert('ËØ∑ËæìÂÖ•Ë¶ÅÂØºÂÖ•ÁöÑÊåáÊ†áÊï∞ÊçÆ');
                    return;
                }

                // È™åËØÅÊâÄÊúâË°å
                const errors = [];
                const validatedIndicators = [];
                
                lines.forEach((line, index) => {
                    const lineNum = index + 1;
                    const parts = line.trim().split(/\s+/);
                    
                    // È™åËØÅÂ≠óÊÆµÊï∞Èáè
                    if (parts.length < 4) {
                        errors.push(`Á¨¨${lineNum}Ë°åÔºöÂ≠óÊÆµÊï∞Èáè‰∏çË∂≥ÔºàËá≥Â∞ëÈúÄË¶Å4‰∏™Â≠óÊÆµÔºöÊåáÊ†áÂêç Êï∞ÂÄº Á±ªÂà´ Áä∂ÊÄÅÔºâ`);
                        return;
                    }
                    
                    let indicator;
                    
                    if (parts.length >= 7) {
                        // ÂÆåÊï¥Ê†ºÂºèÔºöÊåáÊ†áÂêç Êï∞ÂÄº Âçï‰Ωç ÂèÇËÄÉËåÉÂõ¥ Á±ªÂà´ Â≠êÂàÜÁ±ª Áä∂ÊÄÅ
                        const cat = parts[4];
                        const subcat = parts[5];
                        const status = parts[6];
                        
                        // È™åËØÅÂàÜÁ±ª
                        if (!['1', '2', '3', '4', '5', '6'].includes(cat)) {
                            errors.push(`Á¨¨${lineNum}Ë°åÔºöÂàÜÁ±ª‰ª£Á†Å"${cat}"Êó†ÊïàÔºàÂøÖÈ°ªÊòØ1-6Ôºâ`);
                            return;
                        }
                        
                        // È™åËØÅÂ≠êÂàÜÁ±ª
                        if (!this.subcategories[cat] || !this.subcategories[cat][subcat]) {
                            errors.push(`Á¨¨${lineNum}Ë°åÔºöÂ≠êÂàÜÁ±ª‰ª£Á†Å"${subcat}"Âú®ÂàÜÁ±ª"${cat}"‰∏≠‰∏çÂ≠òÂú®`);
                            return;
                        }
                        
                        // È™åËØÅÁä∂ÊÄÅ
                        if (!['normal', 'abnormal'].includes(status)) {
                            errors.push(`Á¨¨${lineNum}Ë°åÔºöÁä∂ÊÄÅ"${status}"Êó†ÊïàÔºàÂøÖÈ°ªÊòØnormalÊàñabnormalÔºâ`);
                            return;
                        }
                        
                        indicator = {
                            id: Date.now() + Math.random(),
                            name: parts[0],
                            val: parts[1],
                            unit: parts[2],
                            ref: parts[3],
                            cat: cat,
                            subcat: subcat,
                            status: status
                        };
                        
                    } else if (parts.length >= 6) {
                        // Êó†Â≠êÂàÜÁ±ªÊ†ºÂºèÔºöÊåáÊ†áÂêç Êï∞ÂÄº Âçï‰Ωç ÂèÇËÄÉËåÉÂõ¥ Á±ªÂà´ Áä∂ÊÄÅ
                        const cat = parts[4];
                        const status = parts[5];
                        
                        // È™åËØÅÂàÜÁ±ª
                        if (!['1', '2', '3', '4', '5', '6'].includes(cat)) {
                            errors.push(`Á¨¨${lineNum}Ë°åÔºöÂàÜÁ±ª‰ª£Á†Å"${cat}"Êó†ÊïàÔºàÂøÖÈ°ªÊòØ1-6Ôºâ`);
                            return;
                        }
                        
                        // È™åËØÅÁä∂ÊÄÅ
                        if (!['normal', 'abnormal'].includes(status)) {
                            errors.push(`Á¨¨${lineNum}Ë°åÔºöÁä∂ÊÄÅ"${status}"Êó†ÊïàÔºàÂøÖÈ°ªÊòØnormalÊàñabnormalÔºâ`);
                            return;
                        }
                        
                        const defaultSubcat = this.getDefaultSubcategory(cat);
                        indicator = {
                            id: Date.now() + Math.random(),
                            name: parts[0],
                            val: parts[1],
                            unit: parts[2],
                            ref: parts[3],
                            cat: cat,
                            subcat: defaultSubcat,
                            status: status
                        };
                        
                    } else {
                        // ÊúÄÁÆÄÊ†ºÂºèÔºöÊåáÊ†áÂêç Êï∞ÂÄº Á±ªÂà´ Áä∂ÊÄÅ
                        const cat = parts[2];
                        const status = parts[3];
                        
                        // È™åËØÅÂàÜÁ±ª
                        if (!['1', '2', '3', '4', '5', '6'].includes(cat)) {
                            errors.push(`Á¨¨${lineNum}Ë°åÔºöÂàÜÁ±ª‰ª£Á†Å"${cat}"Êó†ÊïàÔºàÂøÖÈ°ªÊòØ1-6Ôºâ`);
                            return;
                        }
                        
                        // È™åËØÅÁä∂ÊÄÅ
                        if (!['normal', 'abnormal'].includes(status)) {
                            errors.push(`Á¨¨${lineNum}Ë°åÔºöÁä∂ÊÄÅ"${status}"Êó†ÊïàÔºàÂøÖÈ°ªÊòØnormalÊàñabnormalÔºâ`);
                            return;
                        }
                        
                        const defaultSubcat = this.getDefaultSubcategory(cat);
                        indicator = {
                            id: Date.now() + Math.random(),
                            name: parts[0],
                            val: parts[1],
                            unit: '',
                            ref: '',
                            cat: cat,
                            subcat: defaultSubcat,
                            status: status
                        };
                    }
                    
                    validatedIndicators.push(indicator);
                });

                // Â¶ÇÊûúÊúâÈîôËØØÔºåÁ¶ÅÊ≠¢ÂÜôÂÖ•ÔºåÊòæÁ§∫ÊâÄÊúâÈîôËØØ
                if (errors.length > 0) {
                    const errorMessage = 'ÂØºÂÖ•Â§±Ë¥•ÔºÅÂèëÁé∞‰ª•‰∏ãÈîôËØØÔºö\n\n' + errors.join('\n') + '\n\nËØ∑‰øÆÊ≠£ÂêéÈáçÊñ∞ÂØºÂÖ•„ÄÇ';
                    alert(errorMessage);
                    return;
                }

                // È™åËØÅÈÄöËøáÔºåÂÜôÂÖ•Êï∞ÊçÆ
                validatedIndicators.forEach(indicator => {
                    report.indicators.push(indicator);
                });

                this.saveAndRenderReports();
                this.hideReportModal('importModal');
                alert(`ÊàêÂäüÂØºÂÖ• ${validatedIndicators.length} Êù°ÊåáÊ†á`);
            },

            // ÊåáÊ†áÊãñÊãΩ

            // Êä•ÂëäÊãñÊãΩ
            addReportDragListeners() {
                document.querySelectorAll('.report-card').forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        if (!this.isReportEditMode) {
                            e.preventDefault();
                            return;
                        }
                        this.draggedReport = card;
                        card.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', card.getAttribute('data-report-id'));
                    });

                    card.addEventListener('dragover', (e) => {
                        if (!this.isReportEditMode) return;
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                    });

                    card.addEventListener('dragenter', () => {
                        if (this.isReportEditMode) card.classList.add('drag-over');
                    });

                    card.addEventListener('dragleave', () => card.classList.remove('drag-over'));

                    card.addEventListener('drop', (e) => {
                        if (!this.isReportEditMode) return;
                        e.preventDefault();
                        card.classList.remove('drag-over');

                        if (this.draggedReport !== card) {
                            const dragId = parseInt(this.draggedReport.getAttribute('data-report-id'));
                            const dropId = parseInt(card.getAttribute('data-report-id'));

                            const reports = this.currentCustomer.reports || [];
                            const dragIndex = reports.findIndex(r => r.id === dragId);
                            const dropIndex = reports.findIndex(r => r.id === dropId);

                            if (dragIndex !== -1 && dropIndex !== -1) {
                                const [movedReport] = reports.splice(dragIndex, 1);
                                reports.splice(dropIndex, 0, movedReport);
                                this.saveAndRenderReports();
                            }
                        }
                    });

                    card.addEventListener('dragend', () => {
                        card.classList.remove('dragging');
                        this.draggedReport = null;
                        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    });
                });
            },

            async saveAndRenderReports() {
                await this.saveCustomerData();
                this.renderReportList();
            },

            // ================= Êï∞ÊçÆ‰øùÂ≠òÂíåÈÄöÁü• =================
            async saveCustomerData(showNotification = true) {
                const data = await CustomerModel.loadData();
                const customerIndex = data.customers.findIndex(c => c.id === this.currentCustomer.id);

                if (customerIndex === -1) return;

                const now = new Date();
                const lastModified = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                this.currentCustomer.lastModified = lastModified;

                data.customers[customerIndex] = this.currentCustomer;
                await CustomerModel.debounceSave(data, showNotification);
            },

            showSaveNotification() {
                const notification = document.getElementById('saveNotification');
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 2000);
            },

            // ================= ÂØºÂÖ•ÂØºÂá∫ÂäüËÉΩ =================
            async showExportDataModal() {
                const modal = document.getElementById('exportDataModal');
                const select = document.getElementById('exportCustomerSelect');
                const searchInput = document.getElementById('customerSearchInput');
                
                // ÈáçÁΩÆÊêúÁ¥¢Ê°ÜÂíå‰∏ãÊãâÊ°Ü
                searchInput.value = '';
                select.innerHTML = '<option value="">-- ËØ∑ÈÄâÊã©ÂÆ¢Êà∑ --</option>';
                
                // Âä†ËΩΩÂÆ¢Êà∑Êï∞ÊçÆÂπ∂Â°´ÂÖÖ‰∏ãÊãâÊ°Ü
                const data = await CustomerModel.loadData();
                this.cachedData = data; // ‰øùÂ≠òÂà∞ÁºìÂ≠ò
                this.allCustomerOptions = []; // ‰øùÂ≠òÊâÄÊúâÂÆ¢Êà∑ÈÄâÈ°πÁî®‰∫éÊêúÁ¥¢ËøáÊª§
                
                data.customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.personalInfo?.name || 'Êú™ÂëΩÂêç';
                    option.dataset.customerName = (customer.personalInfo?.name || 'Êú™ÂëΩÂêç').toLowerCase();
                    select.appendChild(option);
                    this.allCustomerOptions.push(option);
                });

                modal.classList.add('active');
            },

            async exportData() {
                const select = document.getElementById('exportCustomerSelect');
                const selectedValue = select.value;
                
                if (!selectedValue) {
                    alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂØºÂá∫ÁöÑÂÆ¢Êà∑');
                    return;
                }
                
                // Ëé∑ÂèñÊâÄÊúâÂÆ¢Êà∑Êï∞ÊçÆ
                const allCustomers = this.cachedData ? this.cachedData.customers : [];
                
                if (allCustomers.length === 0) {
                    alert('ÊöÇÊó†ÂÆ¢Êà∑Êï∞ÊçÆ');
                    return;
                }
                
                // ÂØºÂá∫Âçï‰∏™ÂÆ¢Êà∑Êï∞ÊçÆ
                const customerId = parseInt(selectedValue);
                const selectedCustomer = allCustomers.find(c => c.id === customerId);
                
                if (!selectedCustomer) {
                    alert('Êú™ÊâæÂà∞ÈÄâ‰∏≠ÁöÑÂÆ¢Êà∑Êï∞ÊçÆ');
                    return;
                }
                
                const exportObj = {
                    exportType: "single",
                    exportDate: new Date().toLocaleString(),
                    count: 1,
                    customers: [selectedCustomer]
                };
                const name = selectedCustomer.personalInfo?.name || 'Êú™Áü•ÂÆ¢Êà∑';
                const fileName = `${name}-ÂÆåÊï¥Êï∞ÊçÆ.json`;
                
                // ÁîüÊàêÊñá‰ª∂Âπ∂‰∏ãËΩΩ
                const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                document.getElementById('exportDataModal').classList.remove('active');
            },

            async exportAllCustomersData() {
                // Ëé∑ÂèñÊâÄÊúâÂÆ¢Êà∑Êï∞ÊçÆ
                const allCustomers = this.cachedData ? this.cachedData.customers : [];
                
                if (allCustomers.length === 0) {
                    alert('ÊöÇÊó†ÂÆ¢Êà∑Êï∞ÊçÆÂèØÂØºÂá∫');
                    return;
                }

                // ÂÆö‰πâÂØºÂá∫ÂØπË±°
                const exportObj = {
                    exportType: "all",
                    exportDate: new Date().toLocaleString(),
                    count: allCustomers.length,
                    customers: allCustomers
                };

                // ÁîüÊàêÊñá‰ª∂
                const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const today = new Date().toISOString().split('T')[0];
                a.download = `WindWayÂÖ®ÈÉ®ÂÆ¢Êà∑Êï∞ÊçÆ-${today}.json`;
                
                // Ëß¶Âèë‰∏ãËΩΩ
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                document.getElementById('exportDataModal').classList.remove('active');
                
                alert(`ÊàêÂäüÂØºÂá∫ ${allCustomers.length} ‰ΩçÂÆ¢Êà∑ÁöÑÂÆåÊï¥Êï∞ÊçÆ`);
            },

            filterCustomerSelect(searchTerm) {
                const select = document.getElementById('exportCustomerSelect');
                const placeholder = select.querySelector('option[value=""]');
                
                // Ê∏ÖÁ©∫‰∏ãÊãâÊ°ÜÔºå‰ΩÜ‰øùÁïôÂç†‰ΩçÁ¨¶
                select.innerHTML = '';
                select.appendChild(placeholder);
                
                // Ê†πÊçÆÊêúÁ¥¢ËØçËøáÊª§Âπ∂ÈáçÊñ∞Ê∑ªÂä†ÈÄâÈ°π
                if (this.allCustomerOptions) {
                    this.allCustomerOptions.forEach(option => {
                        const customerName = option.dataset.customerName || '';
                        if (customerName.includes(searchTerm.toLowerCase())) {
                            select.appendChild(option.cloneNode(true));
                        }
                    });
                }
            },

            async importData(file) {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Áé∞Âú® loadData ‰øÆÂ§ç‰∫ÜÔºåËøôÈáåÂ∞±‰∏ç‰ºöÂ¥©‰∫Ü
                        const data = await CustomerModel.loadData();

                        if (importedData.customers) {
                            let importCount = 0;
                            importedData.customers.forEach(importedCustomer => {
                                const existingIndex = data.customers.findIndex(c =>
                                    c.personalInfo?.name === importedCustomer.personalInfo?.name
                                );

                                if (existingIndex >= 0) {
                                    if (confirm(`ÂÆ¢Êà∑"${importedCustomer.personalInfo?.name}"Â∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÜÁõñÔºü`)) {
                                        // ‰øùÊåÅÂéüÊúâ ID
                                        importedCustomer.id = data.customers[existingIndex].id;
                                        data.customers[existingIndex] = importedCustomer;
                                        importCount++;
                                    }
                                } else {
                                    // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëID ÂøÖÈ°ªÊòØÊï¥Êï∞ÔºÅ‰∏çË¶ÅÂä† Math.random() Â∞èÊï∞
                                    importedCustomer.id = Date.now() + Math.floor(Math.random() * 1000);
                                    data.customers.push(importedCustomer);
                                    importCount++;
                                }
                            });
                            
                            if (importCount > 0) {
                                await CustomerModel.debounceSave(data);
                                await this.renderCustomerList();
                                await this.loadFilterOptions();
                                alert(`ÊàêÂäüÂØºÂÖ• ${importCount} Êù°ÂÆ¢Êà∑Êï∞ÊçÆÔºÅ`);
                            }
                        }
                    } catch (error) {
                        console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                        alert('ÂØºÂÖ•Â§±Ë¥•ÔºöÊï∞ÊçÆÊ†ºÂºèÈîôËØØÊàñÁΩëÁªúÈóÆÈ¢ò');
                    }
                };
                reader.readAsText(file);
            },

            // ================= ÂØºÂá∫WordÂäüËÉΩ =================
            async exportWord() {
                if (!this.currentCustomer) {
                    alert('ËØ∑ÂÖàÈÄâÊã©ÂÆ¢Êà∑');
                    return;
                }

                const customer = this.currentCustomer;
                const personalInfo = customer.personalInfo || {};

                // ËæÖÂä©ÂáΩÊï∞ÔºöÂ∞ÜÊç¢Ë°åÁ¨¶ËΩ¨Êç¢‰∏∫brÊ†áÁ≠æ
                const nl2br = (str) => {
                    if (!str) return '';
                    return String(str).replace(/\n/g, '<br>');
                };

                let content = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
                    <head><meta charset="utf-8"><title>ÂÆ¢Êà∑Êä•Âëä</title>
                    <style>
                        body { font-family: "Microsoft YaHei", Arial, sans-serif; font-size: 12pt; line-height: 1.6; }
                        h1 { font-size: 18pt; color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        h2 { font-size: 14pt; color: #555; margin-top: 20px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                        h3 { font-size: 12pt; color: #666; margin-top: 15px; }
                        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; }
                        .abnormal { color: #FF3B30; font-weight: bold; }
                        .section { margin-bottom: 20px; }
                    </style>
                    </head><body>
                    <h1>${personalInfo.name || 'Êú™ÂëΩÂêçÂÆ¢Êà∑'} - ÂÅ•Â∫∑ÁÆ°ÁêÜÊä•ÂëäüìÑ</h1>
                    <p>ÂØºÂá∫Êó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}</p>

                    <div class="section">
                        <h2>‰∏Ä„ÄÅ‰∏™‰∫∫‰ø°ÊÅØ</h2>
                        <table>
                            <tr><td width="20%">ÂßìÂêç</td><td>${personalInfo.name || ''}</td><td width="20%">ÊÄßÂà´</td><td>${personalInfo.gender || ''}</td></tr>
                            <tr><td>Âá∫ÁîüÊó•Êúü</td><td>${personalInfo.birthDate || ''}</td><td>Âπ¥ÈæÑ</td><td>${personalInfo.age || ''}</td></tr>
                            <tr><td>Ë∫´È´ò(cm)</td><td>${personalInfo.height || ''}</td><td>‰ΩìÈáç(kg)</td><td>${personalInfo.weight || ''}</td></tr>
                            <tr><td>BMI</td><td>${personalInfo.bmi || ''}</td><td>ËÖ∞Âõ¥(cm)</td><td>${personalInfo.waistCircumference || ''}</td></tr>
                            <tr><td>È°æÈóÆ</td><td>${personalInfo.customerService || ''}</td><td>ÈîÄÂîÆ</td><td>${personalInfo.sales || ''}</td></tr>
                            <tr><td>Âê∏ÁÉüÈ•ÆÈÖí</td><td colspan="3">${personalInfo.smokingDrinking || ''}</td></tr>
                        </table>
                `;

                // ËøáÊïèÂè≤
                if (customer.allergyHistory && customer.allergyHistory.length > 0) {
                    content += `<h3>ËøáÊïèÂè≤</h3><table><tr><th>ËøáÊïèÂéüÁ±ªÂà´</th><th>ÂÖ∑‰ΩìËøáÊïèÂéü</th><th>‰∏•ÈáçÁ®ãÂ∫¶</th><th>ÊèèËø∞</th></tr>`;
                    customer.allergyHistory.forEach(r => {
                        content += `<tr><td>${r.allergenType || ''}</td><td>${r.allergen || ''}</td><td>${r.severity || ''}</td><td>${nl2br(r.description)}</td></tr>`;
                    });
                    content += `</table>`;
                }

                // Áî®ËçØÂè≤
                if (customer.medicationHistory && customer.medicationHistory.length > 0) {
                    content += `<h3>Áî®ËçØÂè≤</h3><table><tr><th>ËçØÁâ©ÂêçÁß∞</th><th>Á±ªÂûã</th><th>Áî®ËçØÂéüÂõ†</th><th>ÂâÇÈáèÂèäÈ¢ëÁéá</th></tr>`;
                    customer.medicationHistory.forEach(r => {
                        content += `<tr><td>${r.medicationName || ''}</td><td>${r.medicationType || ''}</td><td>${nl2br(r.reason)}</td><td>${nl2br(r.dosageFrequency)}</td></tr>`;
                    });
                    content += `</table>`;
                }

                // Êó¢ÂæÄÁóÖÂè≤
                if (customer.pastMedicalHistory && customer.pastMedicalHistory.length > 0) {
                    content += `<h3>Êó¢ÂæÄÁóÖÂè≤</h3><table><tr><th>ÁñæÁóÖ/Áä∂ÂÜµ</th><th>Á±ªÂûã</th><th>ËØ¶ÊÉÖ</th></tr>`;
                    customer.pastMedicalHistory.forEach(r => {
                        content += `<tr><td>${r.conditionName || ''}</td><td>${r.recordType || ''}</td><td>${nl2br(r.currentStatus)}</td></tr>`;
                    });
                    content += `</table>`;
                }

                // ÊâãÊúØ‰∏é‰ΩèÈô¢Âè≤
                if (customer.surgeryHospitalizationHistory && customer.surgeryHospitalizationHistory.length > 0) {
                    content += `<h3>ÊâãÊúØ‰∏é‰ΩèÈô¢Âè≤</h3><table><tr><th>ÊâãÊúØ/‰ΩèÈô¢</th><th>Êó•Êúü</th><th>ËØ¶ÊÉÖ</th></tr>`;
                    customer.surgeryHospitalizationHistory.forEach(r => {
                        content += `<tr><td>${r.surgeryName || ''}</td><td>${r.date || ''}</td><td>${nl2br(r.details)}</td></tr>`;
                    });
                    content += `</table>`;
                }

                // ‰ΩìÊ£ÄÂ∞èÁªì
                if (customer.physicalExamSummary && customer.physicalExamSummary.length > 0) {
                    content += `<h3>‰ΩìÊ£ÄÂ∞èÁªì</h3><table><tr><th>ÂêçÁß∞</th><th>ËØ¶ÁªÜÂÜÖÂÆπ</th></tr>`;
                    customer.physicalExamSummary.forEach(r => {
                        content += `<tr><td>${r.name || ''}</td><td>${nl2br(r.detail)}</td></tr>`;
                    });
                    content += `</table>`;
                }

                // Áñ´ËãóÊé•ÁßçÂè≤
                if (customer.vaccinationHistory && customer.vaccinationHistory.length > 0) {
                    content += `<h3>Áñ´ËãóÊé•ÁßçÂè≤</h3><table><tr><th>Áñ´ËãóÂêçÁß∞</th><th>Êé•ÁßçÊó•Êúü</th><th>Â§áÊ≥®</th></tr>`;
                    customer.vaccinationHistory.forEach(r => {
                        content += `<tr><td>${r.vaccineName || ''}</td><td>${r.date || ''}</td><td>${nl2br(r.notes)}</td></tr>`;
                    });
                    content += `</table>`;
                }

                // ÂÆ∂ÊóèÁóÖÂè≤
                if (customer.familyHistory && customer.familyHistory.length > 0) {
                    content += `<h3>ÂÆ∂ÊóèÁóÖÂè≤</h3><table><tr><th>‰∫≤Â±ûÂÖ≥Á≥ª</th><th>ÁñæÁóÖ/Áä∂ÂÜµ</th><th>Â§áÊ≥®</th></tr>`;
                    customer.familyHistory.forEach(r => {
                        content += `<tr><td>${r.relationship || ''}</td><td>${r.condition || ''}</td><td>${nl2br(r.notes)}</td></tr>`;
                    });
                    content += `</table>`;
                }

                // ÂÖ∂‰ªñ‰ø°ÊÅØ
                if (personalInfo.customerPortrait) {
                    content += `<h3>ÂÆ¢Êà∑ÁîªÂÉè</h3><p>${nl2br(personalInfo.customerPortrait)}</p>`;
                }
                if (personalInfo.dietaryHabitsInfo) {
                    content += `<h3>ËÜ≥È£ü</h3><p>${nl2br(personalInfo.dietaryHabitsInfo)}</p>`;
                }
                if (personalInfo.activityExercise) {
                    content += `<h3>Ê¥ªÂä®‰∏éËøêÂä®</h3><p>${nl2br(personalInfo.activityExercise)}</p>`;
                }
                if (personalInfo.sleepStress) {
                    content += `<h3>Áù°Áú†‰∏éÂéãÂäõ</h3><p>${nl2br(personalInfo.sleepStress)}</p>`;
                }
                if (personalInfo.otherHealthHabits) {
                    content += `<h3>ÂÖ∂‰ªñÂÅ•Â∫∑‰π†ÊÉØ</h3><p>${nl2br(personalInfo.otherHealthHabits)}</p>`;
                }

                content += `</div>`;

                // Ë¥¶Êúü‰ø°ÊÅØ
                if (customer.periods && customer.periods.length > 0) {
                    content += `<div class="section"><h2>‰∫å„ÄÅË¥¶Êúü‰ø°ÊÅØ</h2>`;
                    customer.periods.forEach(period => {
                        content += `<h3>${period.periodName || ''}</h3>`;
                        content += `<p>‰∫§‰ªòÊó∂Èó¥Ôºö${period.deliveryDate || ''} | ‰∏ãÊ¨°‰∫§‰ªòÔºö${period.nextDeliveryDate || ''}</p>`;

                        if (period.supplementIntervention && period.supplementIntervention.length > 0) {
                            content += `<p><strong>Ë°•ÂâÇÂèäÂπ≤È¢ÑÊñπÂêëÔºö</strong></p><table><tr><th>Âπ≤È¢ÑÊñπÂêë</th><th>Ë°•ÂâÇÂÜÖÂÆπ</th><th>Â§áÊ≥®</th></tr>`;
                            period.supplementIntervention.forEach(s => {
                                content += `<tr><td>${s.direction || ''}</td><td>${nl2br(s.content)}</td><td>${nl2br(s.notes)}</td></tr>`;
                            });
                            content += `</table>`;
                        }

                        if (period.communicationRecords && period.communicationRecords.length > 0) {
                            content += `<p><strong>‰ºÅÂæÆÊ≤üÈÄöËÆ∞ÂΩïÔºö</strong></p><table><tr><th>Êó•Êúü</th><th>ÂÖ≥ÈîÆËØç</th><th>ÂÜÖÂÆπ</th></tr>`;
                            period.communicationRecords.forEach(c => {
                                content += `<tr><td>${c.date || ''}</td><td>${c.keyword || ''}</td><td>${nl2br(c.content)}</td></tr>`;
                            });
                            content += `</table>`;
                        }

                        if (period.followUpRecords && period.followUpRecords.length > 0) {
                            content += `<p><strong>ÂõûËÆøËÆ∞ÂΩïÔºö</strong></p><table><tr><th>Êó•Êúü</th><th>ÂÖ≥ÈîÆËØç</th><th>ÂÜÖÂÆπ</th></tr>`;
                            period.followUpRecords.forEach(f => {
                                content += `<tr><td>${f.date || ''}</td><td>${f.keyword || ''}</td><td>${nl2br(f.content)}</td></tr>`;
                            });
                            content += `</table>`;
                        }
                    });
                    content += `</div>`;
                }

                // Ê£ÄÊµãÊä•Âëä
                if (customer.reports && customer.reports.length > 0) {
                    content += `<div class="section"><h2>‰∏â„ÄÅÊ£ÄÊµãÊä•Âëä</h2>`;
                    customer.reports.forEach(report => {
                        const abnormalIndicators = (report.indicators || []).filter(i => i.status === 'abnormal');

                        content += `<h3>${report.name || 'Êú™ÂëΩÂêçÊä•Âëä'}</h3>`;
                        content += `<p>Ê£ÄÊµãÊó•ÊúüÔºö${report.date || ''} | Ê£ÄÊµãÊú∫ÊûÑÔºö${report.org || ''}</p>`;

                        if (abnormalIndicators.length > 0) {
                            content += `<p><strong>ÂºÇÂ∏∏ÊåáÊ†áÔºö</strong></p><table><tr><th>ÊåáÊ†áÂêç</th><th>Êï∞ÂÄº</th><th>Âçï‰Ωç</th><th>ÂèÇËÄÉËåÉÂõ¥</th></tr>`;
                            abnormalIndicators.forEach(ind => {
                                content += `<tr class="abnormal"><td>${ind.name || ''}</td><td>${ind.val || ''}</td><td>${ind.unit || ''}</td><td>${ind.ref || ''}</td></tr>`;
                            });
                            content += `</table>`;
                        } else {
                            content += `<p>Êó†ÂºÇÂ∏∏ÊåáÊ†á</p>`;
                        }
                    });
                    content += `</div>`;
                }

                content += `</body></html>`;

                const blob = new Blob([content], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${personalInfo.name || 'ÂÆ¢Êà∑'}_ÂÅ•Â∫∑Ê°£Ê°àüìÉÊä•Âëä_${new Date().toISOString().split('T')[0]}.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            // ================= ÂØºÂá∫Ê£ÄÊµãËÆ∞ÂΩïExcel =================
            async exportTestRecordsExcel() {
                if (!this.currentCustomer) {
                    alert('ËØ∑ÂÖàÈÄâÊã©ÂÆ¢Êà∑');
                    return;
                }

                // ‰ªéÊï∞ÊçÆÂ∫ìÈáçÊñ∞Âä†ËΩΩÊúÄÊñ∞Êï∞ÊçÆ
                const data = await CustomerModel.loadData();
                const customer = data.customers.find(c => c.id === this.currentCustomer.id);

                if (!customer) {
                    alert('ÂÆ¢Êà∑Êï∞ÊçÆ‰∏çÂ≠òÂú®');
                    return;
                }

                const reports = customer.reports || [];

                if (reports.length === 0) {
                    alert('ÂΩìÂâçÂÆ¢Êà∑Ê≤°ÊúâÊ£ÄÊµãÊä•Âëä');
                    return;
                }

                // ÊûÑÂª∫CSVÂÜÖÂÆπ
                let csvContent = '\uFEFF'; // BOM for UTF-8
                csvContent += 'Ê£ÄÊµãÊó•Êúü,Ê£ÄÊµãÊú∫ÊûÑ,Êä•ÂëäÂêç,ÊåáÊ†áÂêç,Êï∞ÂÄº,Âçï‰Ωç,ÂèÇËÄÉËåÉÂõ¥,ÊåáÊ†áÂàÜÁ±ª,Â≠êÂàÜÁ±ª,Áä∂ÊÄÅ\n';

                reports.forEach(report => {
                    const indicators = report.indicators || [];
                    indicators.forEach(ind => {
                        const status = ind.status === 'abnormal' ? 'ÂºÇÂ∏∏' : 'Ê≠£Â∏∏';
                        const category = this.categories[ind.cat] || '';
                        const subcategory = ind.subcat && this.subcategories[ind.cat] && this.subcategories[ind.cat][ind.subcat] 
                            ? this.subcategories[ind.cat][ind.subcat] 
                            : '';
                        csvContent += `"${report.date || ''}","${report.org || ''}","${report.name || ''}","${ind.name || ''}","${ind.val || ''}","${ind.unit || ''}","${ind.ref || ''}","${category}","${subcategory}","${status}"\n`;
                    });
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${customer.personalInfo?.name || 'ÂÆ¢Êà∑'}_Ê£ÄÊµãËÆ∞ÂΩï_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            async exportFullExcel() {
                if (!this.currentCustomer) {
                    alert('ËØ∑ÂÖàÈÄâÊã©ÂÆ¢Êà∑');
                    return;
                }

                // ‰ªéÊï∞ÊçÆÂ∫ìÈáçÊñ∞Âä†ËΩΩÊúÄÊñ∞Êï∞ÊçÆ
                const data = await CustomerModel.loadData();
                const customer = data.customers.find(c => c.id === this.currentCustomer.id);

                if (!customer) {
                    alert('ÂÆ¢Êà∑Êï∞ÊçÆ‰∏çÂ≠òÂú®');
                    return;
                }

                const personalInfo = customer.personalInfo || {};
                
                // ÊûÑÂª∫CSVÂÜÖÂÆπ - ÂÆåÊï¥ÂÆ¢Êà∑‰ø°ÊÅØ
                let csvContent = '\uFEFF'; // BOM for UTF-8
                
                // ‰∏™‰∫∫‰ø°ÊÅØÈÉ®ÂàÜ
                csvContent += '‰∏™‰∫∫‰ø°ÊÅØ\n';
                csvContent += 'ÂÆ¢Êà∑ÂßìÂêç,ÊÄßÂà´,Âπ¥ÈæÑ,Âá∫ÁîüÊó•Êúü,Ë∫´È´ò(cm),‰ΩìÈáç(kg),BMI,ËÖ∞Âõ¥(cm),È°æÈóÆ,ÈîÄÂîÆ,Âê∏ÁÉüÈ•ÆÈÖí,Â∏∏Â±ÖÂú∞,Â©öÂßªÁä∂ÂÜµ\n';
                csvContent += `"${personalInfo.name || ''}","${personalInfo.gender || ''}","${personalInfo.age || ''}","${personalInfo.birthDate || ''}","${personalInfo.height || ''}","${personalInfo.weight || ''}","${personalInfo.bmi || ''}","${personalInfo.waistCircumference || ''}","${personalInfo.customerService || ''}","${personalInfo.sales || ''}","${personalInfo.smokingDrinking || ''}","${personalInfo.residence || ''}","${personalInfo.maritalStatus || ''}"\n\n`;
                
                // ËøáÊïèÂè≤
                if (customer.allergyHistory && customer.allergyHistory.length > 0) {
                    csvContent += 'ËøáÊïèÂè≤\n';
                    csvContent += 'ËøáÊïèÂéüÁ±ªÂà´,ÂÖ∑‰ΩìËøáÊïèÂéü,‰∏•ÈáçÁ®ãÂ∫¶,ÊèèËø∞\n';
                    customer.allergyHistory.forEach(r => {
                        csvContent += `"${r.allergenType || ''}","${r.allergen || ''}","${r.severity || ''}","${r.description || ''}"\n`;
                    });
                    csvContent += '\n';
                }
                
                // Áî®ËçØÂè≤
                if (customer.medicationHistory && customer.medicationHistory.length > 0) {
                    csvContent += 'Áî®ËçØÂè≤\n';
                    csvContent += 'ËçØÁâ©ÂêçÁß∞,Á±ªÂûã,Áî®ËçØÂéüÂõ†,ÂâÇÈáèÂèäÈ¢ëÁéá\n';
                    customer.medicationHistory.forEach(r => {
                        csvContent += `"${r.medicationName || ''}","${r.medicationType || ''}","${r.reason || ''}","${r.dosageFrequency || ''}"\n`;
                    });
                    csvContent += '\n';
                }
                
                // Êó¢ÂæÄÁóÖÂè≤
                if (customer.pastMedicalHistory && customer.pastMedicalHistory.length > 0) {
                    csvContent += 'Êó¢ÂæÄÁóÖÂè≤\n';
                    csvContent += 'ÁñæÁóÖ/Áä∂ÂÜµ,Á±ªÂûã,ËØ¶ÊÉÖ\n';
                    customer.pastMedicalHistory.forEach(r => {
                        csvContent += `"${r.conditionName || ''}","${r.recordType || ''}","${r.currentStatus || ''}"\n`;
                    });
                    csvContent += '\n';
                }
                
                // ÊâãÊúØ‰∏é‰ΩèÈô¢Âè≤
                if (customer.surgeryHospitalizationHistory && customer.surgeryHospitalizationHistory.length > 0) {
                    csvContent += 'ÊâãÊúØ‰∏é‰ΩèÈô¢Âè≤\n';
                    csvContent += '‰∫ã‰ª∂ÂêçÁß∞,Á±ªÂûã,ÁªìÊûú/ÊÉÖÂÜµ\n';
                    customer.surgeryHospitalizationHistory.forEach(r => {
                        csvContent += `"${r.eventName || ''}","${r.eventType || ''}","${r.result || ''}"\n`;
                    });
                    csvContent += '\n';
                }
                
                // ‰ΩìÊ£ÄÂ∞èÁªì
                if (customer.physicalExamSummary && customer.physicalExamSummary.length > 0) {
                    csvContent += '‰ΩìÊ£ÄÂ∞èÁªì\n';
                    csvContent += 'ÂêçÁß∞,ËØ¶ÁªÜÂÜÖÂÆπ\n';
                    customer.physicalExamSummary.forEach(r => {
                        csvContent += `"${r.name || ''}","${r.detail || ''}"\n`;
                    });
                    csvContent += '\n';
                }
                
                // Áñ´ËãóÊé•ÁßçÂè≤
                if (customer.vaccinationHistory && customer.vaccinationHistory.length > 0) {
                    csvContent += 'Áñ´ËãóÊé•ÁßçÂè≤\n';
                    csvContent += 'Áñ´ËãóÂêçÁß∞,Â§áÊ≥®\n';
                    customer.vaccinationHistory.forEach(r => {
                        csvContent += `"${r.vaccineName || ''}","${r.notes || ''}"\n`;
                    });
                    csvContent += '\n';
                }
                
                // ÂÆ∂ÊóèÁóÖÂè≤
                if (customer.familyHistory && customer.familyHistory.length > 0) {
                    csvContent += 'ÂÆ∂ÊóèÁóÖÂè≤\n';
                    csvContent += '‰∫≤Â±ûÂÖ≥Á≥ª,ÁñæÁóÖ/Áä∂ÂÜµ,Â§áÊ≥®\n';
                    customer.familyHistory.forEach(r => {
                        csvContent += `"${r.relationship || ''}","${r.condition || ''}","${r.notes || ''}"\n`;
                    });
                    csvContent += '\n';
                }
                
                // Ê£ÄÊµãÊä•Âëä
                const reports = customer.reports || [];
                if (reports.length > 0) {
                    csvContent += 'Ê£ÄÊµãÊä•Âëä\n';
                    csvContent += 'Ê£ÄÊµãÊó•Êúü,Ê£ÄÊµãÊú∫ÊûÑ,Êä•ÂëäÂêç,ÊåáÊ†áÂêç,Êï∞ÂÄº,Âçï‰Ωç,ÂèÇËÄÉËåÉÂõ¥,ÊåáÊ†áÂàÜÁ±ª,Â≠êÂàÜÁ±ª,Áä∂ÊÄÅ\n';
                    reports.forEach(report => {
                        const indicators = report.indicators || [];
                        indicators.forEach(ind => {
                            const status = ind.status === 'abnormal' ? 'ÂºÇÂ∏∏' : 'Ê≠£Â∏∏';
                            const category = this.categories[ind.cat] || '';
                            const subcategory = ind.subcat && this.subcategories[ind.cat] && this.subcategories[ind.cat][ind.subcat] 
                                ? this.subcategories[ind.cat][ind.subcat] 
                                : '';
                            csvContent += `"${report.date || ''}","${report.org || ''}","${report.name || ''}","${ind.name || ''}","${ind.val || ''}","${ind.unit || ''}","${ind.ref || ''}","${category}","${subcategory}","${status}"\n`;
                        });
                    });
                    csvContent += '\n';
                }
                
                // Ë¥¶Êúü‰ø°ÊÅØ
                if (customer.periods && customer.periods.length > 0) {
                    customer.periods.forEach(period => {
                        csvContent += `Ë¥¶ÊúüÔºö${period.periodName || ''}\n`;
                        csvContent += `‰∫§‰ªòÊó∂Èó¥Ôºö${period.deliveryDate || ''} | ‰∏ãÊ¨°‰∫§‰ªòÔºö${period.nextDeliveryDate || ''}\n\n`;
                        
                        // Ë°•ÂâÇÂèäÂπ≤È¢ÑÊñπÂêë
                        if (period.supplementIntervention && period.supplementIntervention.length > 0) {
                            csvContent += 'Ë°•ÂâÇÂèäÂπ≤È¢ÑÊñπÂêë\n';
                            csvContent += 'Âπ≤È¢ÑÊñπÂêë,Ë°•ÂâÇÂÜÖÂÆπ,Â§áÊ≥®\n';
                            period.supplementIntervention.forEach(s => {
                                csvContent += `"${s.direction || ''}","${s.content || ''}","${s.notes || ''}"\n`;
                            });
                            csvContent += '\n';
                        }
                        
                        // ‰ºÅÂæÆÊ≤üÈÄöËÆ∞ÂΩï
                        if (period.communicationRecords && period.communicationRecords.length > 0) {
                            csvContent += '‰ºÅÂæÆÊ≤üÈÄöËÆ∞ÂΩï\n';
                            csvContent += 'Êó•Êúü,ÂÖ≥ÈîÆËØç,ÂÜÖÂÆπ\n';
                            period.communicationRecords.forEach(c => {
                                csvContent += `"${c.date || ''}","${c.keyword || ''}","${c.content || ''}"\n`;
                            });
                            csvContent += '\n';
                        }
                        
                        // ÂõûËÆøËÆ∞ÂΩï
                        if (period.followUpRecords && period.followUpRecords.length > 0) {
                            csvContent += 'ÂõûËÆøËÆ∞ÂΩï\n';
                            csvContent += 'Êó•Êúü,ÂÖ≥ÈîÆËØç,ÂÜÖÂÆπ\n';
                            period.followUpRecords.forEach(f => {
                                csvContent += `"${f.date || ''}","${f.keyword || ''}","${f.content || ''}"\n`;
                            });
                            csvContent += '\n';
                        }
                    });
                }

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${customer.personalInfo?.name || 'ÂÆ¢Êà∑'}_ÂÆåÊï¥‰ø°ÊÅØ_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        };

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            // Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
            if (Auth.checkAuth()) {
                ViewController.init();
            }
        });
    </script>

    <div id="editRecordModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="editModalTitle">ÁºñËæëËÆ∞ÂΩï</h3>
                <button class="close-modal" onclick="ViewController.closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="edit-modal-list" id="editModalList"></div>
            </div>
            <div class="modal-footer" id="editModalActions" style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 24px; border-top: 1px solid #E5E5EA; background: #FAFAFA;">
                <button class="btn-delete" onclick="ViewController.deleteSelectedRecords()" id="deleteSelectedBtn" style="display: none; padding: 12px 24px; background: #FF3B30; border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 500; cursor: pointer;">Âà†Èô§ÈÄâ‰∏≠</button>
                <button class="btn-save" onclick="ViewController.saveEditModal()" style="padding: 12px 24px; background: #007AFF; border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 500; cursor: pointer;">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <div id="addRecordModal" class="modal">
        <div class="modal-content" style="max-width: 500px; border-radius: 14px;">
            <div class="modal-header" style="border-bottom: 1px solid #E5E5EA; padding: 20px 24px; background: #FAFAFA; border-radius: 14px 14px 0 0;">
                <h3 id="addModalTitle" style="font-size: 18px; font-weight: 600; color: #1C1C1E;">Ê∑ªÂä†ËÆ∞ÂΩï</h3>
                <button class="close-modal" onclick="ViewController.closeAddModal()" style="font-size: 28px; color: #8E8E93; background: none; border: none; cursor: pointer; line-height: 1;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div id="addModalFormContainer"></div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 24px; border-top: 1px solid #E5E5EA; background: #FAFAFA;">
                <button class="btn-cancel" onclick="ViewController.closeAddModal()" style="padding: 12px 24px; background: #F2F2F7; border: none; border-radius: 8px; color: #1C1C1E; font-size: 15px; font-weight: 500; cursor: pointer;">ÂèñÊ∂à</button>
                <button class="btn-save" onclick="ViewController.confirmAddRecord()" style="padding: 12px 24px; background: #007AFF; border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 500; cursor: pointer;">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content" style="max-width: 320px; border-radius: 14px; text-align: center;">
            <div class="modal-body" style="padding: 24px 24px 16px;">
                <h3 id="confirmDeleteTitle" style="font-size: 17px; font-weight: 600; color: #1C1C1E; margin: 0 0 8px 0;"></h3>
                <p id="confirmDeleteMessage" style="font-size: 13px; color: #8E8E93; margin: 0;"></p>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #E5E5EA; display: flex; flex-direction: column; padding: 0;">
                <button id="confirmDeleteBtn" onclick="ViewController.executeDelete()" style="width: 100%; padding: 14px; border: none; background: none; color: #FF3B30; font-size: 17px; font-weight: 600; cursor: pointer; border-bottom: 1px solid #E5E5EA;">Âà†Èô§</button>
                <button onclick="ViewController.closeConfirmDeleteModal()" style="width: 100%; padding: 14px; border: none; background: none; color: #007AFF; font-size: 17px; cursor: pointer;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <div id="categoryEditModal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 900px;">
            <div class="modal-header">
                <h3 id="categoryEditTitle">ÁºñËæëÂàÜÁ±ª</h3>
                <button class="close-modal" onclick="ViewController.closeCategoryEditModal()">&times;</button>
            </div>
            <div class="modal-body">

                <div style="margin-bottom: 16px;">
                    <input type="text" id="categorySearchInput" placeholder="üîç ÊêúÁ¥¢ÊåáÊ†áÂêçÁß∞..."
                           style="width: 100%; padding: 10px; border: 1px solid #E5E5EA; border-radius: 8px; font-size: 14px;"
                           oninput="ViewController.filterCategoryIndicators()">
                </div>

                <div id="categoryIndicatorsList" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; gap: 12px;">
                <button class="btn-delete" id="categoryDeleteBtn" onclick="ViewController.deleteCategorySelectedIndicators()">Âà†Èô§ÈÄâ‰∏≠</button>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-cancel" onclick="ViewController.closeCategoryEditModal()">ÂèñÊ∂à</button>
                    <button class="btn-save" onclick="ViewController.saveCategoryEditModal()">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>